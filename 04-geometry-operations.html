<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.54">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="An introductory resource for working with geographic data in Python">

<title>4&nbsp; Geometry operations – Geocomputation with Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./05-raster-vector.html" rel="next">
<link href="./03-spatial-operations.html" rel="prev">
<link href="./favicon-32x32.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZEMGTY4VV3"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZEMGTY4VV3', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="helpers/mystyle.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./04-geometry-operations.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geometry operations</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Geocomputation with Python</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/geocompx/geocompy/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-spatial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Geographic data in Python</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-attribute-operations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Attribute data operations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-spatial-operations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial data operations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-geometry-operations.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geometry operations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-raster-vector.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Raster-vector interactions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-reproj.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Reprojecting geographic data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-read-write.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Geographic data I/O</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-mapping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Making maps with Python</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
  <h2 class="anchored">First Edition</h2>
  <ul>
    <li><a href="https://geocompx.org/" class="nav-link active" data-scroll-target="https\://geocompx.org/">Visit the geocompx website 🌐</a></li>
    <li><a href="https://github.com/geocompx/geocompy/issues" class="nav-link" data-scroll-target="https\://github.com/geocompx/geocompy/issues">Open an issue ❔</a></li>
    <li><a href="https://discord.gg/PMztXYgNxp" class="nav-link" data-scroll-target="https\://discord.gg/PMztXYgNxp">Chat on Discord 📣</a></li>
    <li><a href="https://donate.stripe.com/4gweWl94Q9E35AQ6oo" class="nav-link" data-scroll-target="https\://donate.stripe.com/4gweWl94Q9E35AQ6oo">Support this project 💸</a></li>
  </ul>
  <hr>
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">4.1</span> Introduction</a></li>
  <li><a href="#sec-geo-vec" id="toc-sec-geo-vec" class="nav-link" data-scroll-target="#sec-geo-vec"><span class="header-section-number">4.2</span> Geometric operations on vector data</a>
  <ul>
  <li><a href="#sec-simplification" id="toc-sec-simplification" class="nav-link" data-scroll-target="#sec-simplification"><span class="header-section-number">4.2.1</span> Simplification</a></li>
  <li><a href="#sec-centroids" id="toc-sec-centroids" class="nav-link" data-scroll-target="#sec-centroids"><span class="header-section-number">4.2.2</span> Centroids</a></li>
  <li><a href="#sec-buffers" id="toc-sec-buffers" class="nav-link" data-scroll-target="#sec-buffers"><span class="header-section-number">4.2.3</span> Buffers</a></li>
  <li><a href="#sec-affine-transformations" id="toc-sec-affine-transformations" class="nav-link" data-scroll-target="#sec-affine-transformations"><span class="header-section-number">4.2.4</span> Affine transformations</a></li>
  <li><a href="#sec-clipping" id="toc-sec-clipping" class="nav-link" data-scroll-target="#sec-clipping"><span class="header-section-number">4.2.5</span> Pairwise geometry-generating operations</a></li>
  <li><a href="#sec-subsetting-vs-clipping" id="toc-sec-subsetting-vs-clipping" class="nav-link" data-scroll-target="#sec-subsetting-vs-clipping"><span class="header-section-number">4.2.6</span> Subsetting vs.&nbsp;clipping</a></li>
  <li><a href="#sec-geometry-unions" id="toc-sec-geometry-unions" class="nav-link" data-scroll-target="#sec-geometry-unions"><span class="header-section-number">4.2.7</span> Geometry unions</a></li>
  <li><a href="#sec-type-transformations" id="toc-sec-type-transformations" class="nav-link" data-scroll-target="#sec-type-transformations"><span class="header-section-number">4.2.8</span> Type transformations</a></li>
  </ul></li>
  <li><a href="#sec-geo-ras" id="toc-sec-geo-ras" class="nav-link" data-scroll-target="#sec-geo-ras"><span class="header-section-number">4.3</span> Geometric operations on raster data</a>
  <ul>
  <li><a href="#sec-extent-and-origin" id="toc-sec-extent-and-origin" class="nav-link" data-scroll-target="#sec-extent-and-origin"><span class="header-section-number">4.3.1</span> Extent and origin</a></li>
  <li><a href="#sec-raster-agg-disagg" id="toc-sec-raster-agg-disagg" class="nav-link" data-scroll-target="#sec-raster-agg-disagg"><span class="header-section-number">4.3.2</span> Aggregation and disaggregation</a></li>
  <li><a href="#sec-raster-resampling" id="toc-sec-raster-resampling" class="nav-link" data-scroll-target="#sec-raster-resampling"><span class="header-section-number">4.3.3</span> Resampling</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/geocompx/geocompy/edit/main/04-geometry-operations.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-geometric-operations" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geometry operations</span></span></h1>
</div>

<!--
-->


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="prerequisites" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>This chapter requires importing the following packages:</p>
<div id="bfa1df98" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shapely</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> topojson <span class="im">as</span> tp</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio.plot</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio.warp</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio.mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It also relies on the following data files:</p>
<div id="544c4601" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>seine <span class="op">=</span> gpd.read_file(<span class="st">'data/seine.gpkg'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>us_states <span class="op">=</span> gpd.read_file(<span class="st">'data/us_states.gpkg'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>nz <span class="op">=</span> gpd.read_file(<span class="st">'data/nz.gpkg'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>src <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'data/dem.tif'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>src_elev <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'output/elev.tif'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="introduction" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">4.1</span> Introduction</h2>
<p>So far the book has explained the structure of geographic datasets (<a href="01-spatial-data.html" class="quarto-xref"><span>Chapter 1</span></a>), and how to manipulate them based on their non-geographic attributes (<a href="02-attribute-operations.html" class="quarto-xref"><span>Chapter 2</span></a>) and spatial relations (<a href="03-spatial-operations.html" class="quarto-xref"><span>Chapter 3</span></a>). This chapter focuses on manipulating the geographic elements of geographic objects, for example by simplifying and converting vector geometries, and by cropping raster datasets. After reading it you should understand and have control over the geometry column in vector layers and the extent and geographic location of pixels represented in rasters in relation to other geographic objects.</p>
<p><a href="#sec-geo-vec" class="quarto-xref"><span>Section 4.2</span></a> covers transforming vector geometries with ‘unary’ and ‘binary’ operations. Unary operations work on a single geometry in isolation, including simplification (of lines and polygons), the creation of buffers and centroids, and shifting/scaling/rotating single geometries using ‘affine transformations’ (<a href="#sec-simplification" class="quarto-xref"><span>Section 4.2.1</span></a> to <a href="#sec-affine-transformations" class="quarto-xref"><span>Section 4.2.4</span></a>). Binary transformations modify one geometry based on the shape of another, including clipping and geometry unions, covered in <a href="#sec-clipping" class="quarto-xref"><span>Section 4.2.5</span></a> and <a href="#sec-geometry-unions" class="quarto-xref"><span>Section 4.2.7</span></a>, respectively. Type transformations (from a polygon to a line, for example) are demonstrated in <a href="#sec-type-transformations" class="quarto-xref"><span>Section 4.2.8</span></a>.</p>
<p><a href="#sec-geo-ras" class="quarto-xref"><span>Section 4.3</span></a> covers geometric transformations on raster objects. This involves changing the size and number of the underlying pixels, and assigning them new values. It teaches how to change the extent and the origin of a raster manually (<a href="#sec-extent-and-origin" class="quarto-xref"><span>Section 4.3.1</span></a>), how to change the resolution in fixed steps through aggregation and disaggregation (<a href="#sec-raster-agg-disagg" class="quarto-xref"><span>Section 4.3.2</span></a>), and finally how to resample a raster into any existing template, which is the most general and often most practical approach (<a href="#sec-raster-resampling" class="quarto-xref"><span>Section 4.3.3</span></a>). These operations are especially useful if one would like to align raster datasets from diverse sources. Aligned raster objects share a one-to-one correspondence between pixels, allowing them to be processed using map algebra operations (<a href="03-spatial-operations.html#sec-raster-local-operations" class="quarto-xref"><span>Section 3.3.3</span></a>).</p>
<p>In the next chapter (<a href="05-raster-vector.html" class="quarto-xref"><span>Chapter 5</span></a>), we deal with the special case of geometry operations that involve both a raster and a vector layer together. It shows how raster values can be ‘masked’ and ‘extracted’ by vector geometries. Importantly it shows how to ‘polygonize’ rasters and ‘rasterize’ vector datasets, making the two data models more interchangeable.</p>
</section>
<section id="sec-geo-vec" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="sec-geo-vec"><span class="header-section-number">4.2</span> Geometric operations on vector data</h2>
<p>This section is about operations that in some way change the geometry of vector layers. It is more advanced than the spatial data operations presented in the previous chapter (in <a href="03-spatial-operations.html#sec-spatial-vec" class="quarto-xref"><span>Section 3.2</span></a>), because here we drill down into the geometry: the functions discussed in this section work on the geometric part (the geometry column, which is a <code>GeoSeries</code> object), either as standalone object or as part of a <code>GeoDataFrame</code>.</p>
<section id="sec-simplification" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="sec-simplification"><span class="header-section-number">4.2.1</span> Simplification</h3>
<p>Simplification is a process for generalization of vector objects (lines and polygons) usually for use in smaller-scale maps. Another reason for simplifying objects is to reduce the amount of memory, disk space, and network bandwidth they consume: it may be wise to simplify complex geometries before publishing them as interactive maps. The <strong>geopandas</strong> package provides the <code>.simplify</code> method, which uses the GEOS implementation of the Douglas-Peucker algorithm to reduce the vertex count. <code>.simplify</code> uses <code>tolerance</code> to control the level of generalization in map units <span class="citation" data-cites="douglas_algorithms_1973">(<a href="references.html#ref-douglas_algorithms_1973" role="doc-biblioref">Douglas and Peucker 1973</a>)</span>.</p>
<p>For example, a simplified geometry of a <code>'LineString'</code> geometry, representing the river Seine and tributaries, using tolerance of <code>2000</code> meters, can be created using the <code>seine.simplify(2000)</code> command (<a href="#fig-simplify-lines" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>).</p>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>seine_simp <span class="op">=</span> seine.simplify(<span class="dv">2000</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>seine.plot()<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>seine_simp.plot()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-simplify-lines" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simplify-lines-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simplify-lines" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-simplify-lines-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-simplify-lines-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-simplify-lines-output-1.png" data-ref-parent="fig-simplify-lines" width="430" height="342" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-simplify-lines-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Original
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simplify-lines" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-simplify-lines-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-simplify-lines-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-simplify-lines-output-2.png" data-ref-parent="fig-simplify-lines" width="430" height="341" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-simplify-lines-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Simplified (tolerance = 2000 <span class="math inline">\(m\)</span>)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simplify-lines-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.1: Simplification of the <code>seine</code> line layer
</figcaption>
</figure>
</div>
<p>The resulting <code>seine_simp</code> object is a copy of the original <code>seine</code> but with fewer vertices. This is apparent, with the result being visually simpler (<a href="#fig-simplify-lines" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>, right) and consuming about twice less memory than the original object, as shown in the comparison below.</p>
<div id="2f419a98" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Original: </span><span class="sc">{</span>sys<span class="sc">.</span>getsizeof(seine)<span class="sc">}</span><span class="ss"> bytes'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Simplified: </span><span class="sc">{</span>sys<span class="sc">.</span>getsizeof(seine_simp)<span class="sc">}</span><span class="ss"> bytes'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original: 374 bytes
Simplified: 188 bytes</code></pre>
</div>
</div>
<p>Simplification is also applicable for polygons. This is illustrated using <code>us_states</code>, representing the contiguous United States. As we show in <a href="06-reproj.html" class="quarto-xref"><span>Chapter 6</span></a>, for many calculations <strong>geopandas</strong> (through <strong>shapely</strong>, and, ultimately, GEOS) assumes that the data is in a projected CRS and this could lead to unexpected results when applying distance-related operators. Therefore, the first step is to project the data into some adequate projected CRS, such as US National Atlas Equal Area (EPSG:<code>9311</code>) (on the left in Figure <a href="#fig-simplify-polygons" class="quarto-xref">Figure&nbsp;<span>4.2</span></a>), using <code>.to_crs</code> (<a href="06-reproj.html#sec-reprojecting-vector-geometries" class="quarto-xref"><span>Section 6.7</span></a>).</p>
<div id="de463279" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>us_states9311 <span class="op">=</span> us_states.to_crs(<span class="dv">9311</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>.simplify</code> method from <strong>geopandas</strong> works the same way with a <code>'Polygon'</code>/<code>'MultiPolygon'</code> layer such as <code>us_states9311</code>:</p>
<div id="2b4a7ef4" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>us_states_simp1 <span class="op">=</span> us_states9311.simplify(<span class="dv">100000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A limitation with <code>.simplify</code>, however, is that it simplifies objects on a per-geometry basis. This means the topology is lost, resulting in overlapping and ‘holey’ areal units as illustrated in <a href="#fig-simplify-polygons" class="quarto-xref">Figure&nbsp;<span>4.2</span></a> (b). The <code>.toposimplify</code> method from package <strong>topojson</strong> provides an alternative that overcomes this issue. The main advanatage of <code>.toposimplify</code> is that it is topologically ‘aware’: it simplifies the combined borders of the polygons (rather than each polygon on its own), thus ensuring that the overlap is maintained. The following code chunk uses <code>.toposimplify</code> to simplify <code>us_states9311</code>. Note that, when using the <strong>topojson</strong> package, we first need to calculate a topology object, using function <code>tp.Topology</code>, and then apply the simplification function, such as <code>.toposimplify</code>, to obtain a simplified layer. We are also using the <code>.to_gdf</code> method to return a <code>GeoDataFrame</code>.</p>
<div id="d6c21f5d" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>topo <span class="op">=</span> tp.Topology(us_states9311, prequantize<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>us_states_simp2 <span class="op">=</span> topo.toposimplify(<span class="dv">100000</span>).to_gdf()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-simplify-polygons" class="quarto-xref">Figure&nbsp;<span>4.2</span></a> compares the original input polygons and two simplification methods applied to <code>us_states9311</code>.</p>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>us_states9311.plot(color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)<span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>us_states_simp1.plot(color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>us_states_simp2.plot(color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-simplify-polygons" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simplify-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simplify-polygons" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-simplify-polygons-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-simplify-polygons-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-simplify-polygons-output-1.png" data-ref-parent="fig-simplify-polygons" width="433" height="306" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-simplify-polygons-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Original
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simplify-polygons" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-simplify-polygons-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-simplify-polygons-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-simplify-polygons-output-2.png" data-ref-parent="fig-simplify-polygons" width="433" height="309" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-simplify-polygons-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Simplified using <strong>geopandas</strong>
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-simplify-polygons" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-simplify-polygons-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-simplify-polygons-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-simplify-polygons-output-3.png" data-ref-parent="fig-simplify-polygons" width="433" height="308" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-simplify-polygons-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) Simplified using <strong>topojson</strong>
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simplify-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.2: Polygon simplification in action, comparing the original geometry of the contiguous United States with simplified versions, generated with functions from the <strong>geopandas</strong> (middle), and <strong>topojson</strong> (right), packages.
</figcaption>
</figure>
</div>
</section>
<section id="sec-centroids" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="sec-centroids"><span class="header-section-number">4.2.2</span> Centroids</h3>
<p>Centroid operations identify the center of geographic objects. Like statistical measures of central tendency (including mean and median definitions of ‘average’), there are many ways to define the geographic center of an object. All of them create single-point representations of more complex vector objects.</p>
<p>The most commonly used centroid operation is the geographic centroid. This type of centroid operation (often referred to as ‘the centroid’) represents the center of mass in a spatial object (think of balancing a plate on your finger). Geographic centroids have many uses, for example to create a simple point representation of complex geometries, to estimate distances between polygons, or to specify the location where polygon text labels are placed. Centroids of the geometries in a <code>GeoSeries</code> or a <code>GeoDataFrame</code> are accessible through the <code>.centroid</code> property, as demonstrated in the code below, which generates the geographic centroids of regions in New Zealand and tributaries to the River Seine (black points in <a href="#fig-centroid-pnt-on-surface" class="quarto-xref">Figure&nbsp;<span>4.3</span></a>).</p>
<div id="87c3fd32" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nz_centroid <span class="op">=</span> nz.centroid</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>seine_centroid <span class="op">=</span> seine.centroid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Sometimes the geographic centroid falls outside the boundaries of their parent objects (think of vector data in shape of a doughnut). In such cases ‘point on surface’ operations, created with the <code>.representative_point</code> method, can be used to guarantee the point will be in the parent object (e.g., for labeling irregular multipolygon objects such as island states), as illustrated by the red points in <a href="#fig-centroid-pnt-on-surface" class="quarto-xref">Figure&nbsp;<span>4.3</span></a>. Notice that these red points always lie on their parent objects.</p>
<div id="b4a15bb3" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>nz_pos <span class="op">=</span> nz.representative_point()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>seine_pos <span class="op">=</span> seine.representative_point()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The centroids and points on surface are illustrated in <a href="#fig-centroid-pnt-on-surface" class="quarto-xref">Figure&nbsp;<span>4.3</span></a>.</p>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># New Zealand</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> nz.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>nz_centroid.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'None'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>nz_pos.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'None'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>)<span class="op">;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Seine</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> seine.plot(color<span class="op">=</span><span class="st">'grey'</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>seine_pos.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'None'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>seine_centroid.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'None'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-centroid-pnt-on-surface" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-centroid-pnt-on-surface-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-centroid-pnt-on-surface" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-centroid-pnt-on-surface-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-centroid-pnt-on-surface-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-centroid-pnt-on-surface-output-1.png" data-ref-parent="fig-centroid-pnt-on-surface" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-centroid-pnt-on-surface-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) New Zealand
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-centroid-pnt-on-surface" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-centroid-pnt-on-surface-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-centroid-pnt-on-surface-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-centroid-pnt-on-surface-output-2.png" data-ref-parent="fig-centroid-pnt-on-surface" width="430" height="342" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-centroid-pnt-on-surface-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Seine
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-centroid-pnt-on-surface-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.3: Centroids (black) and points on surface (red) of New Zealand and Seine datasets.
</figcaption>
</figure>
</div>
</section>
<section id="sec-buffers" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="sec-buffers"><span class="header-section-number">4.2.3</span> Buffers</h3>
<p>Buffers are polygons representing the area within a given distance of a geometric feature: regardless of whether the input is a point, line or polygon, the output is a polygon (when using positive buffer distance). Unlike simplification, which is often used for visualization and reducing file size, buffering tends to be used for geographic data analysis. How many points are within a given distance of this line? Which demographic groups are within travel distance of this new shop? These kinds of questions can be answered and visualized by creating buffers around the geographic entities of interest.</p>
<p><a href="#fig-buffers" class="quarto-xref">Figure&nbsp;<span>4.4</span></a> illustrates buffers of two different sizes (5 and 50 <span class="math inline">\(km\)</span>) surrounding the river Seine and tributaries. These buffers were created with commands below, using the <code>.buffer</code> method, applied to a <code>GeoSeries</code> or <code>GeoDataFrame</code>. The <code>.buffer</code> method requires one important argument: the buffer distance, provided in the units of the CRS, in this case, meters.</p>
<div id="a69ae959" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>seine_buff_5km <span class="op">=</span> seine.<span class="bu">buffer</span>(<span class="dv">5000</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>seine_buff_50km <span class="op">=</span> seine.<span class="bu">buffer</span>(<span class="dv">50000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results are shown in <a href="#fig-buffers" class="quarto-xref">Figure&nbsp;<span>4.4</span></a>.</p>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>seine_buff_5km.plot(color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span>[<span class="st">'c'</span>, <span class="st">'m'</span>, <span class="st">'y'</span>])<span class="op">;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>seine_buff_50km.plot(color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span>[<span class="st">'c'</span>, <span class="st">'m'</span>, <span class="st">'y'</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-buffers" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-buffers-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-buffers" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-buffers-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-buffers-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-buffers-output-1.png" data-ref-parent="fig-buffers" width="452" height="344" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-buffers-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 5 <span class="math inline">\(km\)</span> buffer
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-buffers" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-buffers-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-buffers-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-buffers-output-2.png" data-ref-parent="fig-buffers" width="430" height="360" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-buffers-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 50 <span class="math inline">\(km\)</span> buffer
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-buffers-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.4: Buffers around the Seine dataset of 5 <span class="math inline">\(km\)</span> and 50 <span class="math inline">\(km\)</span>. Note the colors, which reflect the fact that one buffer is created per geometry feature.
</figcaption>
</figure>
</div>
<p>Note that both <code>.centroid</code> and <code>.buffer</code> return a <code>GeoSeries</code> object, even when the input is a <code>GeoDataFrame</code>.</p>
<div id="684d5329" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>seine_buff_5km</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>0    POLYGON ((657550.332 6852587.97...
1    POLYGON ((517151.801 6930724.10...
2    POLYGON ((701519.74 6813075.492...
dtype: geometry</code></pre>
</div>
</div>
<p>In the common scenario when the original attributes of the input features need to be retained, you can replace the existing geometry with the new <code>GeoSeries</code> by creating a copy of the original <code>GeoDataFrame</code> and assigning the new buffer <code>GeoSeries</code> to the <code>geometry</code> column.</p>
<div id="da7a1326" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>seine_buff_5km <span class="op">=</span> seine.copy()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>seine_buff_5km.geometry <span class="op">=</span> seine.<span class="bu">buffer</span>(<span class="dv">5000</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>seine_buff_5km</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Marne</td>
<td>POLYGON ((657550.332 6852587.97...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Seine</td>
<td>POLYGON ((517151.801 6930724.10...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Yonne</td>
<td>POLYGON ((701519.74 6813075.492...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>An alternative option is to add a secondary geometry column directly to the original <code>GeoDataFrame</code>.</p>
<div id="a374d6f4" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>seine[<span class="st">'geometry_5km'</span>] <span class="op">=</span> seine.<span class="bu">buffer</span>(<span class="dv">5000</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>seine</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">geometry_5km</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Marne</td>
<td>MULTILINESTRING ((879955.277 67...</td>
<td>POLYGON ((657550.332 6852587.97...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Seine</td>
<td>MULTILINESTRING ((828893.615 67...</td>
<td>POLYGON ((517151.801 6930724.10...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Yonne</td>
<td>MULTILINESTRING ((773482.137 66...</td>
<td>POLYGON ((701519.74 6813075.492...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>You can then switch to either geometry column (i.e., make it ‘active’) using <code>.set_geometry</code>, as in:</p>
<div id="515b9d04" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>seine <span class="op">=</span> seine.set_geometry(<span class="st">'geometry_5km'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s revert to the original state of <code>seine</code> before moving on to the next section.</p>
<div id="41b502b7" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>seine <span class="op">=</span> seine.set_geometry(<span class="st">'geometry'</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>seine <span class="op">=</span> seine.drop(<span class="st">'geometry_5km'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-affine-transformations" class="level3" data-number="4.2.4">
<h3 data-number="4.2.4" class="anchored" data-anchor-id="sec-affine-transformations"><span class="header-section-number">4.2.4</span> Affine transformations</h3>
<p>Affine transformations include, among others, shifting (translation), scaling and rotation, or any combination of these. They preserves lines and parallelism, but angles and lengths are not necessarily preserved. These transformations are an essential part of geocomputation. For example, shifting is needed for labels placement, scaling is used in non-contiguous area cartograms, and many affine transformations are applied when reprojecting or improving the geometry that was created based on a distorted or wrongly projected map.</p>
<p>The <strong>geopandas</strong> package implements affine transformation, for objects of classes <code>GeoSeries</code> and <code>GeoDataFrame</code>. In both cases, the method is applied on the <code>GeoSeries</code> part, returning just the <code>GeoSeries</code> of transformed geometries.</p>
<p>Affine transformations of <code>GeoSeries</code> can be done using the <code>.affine_transform</code> method, which is a wrapper around the <code>shapely.affinity.affine_transform</code> function. A two-dimensional affine transformation requires a six-parameter list <code>[a,b,d,e,xoff,yoff]</code> which represents <a href="#eq-affine1" class="quarto-xref">Equation&nbsp;<span>4.1</span></a> and <a href="#eq-affine2" class="quarto-xref">Equation&nbsp;<span>4.2</span></a> for transforming the coordinates.</p>
<p><span id="eq-affine1"><span class="math display">\[
x' = a x + b y + x_\mathrm{off}
\tag{4.1}\]</span></span></p>
<p><span id="eq-affine2"><span class="math display">\[
y' = d x + e y + y_\mathrm{off}
\tag{4.2}\]</span></span></p>
<p>There are also simplified <code>GeoSeries</code> methods for specific scenarios, such as:</p>
<ul>
<li><code>.translate(xoff=0.0, yoff=0.0)</code></li>
<li><code>.scale(xfact=1.0, yfact=1.0, origin='center')</code></li>
<li><code>.rotate(angle, origin='center', use_radians=False)</code></li>
</ul>
<p>For example, <em>shifting</em> only requires the <span class="math inline">\(x_{off}\)</span> and <span class="math inline">\(y_{off}\)</span>, using <code>.translate</code>. The code below shifts the y-coordinates of <code>nz</code> by 100 <span class="math inline">\(km\)</span> to the north, but leaves the x-coordinates untouched.</p>
<div id="c12a569b" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>nz_shift <span class="op">=</span> nz.translate(<span class="dv">0</span>, <span class="dv">100000</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>nz_shift</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>0     MULTIPOLYGON (((1745493.196 610...
1     MULTIPOLYGON (((1803822.103 600...
2     MULTIPOLYGON (((1860345.005 595...
                     ...                
13    MULTIPOLYGON (((1616642.877 552...
14    MULTIPOLYGON (((1624866.278 551...
15    MULTIPOLYGON (((1686901.914 545...
Length: 16, dtype: geometry</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>shapely</strong>, and consequently <strong>geopandas</strong>, operations, typically ignore the z-dimension (if there is one) of geometries in operations. For example, <code>shapely.LineString([(0,0,0),(0,0,1)]).length</code> returns <code>0</code> (and not <code>1</code>), since <code>.length</code> ignores the z-dimension. This is not an issue in this book (and in most real-world spatial analysis applications), since we are dealing only with two-dimensional geometries.</p>
</div>
</div>
<p>Scaling enlarges or shrinks objects by a factor, and can be applied either globally or locally. Global scaling increases or decreases all coordinates values in relation to the origin coordinates, while keeping all geometries topological relations intact. <strong>geopandas</strong> implements scaling using the <code>.scale</code> method. Local scaling treats geometries independently and requires points around which geometries are going to be scaled, e.g., centroids. In the example below, each geometry is shrunk by a factor of two around the centroids (<a href="#fig-affine-transformations" class="quarto-xref">Figure&nbsp;<span>4.5</span></a> (b)). To achieve that, we pass the <code>0.5</code> and <code>0.5</code> scaling factors (for x and y, respectively), and the <code>'centroid'</code> option for the point of origin.</p>
<div id="465b2f6c" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>nz_scale <span class="op">=</span> nz.scale(<span class="fl">0.5</span>, <span class="fl">0.5</span>, origin<span class="op">=</span><span class="st">'centroid'</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>nz_scale</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>0     MULTIPOLYGON (((1710099.077 603...
1     MULTIPOLYGON (((1778686.524 591...
2     MULTIPOLYGON (((1839927.904 582...
                     ...                
13    MULTIPOLYGON (((1593619.59 5418...
14    MULTIPOLYGON (((1628907.395 542...
15    MULTIPOLYGON (((1665262.436 536...
Length: 16, dtype: geometry</code></pre>
</div>
</div>
<p>When setting the <code>origin</code> in <code>.scale</code>, other than <code>'centroid'</code> it is possible to use <code>'center'</code>, for the bounding box center, or specific point coordinates, such as <code>(0,0)</code>.</p>
<p>Rotating the geometries can be done using the <code>.rotate</code> method. When rotating, we need to specify the rotation angle (positive values imply clockwise rotation) and the <code>origin</code> points (using the same options as in <code>.scale</code>). For example, the following expression rotates <code>nz</code> by <span class="math inline">\(30\degree\)</span> counter-clockwise, around the geometry centroids.</p>
<div id="529ab581" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>nz_rotate <span class="op">=</span> nz.rotate(<span class="op">-</span><span class="dv">30</span>, origin<span class="op">=</span><span class="st">'centroid'</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>nz_rotate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>0     MULTIPOLYGON (((1701904.887 597...
1     MULTIPOLYGON (((1779714.772 587...
2     MULTIPOLYGON (((1890843.462 582...
                     ...                
13    MULTIPOLYGON (((1616991.636 539...
14    MULTIPOLYGON (((1617733.547 542...
15    MULTIPOLYGON (((1665898.669 533...
Length: 16, dtype: geometry</code></pre>
</div>
</div>
<p><a href="#fig-affine-transformations" class="quarto-xref">Figure&nbsp;<span>4.5</span></a> shows the original layer <code>nz</code>, and the shifting, scaling, and rotation results.</p>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shift</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> nz.plot(color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>nz_shift.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'red'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)<span class="op">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> nz.plot(color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>nz_scale.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'red'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)<span class="op">;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Rotate</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> nz.plot(color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>nz_rotate.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'red'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-affine-transformations" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-affine-transformations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-affine-transformations" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-affine-transformations-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-affine-transformations-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-affine-transformations-output-1.png" data-ref-parent="fig-affine-transformations" width="289" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-affine-transformations-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Shift
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-affine-transformations" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-affine-transformations-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-affine-transformations-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-affine-transformations-output-2.png" data-ref-parent="fig-affine-transformations" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-affine-transformations-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Scale
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-affine-transformations" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-affine-transformations-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-affine-transformations-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-affine-transformations-output-3.png" data-ref-parent="fig-affine-transformations" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-affine-transformations-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) Rotate
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-affine-transformations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.5: Affine transformations of the <code>nz</code> layer: shift, scale, and rotate
</figcaption>
</figure>
</div>
</section>
<section id="sec-clipping" class="level3" data-number="4.2.5">
<h3 data-number="4.2.5" class="anchored" data-anchor-id="sec-clipping"><span class="header-section-number">4.2.5</span> Pairwise geometry-generating operations</h3>
<p>Spatial clipping is a form of spatial subsetting that involves changes to the geometry columns of at least some of the affected features. Clipping can only apply to features more complex than points: lines, polygons, and their ‘multi’ equivalents. To illustrate the concept we will start with a simple example: two overlapping circles with a center point one unit away from each other and a radius of one (<a href="#fig-overlapping-circles" class="quarto-xref">Figure&nbsp;<span>4.6</span></a>).</p>
<div id="cell-fig-overlapping-circles" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> shapely.Point((<span class="dv">0</span>, <span class="dv">0</span>)).<span class="bu">buffer</span>(<span class="dv">1</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> shapely.Point((<span class="dv">1</span>, <span class="dv">0</span>)).<span class="bu">buffer</span>(<span class="dv">1</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>shapely.GeometryCollection([x, y])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div id="fig-overlapping-circles" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-overlapping-circles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-overlapping-circles-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-overlapping-circles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.6: Overlapping polygon (circle) geometries <code>x</code> and <code>y</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Imagine you want to select not one circle or the other, but the space covered by both <code>x</code> and <code>y</code>. This can be done using the <code>.intersection</code> method from <strong>shapely</strong>, illustrated using objects named <code>x</code> and <code>y</code> which represent the left- and right-hand circles (<a href="#fig-intersection" class="quarto-xref">Figure&nbsp;<span>4.7</span></a>).</p>
<div id="cell-fig-intersection" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>x.intersection(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div id="fig-intersection" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-intersection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-intersection-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-intersection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.7: Intersection between <code>x</code> and <code>y</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>More generally, clipping is an example of a ‘pairwise geometry-generating operation’, where new geometries are generated from two inputs. Other than <code>.intersection</code> (<a href="#fig-intersection" class="quarto-xref">Figure&nbsp;<span>4.7</span></a>), there are three other standard pairwise operators: <code>.difference</code> (<a href="#fig-difference" class="quarto-xref">Figure&nbsp;<span>4.8</span></a>), <code>.union</code> (<a href="#fig-union" class="quarto-xref">Figure&nbsp;<span>4.9</span></a>), and <code>.symmetric_difference</code> (<a href="#fig-symmetric-difference" class="quarto-xref">Figure&nbsp;<span>4.10</span></a>).</p>
<div id="cell-fig-difference" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>x.difference(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div id="fig-difference" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-difference-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-difference-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-difference-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.8: Difference between <code>x</code> and <code>y</code> (namely, <code>x</code> ‘minus’ <code>y</code>)
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-union" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>x.union(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div id="fig-union" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-union-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-union-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-union-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.9: Union of <code>x</code> and <code>y</code>
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-symmetric-difference" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>x.symmetric_difference(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div id="fig-symmetric-difference" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-symmetric-difference-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-symmetric-difference-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-symmetric-difference-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.10: Symmetric difference between <code>x</code> and <code>y</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Keep in mind that <code>x</code> and <code>y</code> are interchangeable in all predicates except for <code>.difference</code>, where <code>x.difference(y)</code> means <code>x</code> minus <code>y</code>, whereas <code>y.difference(x)</code> means <code>y</code> minus <code>x</code>.</p>
<p>The latter examples demonstrate pairwise operations between individual <code>shapely</code> geometries. The <strong>geopandas</strong> package, as is often the case, contains wrappers of these <strong>shapely</strong> functions to be applied to multiple, or pairwise, use cases. For example, applying either of the pairwise methods on a <code>GeoSeries</code> or <code>GeoDataFrame</code>, combined with a <code>shapely</code> geometry, returns the pairwise (many-to-one) results (which is analogous to other operators, like <code>.intersects</code> or <code>.distance</code>, see <a href="03-spatial-operations.html#sec-spatial-subsetting-vector" class="quarto-xref"><span>Section 3.2.1</span></a> and <a href="03-spatial-operations.html#sec-distance-relations" class="quarto-xref"><span>Section 3.2.7</span></a>, respectively).</p>
<p>Let’s demonstrate the ‘many-to-one’ scenario by calculating the difference between each geometry in a <code>GeoSeries</code> and a fixed <code>shapely</code> geometry. To create the latter, let’s take <code>x</code> and combine it with itself translated (<a href="#sec-affine-transformations" class="quarto-xref"><span>Section 4.2.4</span></a>) to a distance of <code>1</code> and <code>2</code> units ‘upwards’ on the y-axis.</p>
<div id="91498e61" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>geom1 <span class="op">=</span> gpd.GeoSeries(x)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>geom2 <span class="op">=</span> geom1.translate(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>geom3 <span class="op">=</span> geom1.translate(<span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>geom <span class="op">=</span> pd.concat([geom1, geom2, geom3])</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>geom</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>0    POLYGON ((1 0, 0.99518 -0.09802...
0    POLYGON ((1 1, 0.99518 0.90198,...
0    POLYGON ((1 2, 0.99518 1.90198,...
dtype: geometry</code></pre>
</div>
</div>
<p><a href="#fig-geom-intersection" class="quarto-xref">Figure&nbsp;<span>4.11</span></a> shows the <code>GeoSeries</code> <code>geom</code> with the <code>shapely</code> geometry (in red) that we will intersect with it.</p>
<div id="cell-fig-geom-intersection" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>geom.plot(color<span class="op">=</span><span class="st">'#00000030'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>gpd.GeoSeries(y).plot(color<span class="op">=</span><span class="st">'#FF000040'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, ax<span class="op">=</span>ax)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-geom-intersection" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-geom-intersection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-geom-intersection-output-1.png" width="338" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-geom-intersection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.11: A <code>GeoSeries</code> with three circles (in grey), and a <code>shapely</code> geometry that we will subtract from it (in red)
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now, using <code>.intersection</code> automatically applies the <strong>shapely</strong> method of the same name on each geometry in <code>geom</code>, returning a new <code>GeoSeries</code>, which we name <code>geom_inter_y</code>, with the pairwise intersections. Note the empty third geometry (can you explain the meaning of this result?).</p>
<div id="8cd09758" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>geom_inter_y <span class="op">=</span> geom.intersection(y)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>geom_inter_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>0    POLYGON ((0.99518 -0.09802, 0.9...
0    POLYGON ((0.99518 0.90198, 0.98...
0                         POLYGON EMPTY
dtype: geometry</code></pre>
</div>
</div>
<p><a href="#fig-geom-intersection2" class="quarto-xref">Figure&nbsp;<span>4.12</span></a> is a plot of the result <code>geom_inter_y</code>.</p>
<div id="cell-fig-geom-intersection2" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>geom_inter_y.plot(color<span class="op">=</span><span class="st">'#00000030'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-geom-intersection2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-geom-intersection2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-geom-intersection2-output-1.png" width="269" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-geom-intersection2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.12: The output <code>GeoSeries</code>, after subtracting a <code>shapely</code> geometry using <code>.intersection</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>The <code>.overlay</code> method (see <a href="03-spatial-operations.html#sec-joining-incongruent-layers" class="quarto-xref"><span>Section 3.2.6</span></a>) further extends this technique, making it possible to apply ‘many-to-many’ pairwise geometry generations between all pairs of two <code>GeoDataFrame</code>s. The output is a new <code>GeoDataFrame</code> with the pairwise outputs, plus the attributes of both inputs which were the inputs of the particular pairwise output geometry. Also see the <em>Set operations with overlay</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> article in the <strong>geopandas</strong> documentation for examples of <code>.overlay</code>.</p>
</section>
<section id="sec-subsetting-vs-clipping" class="level3" data-number="4.2.6">
<h3 data-number="4.2.6" class="anchored" data-anchor-id="sec-subsetting-vs-clipping"><span class="header-section-number">4.2.6</span> Subsetting vs.&nbsp;clipping</h3>
<p>In the last two chapters we have introduced two types of spatial operators: boolean, such as <code>.intersects</code> (<a href="03-spatial-operations.html#sec-spatial-subsetting-vector" class="quarto-xref"><span>Section 3.2.1</span></a>), and geometry-generating, such as <code>.intersection</code> (<a href="#sec-clipping" class="quarto-xref"><span>Section 4.2.5</span></a>). Here, we illustrate the difference between them. We do this using the specific scenario of subsetting points by polygons, where (unlike in other cases) both methods can be used for the same purpose and giving the same result.</p>
<p>To illustrate the point, we will subset points that cover the bounding box of the circles <code>x</code> and <code>y</code> from <a href="#fig-overlapping-circles" class="quarto-xref">Figure&nbsp;<span>4.6</span></a>. Some points will be inside just one circle, some will be inside both, and some will be inside neither. The following code sections generate the sample data for this section, a simple random distribution of points within the extent of circles <code>x</code> and <code>y</code>, resulting in output illustrated in <a href="#fig-random-points" class="quarto-xref">Figure&nbsp;<span>4.13</span></a>. We create the sample points in two steps. First, we figure out the bounds where random points are to be generated.</p>
<div id="a93dcd4d" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>bounds <span class="op">=</span> x.union(y).bounds</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>bounds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>(-1.0, -1.0, 2.0, 1.0)</code></pre>
</div>
</div>
<p>Second, we use <code>np.random.uniform</code> to calculate <code>n</code> random x- and y-coordinates within the given bounds.</p>
<div id="93085041" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>coords_x <span class="op">=</span> np.random.uniform(bounds[<span class="dv">0</span>], bounds[<span class="dv">2</span>], n)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>coords_y <span class="op">=</span> np.random.uniform(bounds[<span class="dv">1</span>], bounds[<span class="dv">3</span>], n)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>coords <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(coords_x, coords_y))</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>coords</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>[(np.float64(0.2510660141077219), np.float64(-0.1616109711934104)),
 (np.float64(1.1609734803264744), np.float64(0.370439000793519)),
 (np.float64(-0.9996568755479653), np.float64(-0.5910955005369651)),
 (np.float64(-0.0930022821044807), np.float64(0.7562348727818908)),
 (np.float64(-0.5597323275486609), np.float64(-0.9452248136041477)),
 (np.float64(-0.7229842156936066), np.float64(0.34093502035680445)),
 (np.float64(-0.4412193658669873), np.float64(-0.16539039526574606)),
 (np.float64(0.03668218112914312), np.float64(0.11737965689150331)),
 (np.float64(0.1903024226920098), np.float64(-0.7192261228095325)),
 (np.float64(0.6164502020100708), np.float64(-0.6037970218302424))]</code></pre>
</div>
</div>
<p>Third, we transform the list of coordinates into a <code>list</code> of <code>shapely</code> points, and then to a <code>GeoSeries</code>.</p>
<div id="03ae72bd" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>pnt <span class="op">=</span> [shapely.Point(i) <span class="cf">for</span> i <span class="kw">in</span> coords]</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>pnt <span class="op">=</span> gpd.GeoSeries(pnt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result <code>pnt</code>, with <code>x</code> and <code>y</code> circles in the background, is shown in <a href="#fig-random-points" class="quarto-xref">Figure&nbsp;<span>4.13</span></a>.</p>
<div id="cell-fig-random-points" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> pnt.plot(color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>gpd.GeoSeries(x).plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)<span class="op">;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>gpd.GeoSeries(y).plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-random-points" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-random-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-random-points-output-1.png" width="441" height="290" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-random-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.13: Randomly distributed points within the bounding box enclosing circles <code>x</code> and <code>y</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now, we can get back to our question: how to subset the points to only return the points that intersect with both <code>x</code> and <code>y</code>? The code chunks below demonstrate two ways to achieve the same result. In the first approach, we can calculate a boolean <code>Series</code>, evaluating whether each point of <code>pnt</code> intersects with the intersection of <code>x</code> and <code>y</code> (see <a href="03-spatial-operations.html#sec-spatial-subsetting-vector" class="quarto-xref"><span>Section 3.2.1</span></a>), and then use it to subset <code>pnt</code> to get the result <code>pnt1</code>.</p>
<div id="7618dd44" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>sel <span class="op">=</span> pnt.intersects(x.intersection(y))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>pnt1 <span class="op">=</span> pnt[sel]</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>pnt1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>0    POINT (0.25107 -0.16161)
7     POINT (0.03668 0.11738)
9     POINT (0.61645 -0.6038)
dtype: geometry</code></pre>
</div>
</div>
<p>In the second approach, we can also find the intersection between the input points represented by <code>pnt</code>, using the intersection of <code>x</code> and <code>y</code> as the subsetting/clipping object. Since the second argument is an individual <code>shapely</code> geometry (<code>x.intersection(y)</code>), we get ‘pairwise’ intersections of each <code>pnt</code> with it (see <a href="#sec-clipping" class="quarto-xref"><span>Section 4.2.5</span></a>):</p>
<div id="5a47fce8" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>pnt2 <span class="op">=</span> pnt.intersection(x.intersection(y))</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>pnt2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>0    POINT (0.25107 -0.16161)
1                 POINT EMPTY
2                 POINT EMPTY
               ...           
7     POINT (0.03668 0.11738)
8                 POINT EMPTY
9     POINT (0.61645 -0.6038)
Length: 10, dtype: geometry</code></pre>
</div>
</div>
<p>The subset <code>pnt2</code> is shown in <a href="#fig-intersection-points" class="quarto-xref">Figure&nbsp;<span>4.14</span></a>.</p>
<div id="cell-fig-intersection-points" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> pnt.plot(color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>gpd.GeoSeries(x).plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)<span class="op">;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>gpd.GeoSeries(y).plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)<span class="op">;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>pnt2.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'red'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-intersection-points" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-intersection-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-intersection-points-output-1.png" width="441" height="290" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-intersection-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.14: Randomly distributed points within the bounding box enclosing circles <code>x</code> and <code>y</code>. The points that intersect with both objects <code>x</code> and <code>y</code> are highlighted.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The only difference between the two approaches is that <code>.intersection</code> returns all intersections, even if they are empty. When these are filtered out, <code>pnt2</code> becomes identical to <code>pnt1</code>:</p>
<div id="f8c640f1" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>pnt2 <span class="op">=</span> pnt2[<span class="op">~</span>pnt2.is_empty]</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>pnt2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>0    POINT (0.25107 -0.16161)
7     POINT (0.03668 0.11738)
9     POINT (0.61645 -0.6038)
dtype: geometry</code></pre>
</div>
</div>
<p>The example above is rather contrived and provided for educational rather than applied purposes. However, we encourage the reader to reproduce the results to deepen your understanding of handling geographic vector objects in Python.</p>
</section>
<section id="sec-geometry-unions" class="level3" data-number="4.2.7">
<h3 data-number="4.2.7" class="anchored" data-anchor-id="sec-geometry-unions"><span class="header-section-number">4.2.7</span> Geometry unions</h3>
<p>Spatial aggregation can silently dissolve the geometries of touching polygons in the same group, as we saw in <a href="02-attribute-operations.html#sec-vector-attribute-aggregation" class="quarto-xref"><span>Section 2.2.2</span></a>. This is demonstrated in the code chunk below, in which 49 <code>us_states</code> are aggregated into 4 regions using the <code>.dissolve</code> method.</p>
<div id="09f7acc9" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>regions <span class="op">=</span> us_states[[<span class="st">'REGION'</span>, <span class="st">'geometry'</span>, <span class="st">'total_pop_15'</span>]] <span class="op">\</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    .dissolve(by<span class="op">=</span><span class="st">'REGION'</span>, aggfunc<span class="op">=</span><span class="st">'sum'</span>).reset_index()</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>regions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">REGION</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">total_pop_15</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Midwest</td>
<td>MULTIPOLYGON (((-89.10077 36.94...</td>
<td>67546398.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Norteast</td>
<td>MULTIPOLYGON (((-75.61724 39.83...</td>
<td>55989520.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>South</td>
<td>MULTIPOLYGON (((-81.3855 30.273...</td>
<td>118575377.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>West</td>
<td>MULTIPOLYGON (((-118.36998 32.8...</td>
<td>72264052.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><a href="#fig-dissolve" class="quarto-xref">Figure&nbsp;<span>4.15</span></a> compares the original <code>us_states</code> layer with the aggregated <code>regions</code> layer.</p>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># States</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="fl">2.5</span>))</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>us_states.plot(ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">'black'</span>, column<span class="op">=</span><span class="st">'total_pop_15'</span>, legend<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Regions</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="fl">2.5</span>))</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>regions.plot(ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">'black'</span>, column<span class="op">=</span><span class="st">'total_pop_15'</span>, legend<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-dissolve" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dissolve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-dissolve" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-dissolve-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-dissolve-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-dissolve-output-1.png" data-ref-parent="fig-dissolve" width="449" height="240" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-dissolve-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 49 States
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-dissolve" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-dissolve-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-dissolve-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-dissolve-output-2.png" data-ref-parent="fig-dissolve" width="462" height="240" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-dissolve-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 4 Regions
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dissolve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.15: Spatial aggregation on contiguous polygons, illustrated by aggregating the population of 49 US states into 4 regions, with population represented by color. Note the operation automatically dissolves boundaries between states.
</figcaption>
</figure>
</div>
<p>What is happening with the geometries here? Behind the scenes, <code>.dissolve</code> combines the geometries and dissolves the boundaries between them using the <code>.union_all</code> method per group. This is demonstrated in the code chunk below which creates a united western US using the standalone <code>.union_all</code> operation. Note that the result is a <code>shapely</code> geometry, as the individual attributes are ‘lost’ as part of dissolving (<a href="#fig-dissolve2" class="quarto-xref">Figure&nbsp;<span>4.16</span></a>).</p>
<div id="cell-fig-dissolve2" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>us_west <span class="op">=</span> us_states[us_states[<span class="st">'REGION'</span>] <span class="op">==</span> <span class="st">'West'</span>]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>us_west_union <span class="op">=</span> us_west.geometry.union_all()</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>us_west_union</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<div id="fig-dissolve2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dissolve2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-dissolve2-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dissolve2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.16: Western US
</figcaption>
</figure>
</div>
</div>
</div>
<p>To dissolve two (or more) groups of a <code>GeoDataFrame</code> into one geometry, we can either (a) use a combined condition or (b) concatenate the two separate subsets and then dissolve using <code>.union_all</code>.</p>
<div id="e8b9e54c" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach 1</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>sel <span class="op">=</span> (us_states[<span class="st">'REGION'</span>] <span class="op">==</span> <span class="st">'West'</span>) <span class="op">|</span> (us_states[<span class="st">'NAME'</span>] <span class="op">==</span> <span class="st">'Texas'</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>texas_union <span class="op">=</span> us_states[sel]</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>texas_union <span class="op">=</span> texas_union.geometry.union_all()</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach 2</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>us_west <span class="op">=</span> us_states[us_states[<span class="st">'REGION'</span>] <span class="op">==</span> <span class="st">'West'</span>]</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>texas <span class="op">=</span> us_states[us_states[<span class="st">'NAME'</span>] <span class="op">==</span> <span class="st">'Texas'</span>]</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>texas_union <span class="op">=</span> pd.concat([us_west, texas]).union_all()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is identical in both cases, shown in <a href="#fig-dissolve3" class="quarto-xref">Figure&nbsp;<span>4.17</span></a>.</p>
<div id="cell-fig-dissolve3" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>texas_union</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div id="fig-dissolve3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dissolve3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-dissolve3-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dissolve3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.17: Western US and Texas
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-type-transformations" class="level3" data-number="4.2.8">
<h3 data-number="4.2.8" class="anchored" data-anchor-id="sec-type-transformations"><span class="header-section-number">4.2.8</span> Type transformations</h3>
<p>Transformation of geometries, from one type to another, also known as ‘geometry casting’, is often required to facilitate spatial analysis. Either the <strong>geopandas</strong> or the <strong>shapely</strong> packages can be used for geometry casting, depending on the type of transformation, and the way that the input is organized (whether as individual geometry, or a vector layer). Therefore, the exact expression(s) depend on the specific transformation we are interested in.</p>
<p>In general, you need to figure out the required input of the respective constructor function according to the ‘destination’ geometry (e.g., <code>shapely.LineString</code>, etc.), then reshape the input of the source geometry into the right form to be passed to that function. Or, when available, you can use a wrapper from <strong>geopandas</strong>.</p>
<p>In this section, we demonstrate several common scenarios. We start with transformations of individual geometries from one type to another, using <strong>shapely</strong> methods:</p>
<ul>
<li><code>'MultiPoint'</code> to <code>'LineString'</code> (<a href="#fig-type-transform-linestring" class="quarto-xref">Figure&nbsp;<span>4.19</span></a>)</li>
<li><code>'MultiPoint'</code> to <code>'Polygon'</code> (<a href="#fig-type-transform-polygon" class="quarto-xref">Figure&nbsp;<span>4.20</span></a>)</li>
<li><code>'LineString'</code> to <code>'MultiPoint'</code> (<a href="#fig-type-transform-multipoint2" class="quarto-xref">Figure&nbsp;<span>4.22</span></a>)</li>
<li><code>'Polygon'</code> to <code>'MultiPoint'</code> (<a href="#fig-type-transform-polygon2" class="quarto-xref">Figure&nbsp;<span>4.23</span></a>)</li>
<li><code>'Polygon'</code>s to <code>'MultiPolygon'</code> (<a href="#fig-type-transform-multipolygon" class="quarto-xref">Figure&nbsp;<span>4.24</span></a>)</li>
<li><code>'MultiPolygon'</code>s to <code>'Polygon'</code>s (<a href="#fig-type-transform-multipolygon1" class="quarto-xref">Figure&nbsp;<span>4.25</span></a>, <a href="#fig-type-transform-multipolygon2" class="quarto-xref">Figure&nbsp;<span>4.26</span></a>)</li>
</ul>
<p>Then, we move on and demonstrate casting workflows on <code>GeoDataFrame</code>s, where we have further considerations, such as keeping track of geometry attributes, and the possibility of dissolving, rather than just combining, geometries. As we will see, these are done either by manually applying <strong>shapely</strong> methods on all geometries in the given layer, or using <strong>geopandas</strong> wrapper methods which do it automatically:</p>
<ul>
<li><code>'MultiLineString'</code> to <code>'LineString'</code>s (using <code>.explode</code>) (<a href="#fig-multilinestring-to-linestring" class="quarto-xref">Figure&nbsp;<span>4.28</span></a>)</li>
<li><code>'LineString'</code> to <code>'MultiPoint'</code>s (using <code>.apply</code>) (<a href="#fig-linestring-to-multipoint" class="quarto-xref">Figure&nbsp;<span>4.29</span></a>)</li>
<li><code>'LineString'</code>s to <code>'MultiLineString'</code> (using <code>.dissolve</code>)</li>
<li><code>'Polygon'</code>s to <code>'MultiPolygon'</code> (using <code>.dissolve</code> or <code>.agg</code>) (<a href="#fig-combine-geoms" class="quarto-xref">Figure&nbsp;<span>4.30</span></a>)</li>
<li><code>'Polygon'</code> to <code>'(Multi)LineString'</code> (using <code>.boundary</code> or <code>.exterior</code>) (demonstrated in a subsequent chapter, see <a href="05-raster-vector.html#sec-rasterizing-lines-and-polygons" class="quarto-xref"><span>Section 5.4.2</span></a>)</li>
</ul>
<p>Let’s start with the simple individual-geometry casting examples, to illustrate how geometry casting works on <strong>shapely</strong> geometry objects. First, let’s create a <code>'MultiPoint'</code> (<a href="#fig-type-transform-multipoint" class="quarto-xref">Figure&nbsp;<span>4.18</span></a>).</p>
<div id="cell-fig-type-transform-multipoint" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>multipoint <span class="op">=</span> shapely.MultiPoint([(<span class="dv">1</span>,<span class="dv">1</span>), (<span class="dv">3</span>,<span class="dv">3</span>), (<span class="dv">5</span>,<span class="dv">1</span>)])</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>multipoint</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<div id="fig-type-transform-multipoint" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-type-transform-multipoint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-type-transform-multipoint-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-type-transform-multipoint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.18: A <code>'MultiPoint'</code> geometry used to demonstrate <strong>shapely</strong> type transformations
</figcaption>
</figure>
</div>
</div>
</div>
<p>A <code>'LineString'</code> can be created using <code>shapely.LineString</code> from a <code>list</code> of points. Thus, a <code>'MultiPoint'</code> can be converted to a <code>'LineString'</code> by passing the points into a <code>list</code>, then passing them to <code>shapely.LineString</code> (<a href="#fig-type-transform-linestring" class="quarto-xref">Figure&nbsp;<span>4.19</span></a>). The <code>.geoms</code> property, mentioned in <a href="01-spatial-data.html#sec-geometries" class="quarto-xref"><span>Section 1.2.5</span></a>, gives access to the individual parts that comprise a multi-part geometry, as an iterable object similar to a <code>list</code>; it is one of the <strong>shapely</strong> access methods to internal parts of a geometry.</p>
<div id="cell-fig-type-transform-linestring" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>linestring <span class="op">=</span> shapely.LineString(multipoint.geoms)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>linestring</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<div id="fig-type-transform-linestring" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-type-transform-linestring-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-type-transform-linestring-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-type-transform-linestring-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.19: A <code>'LineString'</code> created from the <code>'MultiPoint'</code> in <a href="#fig-type-transform-multipoint" class="quarto-xref">Figure&nbsp;<span>4.18</span></a>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Similarly, a <code>'Polygon'</code> can be created using function <code>shapely.Polygon</code>, which accepts a sequence of point coordinates. In principle, the last coordinate must be equal to the first, in order to form a closed shape. However, <code>shapely.Polygon</code> is able to complete the last coordinate automatically, and therefore we can pass all of the coordinates of the <code>'MultiPoint'</code> directly to <code>shapely.Polygon</code> (<a href="#fig-type-transform-polygon" class="quarto-xref">Figure&nbsp;<span>4.20</span></a>).</p>
<div id="cell-fig-type-transform-polygon" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>polygon <span class="op">=</span> shapely.Polygon(multipoint.geoms)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>polygon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<div id="fig-type-transform-polygon" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-type-transform-polygon-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-type-transform-polygon-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-type-transform-polygon-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.20: A <code>'Polygon'</code> created from the <code>'MultiPoint'</code> in <a href="#fig-type-transform-multipoint" class="quarto-xref">Figure&nbsp;<span>4.18</span></a>
</figcaption>
</figure>
</div>
</div>
</div>
<p>The source <code>'MultiPoint'</code> geometry, and the derived <code>'LineString'</code> and <code>'Polygon'</code> geometries are shown in <a href="#fig-casting1" class="quarto-xref">Figure&nbsp;<span>4.21</span></a>. Note that we convert the <code>shapely</code> geometries to <code>GeoSeries</code> to be able to use the <strong>geopandas</strong> <code>.plot</code> method.</p>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>gpd.GeoSeries(multipoint).plot()<span class="op">;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>gpd.GeoSeries(linestring).plot()<span class="op">;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>gpd.GeoSeries(polygon).plot()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-casting1" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-casting1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-casting1" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-casting1-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-casting1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-casting1-output-1.png" data-ref-parent="fig-casting1" width="422" height="228" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-casting1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>'MultiPoint'</code>
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-casting1" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-casting1-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-casting1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-casting1-output-2.png" data-ref-parent="fig-casting1" width="422" height="228" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-casting1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) <code>'LineString'</code>
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-casting1" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-casting1-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-casting1-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-casting1-output-3.png" data-ref-parent="fig-casting1" width="422" height="228" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-casting1-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) <code>'Polygon'</code>
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-casting1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.21: Examples of <code>'LineString</code>’ and <code>'Polygon'</code> casted from a <code>'MultiPoint'</code> geometry
</figcaption>
</figure>
</div>
<p>Conversion from <code>'MultiPoint'</code> to <code>'LineString'</code>, shown above (<a href="#fig-type-transform-linestring" class="quarto-xref">Figure&nbsp;<span>4.19</span></a>), is a common operation that creates a line object from ordered point observations, such as GPS measurements or geotagged media. This allows spatial operations, such as calculating the length of the path traveled. Conversion from <code>'MultiPoint'</code> or <code>'LineString'</code> to <code>'Polygon'</code> (<a href="#fig-type-transform-polygon" class="quarto-xref">Figure&nbsp;<span>4.20</span></a>) is often used to calculate an area, for example from the set of GPS measurements taken around a lake or from the corners of a building lot.</p>
<p>Our <code>'LineString'</code> geometry can be converted back to a <code>'MultiPoint'</code> geometry by passing its coordinates directly to <code>shapely.MultiPoint</code> (<a href="#fig-type-transform-multipoint2" class="quarto-xref">Figure&nbsp;<span>4.22</span></a>).</p>
<div id="cell-fig-type-transform-multipoint2" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>shapely.MultiPoint(linestring.coords)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<div id="fig-type-transform-multipoint2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-type-transform-multipoint2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-type-transform-multipoint2-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-type-transform-multipoint2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.22: A <code>'MultiPoint'</code> created from the <code>'LineString'</code> in <a href="#fig-type-transform-linestring" class="quarto-xref">Figure&nbsp;<span>4.19</span></a>
</figcaption>
</figure>
</div>
</div>
</div>
<p>A <code>'Polygon'</code> (exterior) coordinates can be passed to <code>shapely.MultiPoint</code>, to go back to a <code>'MultiPoint'</code> geometry, as well (<a href="#fig-type-transform-polygon2" class="quarto-xref">Figure&nbsp;<span>4.23</span></a>).</p>
<div id="cell-fig-type-transform-polygon2" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>shapely.MultiPoint(polygon.exterior.coords)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<div id="fig-type-transform-polygon2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-type-transform-polygon2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-type-transform-polygon2-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-type-transform-polygon2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.23: A <code>'MultiPoint'</code> created from the <code>'Polygon'</code> in <a href="#fig-type-transform-polygon" class="quarto-xref">Figure&nbsp;<span>4.20</span></a>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Using these methods, we can transform between <code>'Point'</code>, <code>'LineString'</code>, and <code>'Polygon'</code> geometries, assuming there is a sufficient number of points (at least two for a line, and at least three for a polygon). When dealing with multi-part geometries using <strong>shapely</strong>, we can:</p>
<ul>
<li>Access single-part geometries (e.g., each <code>'Polygion'</code> in a <code>'MultiPolygon'</code> geometry) using <code>.geoms[i]</code>, where <code>i</code> is the index of the geometry</li>
<li>Combine single-part geometries into a multi-part geometry, by passing a <code>list</code> of the latter to the constructor function</li>
</ul>
<p>For example, here is how we combine two <code>'Polygon'</code> geometries into a <code>'MultiPolygon'</code> (while also using a <strong>shapely</strong> affine function <code>shapely.affinity.translate</code>, which is underlying the <strong>geopandas</strong> <code>.translate</code> method used earlier, see <a href="#sec-affine-transformations" class="quarto-xref"><span>Section 4.2.4</span></a>) (<a href="#fig-type-transform-multipolygon" class="quarto-xref">Figure&nbsp;<span>4.24</span></a>):</p>
<div id="cell-fig-type-transform-multipolygon" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>multipolygon <span class="op">=</span> shapely.MultiPolygon([</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    polygon, </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    shapely.affinity.translate(polygon.centroid.<span class="bu">buffer</span>(<span class="fl">1.5</span>), <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>multipolygon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<div id="fig-type-transform-multipolygon" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-type-transform-multipolygon-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-type-transform-multipolygon-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-type-transform-multipolygon-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.24: A <code>'MultiPolygon'</code> created from the <code>'Polygon'</code> in <a href="#fig-type-transform-polygon" class="quarto-xref">Figure&nbsp;<span>4.20</span></a> and another polygon
</figcaption>
</figure>
</div>
</div>
</div>
<p>Given <code>multipolygon</code>, here is how we can get back the <code>'Polygon'</code> part 1 (<a href="#fig-type-transform-multipolygon1" class="quarto-xref">Figure&nbsp;<span>4.25</span></a>):</p>
<div id="cell-fig-type-transform-multipolygon1" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>multipolygon.geoms[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<div id="fig-type-transform-multipolygon1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-type-transform-multipolygon1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-type-transform-multipolygon1-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-type-transform-multipolygon1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.25: The 1<sup>st</sup> part extracted from the <code>'MultiPolygon'</code> in <a href="#fig-type-transform-multipolygon" class="quarto-xref">Figure&nbsp;<span>4.24</span></a>
</figcaption>
</figure>
</div>
</div>
</div>
<p>and part 2 (<a href="#fig-type-transform-multipolygon2" class="quarto-xref">Figure&nbsp;<span>4.26</span></a>):</p>
<div id="cell-fig-type-transform-multipolygon2" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>multipolygon.geoms[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<div id="fig-type-transform-multipolygon2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-type-transform-multipolygon2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-type-transform-multipolygon2-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-type-transform-multipolygon2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.26: The 2<sup>nd</sup> part extracted from the <code>'MultiPolygon'</code> in <a href="#fig-type-transform-multipolygon" class="quarto-xref">Figure&nbsp;<span>4.24</span></a>
</figcaption>
</figure>
</div>
</div>
</div>
<p>However, dealing with multi-part geometries can be easier with <strong>geopandas</strong>. Thanks to the fact that geometries in a <code>GeoDataFrame</code> are associated with attributes, we can keep track of the origin of each geometry: duplicating the attributes when going from multi-part to single-part (using <code>.explode</code>, see below), or ‘collapsing’ the attributes through aggregation when going from single-part to multi-part (using <code>.dissolve</code>, see <a href="#sec-geometry-unions" class="quarto-xref"><span>Section 4.2.7</span></a>).</p>
<p>Let’s demonstrate going from multi-part to single-part (<a href="#fig-multilinestring-to-linestring" class="quarto-xref">Figure&nbsp;<span>4.28</span></a>) and then back to multi-part (<a href="#sec-geometry-unions" class="quarto-xref"><span>Section 4.2.7</span></a>), using a small line layer. As input, we will create a <code>'MultiLineString'</code> geometry composed of three lines (<a href="#fig-type-transform-multilinestring3" class="quarto-xref">Figure&nbsp;<span>4.27</span></a>).</p>
<div id="cell-fig-type-transform-multilinestring3" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>l1 <span class="op">=</span> shapely.LineString([(<span class="dv">1</span>, <span class="dv">5</span>), (<span class="dv">4</span>, <span class="dv">3</span>)])</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>l2 <span class="op">=</span> shapely.LineString([(<span class="dv">4</span>, <span class="dv">4</span>), (<span class="dv">4</span>, <span class="dv">1</span>)])</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>l3 <span class="op">=</span> shapely.LineString([(<span class="dv">2</span>, <span class="dv">2</span>), (<span class="dv">4</span>, <span class="dv">2</span>)])</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>ml <span class="op">=</span> shapely.MultiLineString([l1, l2, l3])</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>ml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<div id="fig-type-transform-multilinestring3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-type-transform-multilinestring3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-type-transform-multilinestring3-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-type-transform-multilinestring3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.27: A <code>'MultiLineString'</code> geometry composed of three lines
</figcaption>
</figure>
</div>
</div>
</div>
<p>Let’s place it into a <code>GeoSeries</code>.</p>
<div id="6d1af0b9" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>geom <span class="op">=</span> gpd.GeoSeries(ml)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>geom</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>0    MULTILINESTRING ((1 5, 4 3), (4...
dtype: geometry</code></pre>
</div>
</div>
<p>Then, put it into a <code>GeoDataFrame</code> with an attribute called <code>'id'</code>:</p>
<div id="c15df823" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>dat <span class="op">=</span> gpd.GeoDataFrame(geometry<span class="op">=</span>geom, data<span class="op">=</span>pd.DataFrame({<span class="st">'id'</span>: [<span class="dv">1</span>]}))</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>dat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>MULTILINESTRING ((1 5, 4 3), (4...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>You can imagine it as a road or river network. The above layer <code>dat</code> has only one row that defines all the lines. This restricts the number of operations that can be done, for example, it prevents adding names to each line segment or calculating lengths of single lines. Using <strong>shapely</strong> methods with which we are already familiar with (see above), the individual single-part geometries (i.e., the ‘parts’) can be accessed through the <code>.geoms</code> property.</p>
<div id="f8e691d4" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(ml.geoms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>[&lt;LINESTRING (1 5, 4 3)&gt;, &lt;LINESTRING (4 4, 4 1)&gt;, &lt;LINESTRING (2 2, 4 2)&gt;]</code></pre>
</div>
</div>
<p>However, specifically for the ‘multi-part to single part’ type transformation scenario, there is also a method called <code>.explode</code>, which can convert an entire multi-part <code>GeoDataFrame</code> to a single-part one. The advantage is that the original attributes (such as <code>id</code>) are retained, so that we can keep track of the original multi-part geometry properties that each part came from. The <code>index_parts=True</code> argument also lets us keep track of the original multipart geometry indices, and part indices, named <code>level_0</code> and <code>level_1</code>, respectively.</p>
<div id="709f642a" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>dat1 <span class="op">=</span> dat.explode(index_parts<span class="op">=</span><span class="va">True</span>).reset_index()</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>dat1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">level_0</th>
<th data-quarto-table-cell-role="th">level_1</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>LINESTRING (1 5, 4 3)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>LINESTRING (4 4, 4 1)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>LINESTRING (2 2, 4 2)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>For example, here we see that all <code>'LineString'</code> geometries came from the same multi-part geometry (<code>level_0</code>=<code>0</code>), which had three parts (<code>level_1</code>=<code>0</code>,<code>1</code>,<code>2</code>). <a href="#fig-multilinestring-to-linestring" class="quarto-xref">Figure&nbsp;<span>4.28</span></a> demonstrates the effect of <code>.explode</code> in converting a layer with multi-part geometries into a layer with single-part geometries.</p>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>dat.plot(column<span class="op">=</span><span class="st">'id'</span>, linewidth<span class="op">=</span><span class="dv">7</span>)<span class="op">;</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>dat1.plot(column<span class="op">=</span><span class="st">'level_1'</span>, linewidth<span class="op">=</span><span class="dv">7</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-multilinestring-to-linestring" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-multilinestring-to-linestring-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-multilinestring-to-linestring" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-multilinestring-to-linestring-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-multilinestring-to-linestring-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-multilinestring-to-linestring-output-1.png" data-ref-parent="fig-multilinestring-to-linestring" width="327" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-multilinestring-to-linestring-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>'MultiLineString'</code> layer
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-multilinestring-to-linestring" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-multilinestring-to-linestring-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-multilinestring-to-linestring-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-multilinestring-to-linestring-output-2.png" data-ref-parent="fig-multilinestring-to-linestring" width="327" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-multilinestring-to-linestring-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) <code>'LineString'</code> layer, after applying <code>.explode</code>
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-multilinestring-to-linestring-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.28: Transformation of a <code>'MultiLineString'</code> layer with one feature, into a <code>'LineString'</code> layer with three features, using <code>.explode</code>
</figcaption>
</figure>
</div>
<p>As a side-note, let’s demonstrate how the above <strong>shapely</strong> casting methods can be translated to <strong>geopandas</strong>. Suppose that we want to transform <code>dat1</code>, which is a layer of type <code>'LineString'</code> with three features, to a layer of type <code>'MultiPoint'</code> (also with three features). Recall that for a single geometry, we use the expression <code>shapely.MultiPoint(x.coords)</code>, where <code>x</code> is a <code>'LineString'</code> (<a href="#fig-type-transform-multipoint2" class="quarto-xref">Figure&nbsp;<span>4.22</span></a>). When dealing with a <code>GeoDataFrame</code>, we wrap the conversion into <code>.apply</code>, to apply it to all geometries:</p>
<div id="239701c6" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>dat2 <span class="op">=</span> dat1.copy()</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>dat2.geometry <span class="op">=</span> dat2.geometry.<span class="bu">apply</span>(<span class="kw">lambda</span> x: shapely.MultiPoint(x.coords))</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>dat2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">level_0</th>
<th data-quarto-table-cell-role="th">level_1</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>MULTIPOINT (1 5, 4 3)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>MULTIPOINT (4 4, 4 1)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>MULTIPOINT (2 2, 4 2)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The result is illustrated in <a href="#fig-linestring-to-multipoint" class="quarto-xref">Figure&nbsp;<span>4.29</span></a>.</p>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>dat1.plot(column<span class="op">=</span><span class="st">'level_1'</span>, linewidth<span class="op">=</span><span class="dv">7</span>)<span class="op">;</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>dat2.plot(column<span class="op">=</span><span class="st">'level_1'</span>, markersize<span class="op">=</span><span class="dv">50</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-linestring-to-multipoint" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-linestring-to-multipoint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-linestring-to-multipoint" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-linestring-to-multipoint-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-linestring-to-multipoint-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-linestring-to-multipoint-output-1.png" data-ref-parent="fig-linestring-to-multipoint" width="327" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-linestring-to-multipoint-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>'LineString'</code> layer
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-linestring-to-multipoint" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-linestring-to-multipoint-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-linestring-to-multipoint-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-linestring-to-multipoint-output-2.png" data-ref-parent="fig-linestring-to-multipoint" width="327" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-linestring-to-multipoint-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) <code>'MultiPoint'</code> layer
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-linestring-to-multipoint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.29: Transformation of a <code>'LineString'</code> layer with three features, into a <code>'MultiPoint'</code> layer (also with three features), using <code>.apply</code> and <strong>shapely</strong> methods
</figcaption>
</figure>
</div>
<p>The opposite transformation, i.e., ‘single-part to multi-part’, is achieved using the <code>.dissolve</code> method (which we are already familiar with, see <a href="#sec-geometry-unions" class="quarto-xref"><span>Section 4.2.7</span></a>). For example, here is how we can get from the <code>'LineString'</code> layer with three features back to the <code>'MultiLineString'</code> layer with one feature (since, in this case, there is just one group):</p>
<div id="84076868" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>dat1.dissolve(by<span class="op">=</span><span class="st">'id'</span>).reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">level_0</th>
<th data-quarto-table-cell-role="th">level_1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>MULTILINESTRING ((1 5, 4 3), (4...</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The next code chunk is another example, dissolving the 16 polygons in <code>nz</code> into two geometries of the north and south parts (i.e., the two <code>'Island'</code> groups).</p>
<div id="74b068f4" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>nz_dis1 <span class="op">=</span> nz[[<span class="st">'Island'</span>, <span class="st">'Population'</span>, <span class="st">'geometry'</span>]] <span class="op">\</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    .dissolve(by<span class="op">=</span><span class="st">'Island'</span>, aggfunc<span class="op">=</span><span class="st">'sum'</span>) <span class="op">\</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>nz_dis1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Island</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">Population</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>North</td>
<td>MULTIPOLYGON (((1865558.829 546...</td>
<td>3671600.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>South</td>
<td>MULTIPOLYGON (((1229729.735 479...</td>
<td>1115600.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Note that <code>.dissolve</code> not only combines single-part into multi-part geometries, but also dissolves any internal borders. So, in fact, the resulting geometries may be single-part (in case when all parts touch each other, unlike in <code>nz</code>). If, for some reason, we want to combine geometries into multi-part <em>without</em> dissolving, we can fall back to the <strong>pandas</strong> <code>.agg</code> method (custom table aggregation), supplemented with a <strong>shapely</strong> function specifying how exactly we want to transform each group of geometries into a new single geometry. In the following example, for instance, we collect all <code>'Polygon'</code> and <code>'MultiPolygon'</code> parts of <code>nz</code> into a single <code>'MultiPolygon'</code> geometry with many separate parts (i.e., without dissolving), per group.</p>
<div id="43903659" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>nz_dis2 <span class="op">=</span> nz <span class="op">\</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'Island'</span>) <span class="op">\</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    .agg({</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Population'</span>: <span class="st">'sum'</span>,</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'geometry'</span>: <span class="kw">lambda</span> x: shapely.MultiPolygon(x.explode().to_list())</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    }) <span class="op">\</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>nz_dis2 <span class="op">=</span> gpd.GeoDataFrame(nz_dis2).set_geometry(<span class="st">'geometry'</span>).set_crs(nz.crs)</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>nz_dis2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Island</th>
<th data-quarto-table-cell-role="th">Population</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>North</td>
<td>3671600.0</td>
<td>MULTIPOLYGON (((1745493.196 600...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>South</td>
<td>1115600.0</td>
<td>MULTIPOLYGON (((1557042.169 531...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The difference between the last two results <code>nz_dis1</code> and <code>nz_dis2</code> (with and without dissolving, respectively) is not evident in the printout: in both cases we got a layer with two features of type <code>'MultiPolygon'</code>. However, in the first case internal borders were dissolved, while in the second case they were not. This is illustrated in <a href="#fig-combine-geoms" class="quarto-xref">Figure&nbsp;<span>4.30</span></a>:</p>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>nz_dis1.plot(color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)<span class="op">;</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>nz_dis2.plot(color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-combine-geoms" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-combine-geoms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-combine-geoms" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-combine-geoms-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-combine-geoms-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-combine-geoms-output-1.png" data-ref-parent="fig-combine-geoms" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-combine-geoms-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Dissolving (using the <strong>geopandas</strong> <code>.dissolve</code> method)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-combine-geoms" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-combine-geoms-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-combine-geoms-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-combine-geoms-output-2.png" data-ref-parent="fig-combine-geoms" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-combine-geoms-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Combining into multi-part without dissolving (using <code>.agg</code> and a custom <strong>shapely</strong>-based function)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-combine-geoms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.30: Combining New Zealand geometries into one, for each island, with and without dissolving
</figcaption>
</figure>
</div>
<p>It is also worthwhile to note the <code>.boundary</code> and <code>.exterior</code> properties of <code>GeoSeries</code>, which are used to cast polygons to lines, with or without interior rings, respectively (see <a href="05-raster-vector.html#sec-rasterizing-lines-and-polygons" class="quarto-xref"><span>Section 5.4.2</span></a>).</p>
</section>
</section>
<section id="sec-geo-ras" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="sec-geo-ras"><span class="header-section-number">4.3</span> Geometric operations on raster data</h2>
<p>Geometric raster operations include the shift, flipping, mirroring, scaling, rotation, or warping of images. These operations are necessary for a variety of applications including georeferencing, used to allow images to be overlaid on an accurate map with a known CRS <span class="citation" data-cites="liu_essential_2009">(<a href="references.html#ref-liu_essential_2009" role="doc-biblioref">Liu and Mason 2009</a>)</span>. A variety of georeferencing techniques exist, including:</p>
<ul>
<li>Georectification based on known ground control points</li>
<li>Orthorectification, which also accounts for local topography</li>
<li>Image registration is used to combine images of the same thing but shot from different sensors, by aligning one image with another (in terms of coordinate system and resolution)</li>
</ul>
<p>Python is rather unsuitable for the first two points since these often require manual intervention which is why they are usually done with the help of dedicated GIS software. On the other hand, aligning several images is possible in Python and this section shows among others how to do so. This often includes changing the extent, the resolution, and the origin of an image. A matching projection is of course also required but is already covered in <a href="06-reproj.html#sec-reprojecting-raster-geometries" class="quarto-xref"><span>Section 6.8</span></a>.</p>
<p>In any case, there are other reasons to perform a geometric operation on a single raster image. For instance, a common reason for aggregating a raster is to decrease run-time or save disk space. Of course, this approach is only recommended if the task at hand allows a coarser resolution of raster data.</p>
<!-- ### Geometric intersections {#sec-raster-geometric-intersections} -->
<!-- jn: Michael, what is the difference between this section and the section about cropping and masking in the next chapter?  -->
<!-- In geocompr, the difference is clean -- the first section is about cliping a raster with another raster; the second section is about cropping a raster with a vector. -->
<!-- Here, the difference is not clear to me. -->
<!-- If there is no difference, maybe we should either rewrite this section or remove it. -->
<!-- md: that's correct, the only difference is that here the cropping geometry comes from another raster, however in 'rasterio' there is no distinct way to crop using a raster, so indeed most of the workflow is the same. I agree this section mostly repeats the same material, it's fine with me to remove it -->
<!-- In @sec-spatial-subsetting-raster we have shown how to extract values from a raster overlaid by coordinates or by a matching boolean mask. -->
<!-- A different case is when the area of interest is defined by any general (possibly non-matching) raster B, to retrieve a spatial output of a (smaller) subset of raster A we can: -->
<!-- -   Extract the bounding box polygon of B (hereby, `clip`) -->
<!-- -   Mask and crop A (hereby, `elev.tif`) using B (@sec-raster-cropping) -->
<!-- For example, suppose that we want to get a subset of the `elev.tif` raster using another, smaller, raster. -->
<!-- To demonstrate this, let's create (see @sec-raster-from-scratch) that smaller raster, hereby named `clip`. -->
<!-- First, we need to create a $3 \times 3$ array of raster values. -->
<!-- clip = np.array([1] * 9).reshape(3, 3) -->
<!-- clip -->
<!-- Then, we define the transformation matrix, in such a way that `clip` intersects with `elev.tif` (@fig-raster-intersection). -->
<!-- new_transform = rasterio.transform.from_origin(west=0.9, north=0.45, xsize=0.3, ysize=0.3) -->
<!-- new_transform -->
<!-- Now, for subsetting, we will derive a `shapely` geometry representing the `clip` raster extent, using [`rasterio.transform.array_bounds`](https://rasterio.readthedocs.io/en/latest/api/rasterio.transform.html#rasterio.transform.array_bounds). -->
<!-- bbox = rasterio.transform.array_bounds(clip.shape[1], clip.shape[0], new_transform) -->
<!-- bbox -->
<!-- The four numeric values can be transformed into a rectangular `shapely` geometry using `shapely.box` (@fig-raster-clip-bbox). -->
<!-- #| label: fig-raster-clip-bbox -->
<!-- #| fig-cap: '`shapely` geometry derived from a clipping raster bounding box coordinates, a preliminary step for geometric intersection between two rasters' -->
<!-- bbox = shapely.box(*bbox) -->
<!-- bbox -->
<!-- @fig-raster-intersection shows the alignment of `bbox` and `elev.tif`. -->
<!-- #| label: fig-raster-intersection -->
<!-- #| fig-cap: The `elev.tif` raster, and the extent of another (smaller) raster `clip` which we use to subset it -->
<!-- fig, ax = plt.subplots() -->
<!-- rasterio.plot.show(src_elev, ax=ax) -->
<!-- gpd.GeoSeries([bbox]).plot(color='none', ax=ax); -->
<!-- From here on, subsetting can be done using masking and cropping, just like with any vector layer other than `bbox`, regardless whether it is rectangular or not. -->
<!-- We elaborate on masking and cropping in @sec-raster-cropping (check that section for details about `rasterio.mask.mask`), but, for completeness, here is the code for the last step of masking and cropping: -->
<!-- out_image, out_transform = rasterio.mask.mask(src_elev, [bbox], crop=True, all_touched=True, nodata=0) -->
<!-- The resulting subset array `out_image` contains all pixels intersecting with `clip` *pixels* (not necessarily with the centroids!). -->
<!-- However, due to the `all_touched=True` argument, those pixels which intersect with `clip`, but their centroid does not, retain their original values (e.g., `17`, `23`) rather than turned into "No Data" (e.g., `0`). -->
<!-- out_image -->
<!-- Therefore, in our case, subset `out_image` dimensions are $2 \times 2$ (@fig-raster-intersection2; also see @fig-raster-intersection). -->
<!-- #| label: fig-raster-intersection2 -->
<!-- #| fig-cap: The resulting subset of the `elev.tif` raster -->
<!-- fig, ax = plt.subplots() -->
<!-- rasterio.plot.show(out_image, transform=out_transform, ax=ax) -->
<!-- gpd.GeoSeries([bbox]).plot(color='none', ax=ax); -->
<section id="sec-extent-and-origin" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="sec-extent-and-origin"><span class="header-section-number">4.3.1</span> Extent and origin</h3>
<p>When merging or performing map algebra on rasters, their resolution, projection, origin, and/or extent have to match. Otherwise, how should we add the values of one raster with a resolution of <code>0.2</code> decimal degrees to a second raster with a resolution of <code>1</code> decimal degree? The same problem arises when we would like to merge satellite imagery from different sensors with different projections and resolutions. We can deal with such mismatches by aligning the rasters. Typically, raster alignment is done through resampling—that way, it is guaranteed that the rasters match exactly (<a href="#sec-raster-resampling" class="quarto-xref"><span>Section 4.3.3</span></a>). However, sometimes it can be useful to modify raster placement and extent manually, by adding or removing rows and columns, or by modifying the origin, that is, slightly shifting the raster. Sometimes, there are reasons other than alignment with a second raster for manually modifying raster extent and placement. For example, it may be useful to add extra rows and columns to a raster prior to focal operations, so that it is easier to operate on the edges.</p>
<p>Let’s demostrate the first operation, raster padding. First, we will read the array with the <code>elev.tif</code> values:</p>
<div id="bca66c7d" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> src_elev.read(<span class="dv">1</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>array([[ 1,  2,  3,  4,  5,  6],
       [ 7,  8,  9, 10, 11, 12],
       [13, 14, 15, 16, 17, 18],
       [19, 20, 21, 22, 23, 24],
       [25, 26, 27, 28, 29, 30],
       [31, 32, 33, 34, 35, 36]], dtype=uint8)</code></pre>
</div>
</div>
<p>To pad an <code>ndarray</code>, we can use the <code>np.pad</code> function. The function accepts an array, and a tuple of the form <code>((rows_top,rows_bottom),(columns_left, columns_right))</code>. Also, we can specify the value that’s being used for padding with <code>constant_values</code> (e.g., <code>18</code>). For example, here we pad <code>r</code> with one extra row and two extra columns, on both sides, resulting in the array <code>r_pad</code>:</p>
<div id="84453323" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>r_pad <span class="op">=</span> np.pad(r, ((rows,rows),(cols,cols)), constant_values<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>r_pad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>array([[18, 18, 18, 18, 18, 18, 18, 18, 18, 18],
       [18, 18,  1,  2,  3,  4,  5,  6, 18, 18],
       [18, 18,  7,  8,  9, 10, 11, 12, 18, 18],
       [18, 18, 13, 14, 15, 16, 17, 18, 18, 18],
       [18, 18, 19, 20, 21, 22, 23, 24, 18, 18],
       [18, 18, 25, 26, 27, 28, 29, 30, 18, 18],
       [18, 18, 31, 32, 33, 34, 35, 36, 18, 18],
       [18, 18, 18, 18, 18, 18, 18, 18, 18, 18]], dtype=uint8)</code></pre>
</div>
</div>
<p>However, for <code>r_pad</code> to be used in any spatial operation, we also have to update its transformation matrix. Whenever we add extra columns on the left, or extra rows on top, the raster <em>origin</em> changes. To reflect this fact, we have to take to ‘original’ origin and add the required multiple of pixel widths or heights (i.e., raster resolution steps). The transformation matrix of a raster is accessible from the raster file metadata (<a href="01-spatial-data.html#sec-raster-from-scratch" class="quarto-xref"><span>Section 1.3.2</span></a>) or, as a shortcut, through the <code>.transform</code> property of the raster file connection. For example, the next code chunk shows the transformation matrix of <code>elev.tif</code>.</p>
<div id="32f97f63" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>src_elev.transform </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>Affine(0.5, 0.0, -1.5,
       0.0, -0.5, 1.5)</code></pre>
</div>
</div>
<p>From the transformation matrix, we are able to extract the origin.</p>
<div id="e7474f4d" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>xmin, ymax <span class="op">=</span> src_elev.transform[<span class="dv">2</span>], src_elev.transform[<span class="dv">5</span>]</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>xmin, ymax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>(-1.5, 1.5)</code></pre>
</div>
</div>
<p>We can also get the resolution of the data, which is the distance between two adjacent pixels.</p>
<div id="5a252640" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>dx, dy <span class="op">=</span> src_elev.transform[<span class="dv">0</span>], src_elev.transform[<span class="dv">4</span>]</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>dx, dy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>(0.5, -0.5)</code></pre>
</div>
</div>
<p>These two parts of information are enough to calculate the new origin (<code>xmin_new,ymax_new</code>) of the padded raster.</p>
<div id="67d86711" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>xmin_new <span class="op">=</span> xmin <span class="op">-</span> dx <span class="op">*</span> cols</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>ymax_new <span class="op">=</span> ymax <span class="op">-</span> dy <span class="op">*</span> rows</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>xmin_new, ymax_new</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>(-2.5, 2.0)</code></pre>
</div>
</div>
<p>Using the updated origin, we can update the transformation matrix (<a href="01-spatial-data.html#sec-raster-from-scratch" class="quarto-xref"><span>Section 1.3.2</span></a>). Keep in mind that the meaning of the last two arguments is <code>xsize</code>, <code>ysize</code>, so we need to pass the absolute value of <code>dy</code> (since it is negative).</p>
<div id="d6aea158" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>new_transform <span class="op">=</span> rasterio.transform.from_origin(</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    west<span class="op">=</span>xmin_new, </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    north<span class="op">=</span>ymax_new, </span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    xsize<span class="op">=</span>dx, </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    ysize<span class="op">=</span><span class="bu">abs</span>(dy)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>new_transform</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>Affine(0.5, 0.0, -2.5,
       0.0, -0.5, 2.0)</code></pre>
</div>
</div>
<p><a href="#fig-raster-shift-origin" class="quarto-xref">Figure&nbsp;<span>4.31</span></a> shows the padded raster, with the outline of the original <code>elev.tif</code> (in red), demonstrating that the origin was shifted correctly and the <code>new_transform</code> works fine.</p>
<div id="cell-fig-raster-shift-origin" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(r_pad, transform<span class="op">=</span>new_transform, cmap<span class="op">=</span><span class="st">'Greys'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>elev_bbox <span class="op">=</span> gpd.GeoSeries(shapely.box(<span class="op">*</span>src_elev.bounds))</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>elev_bbox.plot(color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>, ax<span class="op">=</span>ax)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-raster-shift-origin" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raster-shift-origin-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-raster-shift-origin-output-1.png" width="433" height="344" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raster-shift-origin-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.31: The padded <code>elev.tif</code> raster, and the extent of the original <code>elev.tif</code> raster (in red)
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can shift a raster origin not just when padding, but in any other use case, just by changing its transformation matrix. The effect is that the raster is going to be shifted (which is analogous to <code>.translate</code> for shifting a vector layer, see <a href="#sec-affine-transformations" class="quarto-xref"><span>Section 4.2.4</span></a>). Manually shifting a raster to arbitrary distance is rarely needed in real-life scenarios, but it is useful to know how to do it at least for a better understanding of the concept of <em>raster origin</em>. As an example, let’s shift the origin of <code>elev.tif</code> by <code>(-0.25,0.25)</code>. First, we need to calculate the new origin.</p>
<div id="23006d8b" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>xmin_new <span class="op">=</span> xmin <span class="op">-</span> <span class="fl">0.25</span>  <span class="co"># shift xmin to the left</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>ymax_new <span class="op">=</span> ymax <span class="op">+</span> <span class="fl">0.25</span>  <span class="co"># shift ymax upwards</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>xmin_new, ymax_new</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="76">
<pre><code>(-1.75, 1.75)</code></pre>
</div>
</div>
<p>To shift the origin in other directions we should change the two operators (<code>-</code>, <code>+</code>) accordingly.</p>
<p>Then, same as when padding (see above), we create an updated transformation matrix.</p>
<div id="380572ab" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>new_transform <span class="op">=</span> rasterio.transform.from_origin(</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>    west<span class="op">=</span>xmin_new, </span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    north<span class="op">=</span>ymax_new, </span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    xsize<span class="op">=</span>dx, </span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    ysize<span class="op">=</span><span class="bu">abs</span>(dy)</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>new_transform</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>Affine(0.5, 0.0, -1.75,
       0.0, -0.5, 1.75)</code></pre>
</div>
</div>
<p><a href="#fig-raster-shift-origin2" class="quarto-xref">Figure&nbsp;<span>4.32</span></a> shows the shifted raster and the outline of the original <code>elev.tif</code> raster (in red).</p>
<div id="cell-fig-raster-shift-origin2" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(r, transform<span class="op">=</span>new_transform, cmap<span class="op">=</span><span class="st">'Greys'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>elev_bbox.plot(color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>, ax<span class="op">=</span>ax)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-raster-shift-origin2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raster-shift-origin2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-raster-shift-origin2-output-1.png" width="430" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raster-shift-origin2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.32: The <code>elev.tif</code> raster shifted by <code>(0.25,0.25)</code>, and its original extent (in red)
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-raster-agg-disagg" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="sec-raster-agg-disagg"><span class="header-section-number">4.3.2</span> Aggregation and disaggregation</h3>
<p>Raster datasets vary based on their resolution, from high-resolution datasets that enable individual trees to be seen, to low-resolution datasets covering large swaths of the Earth. Raster datasets can be transformed to either decrease (aggregate) or increase (disaggregate) their resolution, for a number of reasons. For example, aggregation can be used to reduce computational resource requirements of raster storage and subsequent steps, while disaggregation can be used to match other datasets, or to add detail.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Raster aggregation is, in fact, a special case of raster resampling (see <a href="#sec-raster-resampling" class="quarto-xref"><span>Section 4.3.3</span></a>), where the target raster grid is aligned with the original raster, only with coarser pixels. Conversely, raster resampling is the general case where the new grid is not necessarily an aggregation of the original one, but any other type of grid (i.e., shifted and or having increased/reduced resolution, by any factor).</p>
</div>
</div>
<p>As an example, we here change the spatial resolution of <code>dem.tif</code> by a factor of <code>5</code> (<a href="#fig-raster-aggregate" class="quarto-xref">Figure&nbsp;<span>4.33</span></a>). To aggregate a raster using <strong>rasterio</strong>, we go through two steps:</p>
<ul>
<li>Reading the raster values (using <code>.read</code>) into an <code>out_shape</code> that is different from the original <code>.shape</code></li>
<li>Updating the <code>transform</code> according to <code>out_shape</code></li>
</ul>
<p>Let’s demonstrate it, using the <code>dem.tif</code> file. Note the original shape of the raster; it has <code>117</code> rows and <code>117</code> columns.</p>
<div id="53405386" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>src.read(<span class="dv">1</span>).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>(117, 117)</code></pre>
</div>
</div>
<p>Also note the transform, which tells us that the raster resolution is about 30.85 <span class="math inline">\(m\)</span>.</p>
<div id="acfdc1cc" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>src.transform</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>Affine(30.849999999999604, 0.0, 794599.1076146346,
       0.0, -30.84999999999363, 8935384.324602526)</code></pre>
</div>
</div>
<p>To aggregate, instead of reading the raster values the usual way, as in <code>src.read(1)</code>, we can specify <code>out_shape</code> to read the values into a different shape. Here, we calculate a new shape which is downscaled by a factor of <code>5</code>, i.e., the number of rows and columns is multiplied by <code>0.2</code>. We must truncate any partial rows and columns, e.g., using <code>int</code>. Each new pixel is now obtained, or resampled, from <span class="math inline">\(\sim 5 \times 5 = \sim 25\)</span> ‘old’ raster values. It is crucial to choose an appropriate <em>resampling method</em> through the <code>resampling</code> parameter. Here we use <code>rasterio.enums.Resampling.average</code>, i.e., the new ‘large’ pixel value is the average of all coinciding small pixels, which makes sense for our elevation data in <code>dem.tif</code>. See <a href="#sec-raster-resampling" class="quarto-xref"><span>Section 4.3.3</span></a> for a list of other available methods.</p>
<div id="8f0ea560" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>factor <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> src.read(<span class="dv">1</span>,</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>    out_shape<span class="op">=</span>(</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">int</span>(src.height <span class="op">*</span> factor),</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">int</span>(src.width <span class="op">*</span> factor)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    resampling<span class="op">=</span>rasterio.enums.Resampling.average</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As expected, the resulting array <code>r</code> has ~5 times smaller dimensions, as shown below.</p>
<div id="cc93e35a" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>r.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>(23, 23)</code></pre>
</div>
</div>
<p>What’s left to be done is the second step, to update the transform, taking into account the change in raster shape. This can be done as follows, using <code>.transform.scale</code>.</p>
<div id="92d97fd0" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>new_transform <span class="op">=</span> src.transform <span class="op">*</span> src.transform.scale(</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    (src.width <span class="op">/</span> r.shape[<span class="dv">1</span>]),</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    (src.height <span class="op">/</span> r.shape[<span class="dv">0</span>])</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>new_transform</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>Affine(156.93260869565017, 0.0, 794599.1076146346,
       0.0, -156.9326086956198, 8935384.324602526)</code></pre>
</div>
</div>
<p><a href="#fig-raster-aggregate" class="quarto-xref">Figure&nbsp;<span>4.33</span></a> shows the original raster and the aggregated one.</p>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(src)<span class="op">;</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(r, transform<span class="op">=</span>new_transform)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-raster-aggregate" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raster-aggregate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-aggregate" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-raster-aggregate-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-aggregate-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-raster-aggregate-output-1.png" data-ref-parent="fig-raster-aggregate" width="449" height="425" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-aggregate-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Original
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-aggregate" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-raster-aggregate-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-aggregate-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-raster-aggregate-output-2.png" data-ref-parent="fig-raster-aggregate" width="449" height="425" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-aggregate-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Aggregated (using average resampling)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raster-aggregate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.33: Aggregating a raster by a factor of 5, using average resampling
</figcaption>
</figure>
</div>
<p>This is a good opportunity to demonstrate exporting a raster with modified dimensions and transformation matrix. We can update the raster metadata required for writing with the <code>update</code> method.</p>
<div id="ad262ae3" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>dst_kwargs <span class="op">=</span> src.meta.copy()</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>dst_kwargs.update({</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'transform'</span>: new_transform,</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'width'</span>: r.shape[<span class="dv">1</span>],</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'height'</span>: r.shape[<span class="dv">0</span>],</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>dst_kwargs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>{'driver': 'GTiff',
 'dtype': 'float32',
 'nodata': nan,
 'width': 23,
 'height': 23,
 'count': 1,
 'crs': CRS.from_epsg(32717),
 'transform': Affine(156.93260869565017, 0.0, 794599.1076146346,
        0.0, -156.9326086956198, 8935384.324602526)}</code></pre>
</div>
</div>
<p>Then we can create a new file (<code>dem_agg5.tif</code>) in writing mode, and write the values from the aggregated array <code>r</code> into the 1<sup>st</sup> band of the file (see <a href="07-read-write.html#sec-data-output-raster" class="quarto-xref"><span>Section 7.6.2</span></a> for a detailed explanation of writing raster files with <strong>rasterio</strong>).</p>
<div id="e4593d93" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>dst <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'output/dem_agg5.tif'</span>, <span class="st">'w'</span>, <span class="op">**</span>dst_kwargs)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>dst.write(r, <span class="dv">1</span>)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>dst.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>**</code> syntax in Python is known as variable-length ‘<em>keyword</em> arguments’. It is used to pass a dictionary of numerous <code>parameter:argument</code> pairs to named arguments of a function. In <code>rasterio.open</code> writing mode, the ‘keyword arguments’ syntax often comes in handy, because, instead of specifying each and every property of a new file, we pass a (modified) <code>.meta</code> dictionary based on another, template, raster.</p>
<p>Technically, keep in mind that the expression:</p>
<pre><code>rasterio.open('out.tif', 'w', **dst_kwargs)</code></pre>
<p>where <code>dst_kwargs</code> is a <code>dict</code> of the following form (typically coming from a template raster, possibly with few updated properties using <code>.update</code>, see above):</p>
<pre><code>{'driver': 'GTiff',
 'dtype': 'float32',
 'nodata': nan,
 ...
}</code></pre>
<p>is a shortcut of:</p>
<pre><code>rasterio.open(
    'out.tif', 'w', 
    driver=dst_kwargs['driver'], 
    dtype=dst_kwargs['dtype'], 
    nodata=dst_kwargs['nodata'], 
    ...
)</code></pre>
<p><em>Positional</em> arguments is a related technique; see note in <a href="06-reproj.html#sec-reprojecting-raster-geometries" class="quarto-xref"><span>Section 6.8</span></a>.</p>
</div>
</div>
<p>The opposite operation, namely disaggregation, is when we increase the resolution of raster objects. Either of the supported resampling methods (see <a href="#sec-raster-resampling" class="quarto-xref"><span>Section 4.3.3</span></a>) can be used. However, since we are not actually summarizing information but transferring the value of a large pixel into multiple small pixels, it makes sense to use either:</p>
<ul>
<li>Nearest neighbor resampling (<code>rasterio.enums.Resampling.nearest</code>), when we want to keep the original values as-is, since modifying them would be incorrect (such as in categorical rasters)</li>
<li>Smoothing techniques, such as bilinear resampling (<code>rasterio.enums.Resampling.bilinear</code>), when we would like the smaller pixels to reflect gradual change between the original values, e.g., when the disaggregated raster is used for visualization purposes</li>
</ul>
<p>To disaggregate a raster, we go through exactly the same workflow as for aggregation, only using a different scaling factor, such as <code>factor=5</code> instead of <code>factor=0.2</code>, i.e., <em>increasing</em> the number of raster pixels instead of decreasing. In the example below, we disaggregate using bilinear interpolation, to get a smoothed high-resolution raster.</p>
<div id="72be4d2f" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>factor <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> src.read(<span class="dv">1</span>,</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    out_shape<span class="op">=</span>(</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">int</span>(src.height <span class="op">*</span> factor),</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">int</span>(src.width <span class="op">*</span> factor)</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    resampling<span class="op">=</span>rasterio.enums.Resampling.bilinear</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As expected, the dimensions of the disaggregated raster are this time ~5 times <em>bigger</em> than the original ones.</p>
<div id="2cf9fbb4" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>r2.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>(585, 585)</code></pre>
</div>
</div>
<p>To calculate the new transform, we use the same expression as for aggregation, only with the new <code>r2</code> shape.</p>
<div id="1a306f83" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>new_transform2 <span class="op">=</span> src.transform <span class="op">*</span> src.transform.scale(</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    (src.width <span class="op">/</span> r2.shape[<span class="dv">1</span>]),</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    (src.height <span class="op">/</span> r2.shape[<span class="dv">0</span>])</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>new_transform2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>Affine(6.169999999999921, 0.0, 794599.1076146346,
       0.0, -6.169999999998726, 8935384.324602526)</code></pre>
</div>
</div>
<p>The original raster <code>dem.tif</code> was already quite detailed, so it would be difficult to see any difference when plotting it along with the disaggregation result. A zoom-in of a small section of the rasters works better. <a href="#fig-raster-disaggregate" class="quarto-xref">Figure&nbsp;<span>4.34</span></a> shows the top-left corners of the original raster and the disaggregated one, demonstrating the increase in the number of pixels through disaggregation.</p>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(src.read(<span class="dv">1</span>)[:<span class="dv">5</span>, :<span class="dv">5</span>], transform<span class="op">=</span>src.transform)<span class="op">;</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(r2[:<span class="dv">25</span>, :<span class="dv">25</span>], transform<span class="op">=</span>new_transform2)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-raster-disaggregate" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raster-disaggregate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-disaggregate" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-raster-disaggregate-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-disaggregate-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-raster-disaggregate-output-1.png" data-ref-parent="fig-raster-disaggregate" width="424" height="425" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-disaggregate-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Original
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-disaggregate" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-raster-disaggregate-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-disaggregate-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-raster-disaggregate-output-2.png" data-ref-parent="fig-raster-disaggregate" width="424" height="425" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-disaggregate-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Disaggregated (using bilinear resampling)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raster-disaggregate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.34: Disaggregating a raster by a factor of 5, using bilinear tresampling. Only a small portion (top-left corner) of the rasters is shown, to zoom-in and demonstrate the effect of disaggregation.
</figcaption>
</figure>
</div>
<p>Code to export the disaggregated raster would be identical to the one used above for the aggregated raster.</p>
</section>
<section id="sec-raster-resampling" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="sec-raster-resampling"><span class="header-section-number">4.3.3</span> Resampling</h3>
<p>Raster aggregation and disaggregation (<a href="#sec-raster-agg-disagg" class="quarto-xref"><span>Section 4.3.2</span></a>) are only suitable when we want to change just the resolution of our raster by a fixed factor. However, what to do when we have two or more rasters with different resolutions and origins? This is the role of resampling—a process of computing values for new pixel locations. In short, this process takes the values of our original raster and recalculates new values for a target raster with custom resolution and origin (<a href="#fig-raster-resample" class="quarto-xref">Figure&nbsp;<span>4.35</span></a>).</p>
<p>There are several methods for estimating values for a raster with different resolutions/origins (<a href="#fig-raster-resample" class="quarto-xref">Figure&nbsp;<span>4.35</span></a>). The main resampling methods include:</p>
<ul>
<li>Nearest neighbor—assigns the value of the nearest cell of the original raster to the cell of the target one. This is a fast simple technique that is usually suitable for resampling categorical rasters</li>
<li>Bilinear interpolation—assigns a weighted average of the four nearest cells from the original raster to the cell of the target one. This is the fastest method that is appropriate for continuous rasters</li>
<li>Cubic interpolation—uses values of the 16 nearest cells of the original raster to determine the output cell value, applying third-order polynomial functions. Used for continuous rasters and results in a smoother surface compared to bilinear interpolation, but is computationally more demanding</li>
<li>Cubic spline interpolation—also uses values of the 16 nearest cells of the original raster to determine the output cell value, but applies cubic splines (piecewise third-order polynomial functions). Used for continuous rasters</li>
<li>Lanczos windowed sinc resampling—uses values of the 36 nearest cells of the original raster to determine the output cell value. Used for continuous rasters</li>
<li>Additionally, we can use straightforward summary methods, taking into account all pixels that coincide with the target pixel, such as average (<a href="#fig-raster-aggregate" class="quarto-xref">Figure&nbsp;<span>4.33</span></a>), minimum, maximum (<a href="#fig-raster-resample" class="quarto-xref">Figure&nbsp;<span>4.35</span></a>), median, mode, and sum</li>
</ul>
<p>The above explanation highlights that only nearest neighbor resampling is suitable for categorical rasters, while all remaining methods can be used (with different outcomes) for continuous rasters.</p>
<p>With <strong>rasterio</strong>, resampling can be done using the <code>rasterio.warp.reproject</code> function. To clarify this naming convention, note that raster <em>reprojection</em> is not fundamentally different from <em>resampling</em>—the difference is just whether the target grid is in the same CRS as the origin (resampling) or in a different CRS (reprojection). In other words, reprojection is <em>resampling</em> into a grid that is in a different CRS. Accordingly, both resampling and reprojection are done using the same function <code>rasterio.warp.reproject</code>. We will demonstrate <em>reprojection</em> using <code>rasterio.warp.reproject</code> later in <a href="06-reproj.html#sec-reprojecting-raster-geometries" class="quarto-xref"><span>Section 6.8</span></a>.</p>
<p>The information required for <code>rasterio.warp.reproject</code>, whether we are resampling or reprojecting, is:</p>
<ul>
<li>The source and target <em>CRS</em>. These may be identical, when resampling, or different, when reprojecting</li>
<li>The source and target <em>transform</em></li>
</ul>
<p>Importantly, <code>rasterio.warp.reproject</code> can work with file connections, such as a connection to an output file in write (<code>'w'</code>) mode. This makes the function efficient for large rasters.</p>
<p>The target and destination CRS are straightforward to specify, depending on our choice. The source transform is also readily available, through the <code>.transform</code> property of the source file connection. The only complicated part is to figure out the <em>destination transform</em>. When resampling, the transform is typically derived either from a <em>template</em> raster, such as an existing raster file that we would like our origin raster to match, or from a numeric specification of our target grid (see below). Otherwise, when the exact grid is not of importance, we can simply aggregate or disaggregate our raster as shown above (<a href="#sec-raster-agg-disagg" class="quarto-xref"><span>Section 4.3.2</span></a>). (Note that when <em>reprojecting</em>, the target transform is more difficult to figure out, therefore we further use the <code>rasterio.warp.calculate_default_transform</code> function to compute it, as will be shown in <a href="06-reproj.html#sec-reprojecting-raster-geometries" class="quarto-xref"><span>Section 6.8</span></a>.)</p>
<p>Finally, the resampling method is specified through the <code>resampling</code> parameter of <code>rasterio.warp.reproject</code>. The default is nearest neighbor resampling. However, as mentioned above, you should be aware of the distinction between resampling methods, and choose the appropriate one according to the data type (continuous/categorical), the input and output resolution, and resampling purposes. Possible arguments for <code>resampling</code> include:</p>
<ul>
<li><code>rasterio.enums.Resampling.nearest</code>—Nearest neighbor</li>
<li><code>rasterio.enums.Resampling.bilinear</code>—Bilinear</li>
<li><code>rasterio.enums.Resampling.cubic</code>—Cubic</li>
<li><code>rasterio.enums.Resampling.lanczos</code>—Lanczos windowed</li>
<li><code>rasterio.enums.Resampling.average</code>—Average</li>
<li><code>rasterio.enums.Resampling.mode</code>—Mode. i.e., most common value</li>
<li><code>rasterio.enums.Resampling.min</code>—Minimum</li>
<li><code>rasterio.enums.Resampling.max</code>—Maximum</li>
<li><code>rasterio.enums.Resampling.med</code>—Median</li>
<li><code>rasterio.enums.Resampling.sum</code>—Sum</li>
</ul>
<p>Let’s demonstrate resampling into a destination grid which is specified through numeric constraints, such as the extent and resolution. Again, these could have been specified manually (such as here), or obtained from a template raster metadata that we would like to match. Note that the resolution of the destination grid is ~10 times more coarse (300 <span class="math inline">\(m\)</span>) than the original resolution of <code>dem.tif</code> (~30 <span class="math inline">\(m\)</span>) (<a href="#fig-raster-resample" class="quarto-xref">Figure&nbsp;<span>4.35</span></a>).</p>
<div id="b24f6706" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>xmin <span class="op">=</span> <span class="dv">794650</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>xmax <span class="op">=</span> <span class="dv">798250</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>ymin <span class="op">=</span> <span class="dv">8931750</span> </span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>ymax <span class="op">=</span> <span class="dv">8935350</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="dv">300</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The corresponding transform based on these constraints can be created using the <code>rasterio.transform.from_origin</code> function, as follows:</p>
<div id="115d72d4" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>dst_transform <span class="op">=</span> rasterio.transform.from_origin(</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    west<span class="op">=</span>xmin, </span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    north<span class="op">=</span>ymax, </span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>    xsize<span class="op">=</span>res, </span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    ysize<span class="op">=</span>res</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>dst_transform</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>Affine(300.0, 0.0, 794650.0,
       0.0, -300.0, 8935350.0)</code></pre>
</div>
</div>
<p>In case we needed to resample into a grid specified by an existing template raster, we could have skipped this step and simply read the transform from the template file, as in <code>rasterio.open('template.tif').transform</code>.</p>
<p>We can move on to creating the destination file connection. For that, we also have to know the raster dimensions, which can be derived from the extent and the resolution.</p>
<div id="96b6087d" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="bu">int</span>((xmax <span class="op">-</span> xmin) <span class="op">/</span> res)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>height <span class="op">=</span> <span class="bu">int</span>((ymax <span class="op">-</span> ymin) <span class="op">/</span> res)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>width, height</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>(12, 12)</code></pre>
</div>
</div>
<p>Now we can create the destination file connection. We are using the same metadata as the source file, except for the dimensions and the transform, which are going to be different and reflect the resampling process.</p>
<div id="be5b6d36" class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>dst_kwargs <span class="op">=</span> src.meta.copy()</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>dst_kwargs.update({</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'transform'</span>: dst_transform,</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'width'</span>: width,</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'height'</span>: height</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>dst <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'output/dem_resample_nearest.tif'</span>, <span class="st">'w'</span>, <span class="op">**</span>dst_kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we reproject using function <code>rasterio.warp.reproject</code>. Note that the source and destination are specified using <code>rasterio.band</code> applied on both file connections, reflecting the fact that we operate on a specific layer of the rasters. The resampling method being used here is nearest neighbor resampling (<code>rasterio.enums.Resampling.nearest</code>).</p>
<div id="52be69e9" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>rasterio.warp.reproject(</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>    source<span class="op">=</span>rasterio.band(src, <span class="dv">1</span>),</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    destination<span class="op">=</span>rasterio.band(dst, <span class="dv">1</span>),</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    src_transform<span class="op">=</span>src.transform,</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    src_crs<span class="op">=</span>src.crs,</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>    dst_transform<span class="op">=</span>dst_transform,</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>    dst_crs<span class="op">=</span>src.crs,</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>    resampling<span class="op">=</span>rasterio.enums.Resampling.nearest</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>(Band(ds=&lt;open DatasetWriter name='output/dem_resample_nearest.tif' mode='w'&gt;, bidx=1, dtype='float32', shape=(12, 12)),
 Affine(300.0, 0.0, 794650.0,
        0.0, -300.0, 8935350.0))</code></pre>
</div>
</div>
<p>In the end, we close the file connection, thus finalizing the new file <code>output/dem_resample_nearest.tif</code> with the resampling result (<a href="#fig-raster-resample" class="quarto-xref">Figure&nbsp;<span>4.35</span></a>).</p>
<div id="e1b0cb5f" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>dst.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is another code section just to demonstrate a different resampling method, the maximum resampling, i.e., every new pixel gets the maximum value of all the original pixels it coincides with (<a href="#fig-raster-resample" class="quarto-xref">Figure&nbsp;<span>4.35</span></a>). Note that all arguments in the <code>rasterio.warp.reproject</code> function call are identical to the previous example, except for the <code>resampling</code> method.</p>
<div id="0170fa0a" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>dst <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'output/dem_resample_maximum.tif'</span>, <span class="st">'w'</span>, <span class="op">**</span>dst_kwargs)</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>rasterio.warp.reproject(</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    source<span class="op">=</span>rasterio.band(src, <span class="dv">1</span>),</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    destination<span class="op">=</span>rasterio.band(dst, <span class="dv">1</span>),</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    src_transform<span class="op">=</span>src.transform,</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    src_crs<span class="op">=</span>src.crs,</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>    dst_transform<span class="op">=</span>dst_transform,</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>    dst_crs<span class="op">=</span>src.crs,</span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>    resampling<span class="op">=</span>rasterio.enums.Resampling.<span class="bu">max</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>dst.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The original raster <code>dem.tif</code>, and the two resampling results <code>dem_resample_nearest.tif</code> and <code>dem_resample_maximum.tif</code>, are shown in <a href="#fig-raster-resample" class="quarto-xref">Figure&nbsp;<span>4.35</span></a>.</p>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Input</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>,<span class="dv">4</span>))</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(src, ax<span class="op">=</span>ax)<span class="op">;</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Nearest neighbor</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>,<span class="dv">4</span>))</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(rasterio.<span class="bu">open</span>(<span class="st">'output/dem_resample_nearest.tif'</span>), ax<span class="op">=</span>ax)<span class="op">;</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Maximum</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>,<span class="dv">4</span>))</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(rasterio.<span class="bu">open</span>(<span class="st">'output/dem_resample_maximum.tif'</span>), ax<span class="op">=</span>ax)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-raster-resample" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raster-resample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-resample" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-resample-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-resample-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-raster-resample-output-1.png" data-ref-parent="fig-raster-resample" width="379" height="351" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-resample-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Input
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-resample" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-resample-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-resample-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-raster-resample-output-2.png" data-ref-parent="fig-raster-resample" width="376" height="351" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-resample-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Nearest neighbor
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-resample" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-resample-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-resample-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="04-geometry-operations_files/figure-html/fig-raster-resample-output-3.png" data-ref-parent="fig-raster-resample" width="376" height="351" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-resample-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) Maximum
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raster-resample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.35: The original raster <code>dem.tif</code> and two different resampling method results
</figcaption>
</figure>
</div>
<!-- ## Exercises -->


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-douglas_algorithms_1973" class="csl-entry" role="listitem">
Douglas, David H, and Thomas K Peucker. 1973. <span>“Algorithms for the Reduction of the Number of Points Required to Represent a Digitized Line or Its Caricature.”</span> <em>Cartographica: The International Journal for Geographic Information and Geovisualization</em> 10 (2): 112–22. <a href="https://doi.org/bjwv52">https://doi.org/bjwv52</a>.
</div>
<div id="ref-liu_essential_2009" class="csl-entry" role="listitem">
Liu, Jian-Guo, and Philippa J. Mason. 2009. <em>Essential Image Processing and <span>GIS</span> for Remote Sensing</em>. <span>Chichester, West Sussex, UK, Hoboken, NJ</span>: <span>Wiley-Blackwell</span>.
</div>
</div>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p><a href="https://geopandas.org/en/stable/docs/user_guide/set_operations.html">https://geopandas.org/en/stable/docs/user_guide/set_operations.html</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/py\.geocompx\.org");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03-spatial-operations.html" class="pagination-link" aria-label="Spatial data operations">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial data operations</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./05-raster-vector.html" class="pagination-link" aria-label="Raster-vector interactions">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Raster-vector interactions</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Geocomputation with Python was written by Michael Dorman, Anita Graser, Jakub Nowosad, and Robin Lovelace.</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/geocompx/geocompy/edit/main/04-geometry-operations.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>