<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.54">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="An introductory resource for working with geographic data in Python">

<title>3&nbsp; Spatial data operations – Geocomputation with Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./04-geometry-operations.html" rel="next">
<link href="./02-attribute-operations.html" rel="prev">
<link href="./favicon-32x32.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZEMGTY4VV3"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZEMGTY4VV3', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="helpers/mystyle.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-spatial-operations.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial data operations</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Geocomputation with Python</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/geocompx/geocompy/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-spatial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Geographic data in Python</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-attribute-operations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Attribute data operations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-spatial-operations.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial data operations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-geometry-operations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geometry operations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-raster-vector.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Raster-vector interactions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-reproj.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Reprojecting geographic data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-read-write.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Geographic data I/O</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-mapping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Making maps with Python</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
  <h2 class="anchored">First Edition</h2>
  <ul>
    <li><a href="https://geocompx.org/" class="nav-link active" data-scroll-target="https\://geocompx.org/">Visit the geocompx website 🌐</a></li>
    <li><a href="https://github.com/geocompx/geocompy/issues" class="nav-link" data-scroll-target="https\://github.com/geocompx/geocompy/issues">Open an issue ❔</a></li>
    <li><a href="https://discord.gg/PMztXYgNxp" class="nav-link" data-scroll-target="https\://discord.gg/PMztXYgNxp">Chat on Discord 📣</a></li>
    <li><a href="https://donate.stripe.com/4gweWl94Q9E35AQ6oo" class="nav-link" data-scroll-target="https\://donate.stripe.com/4gweWl94Q9E35AQ6oo">Support this project 💸</a></li>
  </ul>
  <hr>
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">3.1</span> Introduction</a></li>
  <li><a href="#sec-spatial-vec" id="toc-sec-spatial-vec" class="nav-link" data-scroll-target="#sec-spatial-vec"><span class="header-section-number">3.2</span> Spatial operations on vector data</a>
  <ul>
  <li><a href="#sec-spatial-subsetting-vector" id="toc-sec-spatial-subsetting-vector" class="nav-link" data-scroll-target="#sec-spatial-subsetting-vector"><span class="header-section-number">3.2.1</span> Spatial subsetting</a></li>
  <li><a href="#sec-topological-relations" id="toc-sec-topological-relations" class="nav-link" data-scroll-target="#sec-topological-relations"><span class="header-section-number">3.2.2</span> Topological relations</a></li>
  <li><a href="#sec-spatial-joining" id="toc-sec-spatial-joining" class="nav-link" data-scroll-target="#sec-spatial-joining"><span class="header-section-number">3.2.3</span> Spatial joining</a></li>
  <li><a href="#non-overlapping-joins" id="toc-non-overlapping-joins" class="nav-link" data-scroll-target="#non-overlapping-joins"><span class="header-section-number">3.2.4</span> Non-overlapping joins</a></li>
  <li><a href="#sec-vector-spatial-aggregation" id="toc-sec-vector-spatial-aggregation" class="nav-link" data-scroll-target="#sec-vector-spatial-aggregation"><span class="header-section-number">3.2.5</span> Spatial aggregation</a></li>
  <li><a href="#sec-joining-incongruent-layers" id="toc-sec-joining-incongruent-layers" class="nav-link" data-scroll-target="#sec-joining-incongruent-layers"><span class="header-section-number">3.2.6</span> Joining incongruent layers</a></li>
  <li><a href="#sec-distance-relations" id="toc-sec-distance-relations" class="nav-link" data-scroll-target="#sec-distance-relations"><span class="header-section-number">3.2.7</span> Distance relations</a></li>
  </ul></li>
  <li><a href="#sec-spatial-ras" id="toc-sec-spatial-ras" class="nav-link" data-scroll-target="#sec-spatial-ras"><span class="header-section-number">3.3</span> Spatial operations on raster data</a>
  <ul>
  <li><a href="#sec-spatial-subsetting-raster" id="toc-sec-spatial-subsetting-raster" class="nav-link" data-scroll-target="#sec-spatial-subsetting-raster"><span class="header-section-number">3.3.1</span> Spatial subsetting</a></li>
  <li><a href="#sec-map-algebra" id="toc-sec-map-algebra" class="nav-link" data-scroll-target="#sec-map-algebra"><span class="header-section-number">3.3.2</span> Map algebra</a></li>
  <li><a href="#sec-raster-local-operations" id="toc-sec-raster-local-operations" class="nav-link" data-scroll-target="#sec-raster-local-operations"><span class="header-section-number">3.3.3</span> Local operations</a></li>
  <li><a href="#sec-focal-operations" id="toc-sec-focal-operations" class="nav-link" data-scroll-target="#sec-focal-operations"><span class="header-section-number">3.3.4</span> Focal operations</a></li>
  <li><a href="#sec-zonal-operations" id="toc-sec-zonal-operations" class="nav-link" data-scroll-target="#sec-zonal-operations"><span class="header-section-number">3.3.5</span> Zonal operations</a></li>
  <li><a href="#sec-global-operations-and-distances" id="toc-sec-global-operations-and-distances" class="nav-link" data-scroll-target="#sec-global-operations-and-distances"><span class="header-section-number">3.3.6</span> Global operations and distances</a></li>
  <li><a href="#map-algebra-counterparts-in-vector-processing" id="toc-map-algebra-counterparts-in-vector-processing" class="nav-link" data-scroll-target="#map-algebra-counterparts-in-vector-processing"><span class="header-section-number">3.3.7</span> Map algebra counterparts in vector processing</a></li>
  <li><a href="#sec-merging-rasters" id="toc-sec-merging-rasters" class="nav-link" data-scroll-target="#sec-merging-rasters"><span class="header-section-number">3.3.8</span> Merging rasters</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/geocompx/geocompy/edit/main/03-spatial-operations.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-spatial-operations" class="quarto-section-identifier"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial data operations</span></span></h1>
</div>

<!--
-->


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="prerequisites" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>This chapter requires importing the following packages:</p>
<div id="f738d329" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.ndimage</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.stats</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shapely</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio.plot</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio.merge</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio.features</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It also relies on the following data files:</p>
<div id="877a2a01" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>nz <span class="op">=</span> gpd.read_file(<span class="st">'data/nz.gpkg'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>nz_height <span class="op">=</span> gpd.read_file(<span class="st">'data/nz_height.gpkg'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>world <span class="op">=</span> gpd.read_file(<span class="st">'data/world.gpkg'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>cycle_hire <span class="op">=</span> gpd.read_file(<span class="st">'data/cycle_hire.gpkg'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>cycle_hire_osm <span class="op">=</span> gpd.read_file(<span class="st">'data/cycle_hire_osm.gpkg'</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>src_elev <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'output/elev.tif'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>src_landsat <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'data/landsat.tif'</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>src_grain <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'output/grain.tif'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="introduction" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">3.1</span> Introduction</h2>
<p>Spatial operations, including spatial joins between vector datasets and local and focal operations on raster datasets, are a vital part of geocomputation. This chapter shows how spatial objects can be modified in a multitude of ways based on their location and shape. Many spatial operations have a non-spatial (attribute) equivalent, so concepts such as subsetting and joining datasets demonstrated in the previous chapter are applicable here. This is especially true for vector operations: <a href="02-attribute-operations.html#sec-vector-attribute-manipulation" class="quarto-xref"><span>Section 2.2</span></a> on vector attribute manipulation provides the basis for understanding its spatial counterpart, namely spatial subsetting (covered in <a href="#sec-spatial-subsetting-vector" class="quarto-xref"><span>Section 3.2.1</span></a>). Spatial joining (<a href="#sec-spatial-joining" class="quarto-xref"><span>Section 3.2.3</span></a>) and aggregation (<a href="#sec-vector-spatial-aggregation" class="quarto-xref"><span>Section 3.2.5</span></a>) also have non-spatial counterparts, covered in the previous chapter.</p>
<p>Spatial operations differ from non-spatial operations in a number of ways, however. Spatial joins, for example, can be done in a number of ways—including matching entities that intersect with or are within a certain distance of the target dataset—while the attribution joins discussed in <a href="02-attribute-operations.html#sec-vector-attribute-joining" class="quarto-xref"><span>Section 2.2.3</span></a> in the previous chapter can only be done in one way. Different types of spatial relationships between objects, including intersects and disjoints, are described in <a href="#sec-topological-relations" class="quarto-xref"><span>Section 3.2.2</span></a>. Another unique aspect of spatial objects is distance: all spatial objects are related through space, and distance calculations can be used to explore the strength of this relationship, as described in the context of vector data in <a href="#sec-distance-relations" class="quarto-xref"><span>Section 3.2.7</span></a>.</p>
<p>Spatial operations on raster objects include subsetting—covered in <a href="#sec-spatial-subsetting-raster" class="quarto-xref"><span>Section 3.3.1</span></a>—and merging several raster ‘tiles’ into a single object, as demonstrated in <a href="#sec-merging-rasters" class="quarto-xref"><span>Section 3.3.8</span></a>. Map algebra covers a range of operations that modify raster cell values, with or without reference to surrounding cell values. The concept of map algebra, vital for many applications, is introduced in <a href="#sec-map-algebra" class="quarto-xref"><span>Section 3.3.2</span></a>; local, focal, and zonal map algebra operations are covered in <a href="#sec-raster-local-operations" class="quarto-xref"><span>Section 3.3.3</span></a>, <a href="#sec-focal-operations" class="quarto-xref"><span>Section 3.3.4</span></a>, and <a href="#sec-zonal-operations" class="quarto-xref"><span>Section 3.3.5</span></a>, respectively. Global map algebra operations, which generate summary statistics representing an entire raster dataset, and distance calculations on rasters, are discussed in Section <a href="#sec-global-operations-and-distances" class="quarto-xref"><span>Section 3.3.6</span></a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is important to note that spatial operations that use two spatial objects rely on both objects having the same coordinate reference system, a topic that was introduced in <a href="01-spatial-data.html#sec-coordinate-reference-systems-intro" class="quarto-xref"><span>Section 1.4</span></a> and which will be covered in more depth in <a href="06-reproj.html" class="quarto-xref"><span>Chapter 6</span></a>.</p>
</div>
</div>
</section>
<section id="sec-spatial-vec" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="sec-spatial-vec"><span class="header-section-number">3.2</span> Spatial operations on vector data</h2>
<p>This section provides an overview of spatial operations on vector geographic data represented as Simple Features using the <strong>shapely</strong> and <strong>geopandas</strong> packages. <a href="#sec-spatial-ras" class="quarto-xref"><span>Section 3.3</span></a> then presents spatial operations on raster datasets, using the <strong>rasterio</strong> and <strong>scipy</strong> packages.</p>
<section id="sec-spatial-subsetting-vector" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="sec-spatial-subsetting-vector"><span class="header-section-number">3.2.1</span> Spatial subsetting</h3>
<!-- jn: have we considered switching the order of spatial subsetting with topological relations? -->
<!-- md: I don't think we considered it yet (the order as the moment is the same as in 'geocompr') -->
<p>Spatial subsetting is the process of taking a spatial object and returning a new object containing only features that relate in space to another object. Analogous to attribute subsetting (covered in <a href="02-attribute-operations.html#sec-vector-attribute-subsetting" class="quarto-xref"><span>Section 2.2.1</span></a>), subsets of <code>GeoDataFrame</code>s can be created with square bracket (<code>[</code>) operator using the syntax <code>x[y]</code>, where <code>x</code> is an <code>GeoDataFrame</code> from which a subset of rows/features will be returned, and <code>y</code> is a boolean <code>Series</code>. The difference is, that, in spatial subsetting <code>y</code> is created based on another geometry and using one of the binary geometry relation methods, such as <code>.intersects</code> (see <a href="#sec-topological-relations" class="quarto-xref"><span>Section 3.2.2</span></a>), rather than based on comparison based on ordinary columns.</p>
<p>To demonstrate spatial subsetting, we will use the <code>nz</code> and <code>nz_height</code> layers, which contain geographic data on the 16 main regions and 101 highest points in New Zealand, respectively (<a href="#fig-spatial-subset" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> (a)), in a projected coordinate system. The following expression creates a new object, <code>canterbury</code>, representing only one region—Canterbury.</p>
<div id="4b3fbccf" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>canterbury <span class="op">=</span> nz[nz[<span class="st">'Name'</span>] <span class="op">==</span> <span class="st">'Canterbury'</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>canterbury</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Island</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Sex_ratio</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Canterbury</td>
<td>South</td>
<td>...</td>
<td>0.975327</td>
<td>MULTIPOLYGON (((1686901.914 535...</td>
</tr>
</tbody>
</table>

<p>1 rows × 7 columns</p>
</div>
</div>
</div>
<p>Then, we use the <code>.intersects</code> method to evaluate, for each of the <code>nz_height</code> points, whether they intersect with Canterbury. The result <code>canterbury_height</code> is a boolean <code>Series</code> with the ‘answers’.</p>
<div id="cfd43274" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>sel <span class="op">=</span> nz_height.intersects(canterbury.geometry.iloc[<span class="dv">0</span>])</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>sel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>0      False
1      False
2      False
       ...  
98     False
99     False
100    False
Length: 101, dtype: bool</code></pre>
</div>
</div>
<p>Finally, we can subset <code>nz_height</code> using the obtained <code>Series</code>, resulting in the subset <code>canterbury_height</code> with only those points that intersect with Canterbury.</p>
<div id="a23b2d31" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>canterbury_height <span class="op">=</span> nz_height[sel]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>canterbury_height</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">t50_fid</th>
<th data-quarto-table-cell-role="th">elevation</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2362630</td>
<td>2749</td>
<td>POINT (1378169.6 5158491.453)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2362814</td>
<td>2822</td>
<td>POINT (1389460.041 5168749.086)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2362817</td>
<td>2778</td>
<td>POINT (1390166.225 5169466.158)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92</td>
<td>2380298</td>
<td>2877</td>
<td>POINT (1652788.127 5348984.469)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">93</td>
<td>2380300</td>
<td>2711</td>
<td>POINT (1654213.379 5349962.973)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">94</td>
<td>2380308</td>
<td>2885</td>
<td>POINT (1654898.622 5350462.779)</td>
</tr>
</tbody>
</table>

<p>70 rows × 3 columns</p>
</div>
</div>
</div>
<p><a href="#fig-spatial-subset" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> compares the original <code>nz_height</code> layer (left) with the subset <code>canterbury_height</code> (right). <!-- jn: do we need to repeat the `base = nz.plot(color='white', edgecolor='lightgrey')` code here? --> <!-- md: The expression to create 'base' has to be repeated. can't say I completely understand the mechanism, but I think that once a 'matplotlib' plot is drawn, the plot objects are emptied, so we have to re-create them when making a new plot. maybe there is a solution to it that I missed, but currently we're creating each plot intependently like in the code below. --></p>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> nz.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>nz_height.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'None'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>)<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset (intersects)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> nz.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>canterbury.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>canterbury_height.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'None'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-spatial-subset" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-spatial-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-spatial-subset" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-spatial-subset-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-spatial-subset-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-spatial-subset-output-1.png" data-ref-parent="fig-spatial-subset" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-spatial-subset-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Original points (red)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-spatial-subset" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-spatial-subset-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-spatial-subset-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-spatial-subset-output-2.png" data-ref-parent="fig-spatial-subset" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-spatial-subset-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Spatial subset based on intersection (red), geometry used for subsetting (Canterbury) (grey)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spatial-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: Spatial subsetting of points by intersection with polygon
</figcaption>
</figure>
</div>
<p>Like in attribute subsetting (<a href="02-attribute-operations.html#sec-vector-attribute-subsetting" class="quarto-xref"><span>Section 2.2.1</span></a>), we are using a boolean series (<code>sel</code>), of the same length as the number of rows in the filtered table (<code>nz_height</code>), created based on a condition applied on itself. The difference is that the condition is not a comparison of attribute values, but an evaluation of a spatial relation. Namely, we evaluate whether each geometry of <code>nz_height</code> intersects with the <code>canterbury</code> geometry, using the <code>.intersects</code> method.</p>
<p>Various topological relations can be used for spatial subsetting which determine the type of spatial relationship that features in the target object must have with the subsetting object to be selected. These include touches, crosses, or within, as we will see shortly in <a href="#sec-topological-relations" class="quarto-xref"><span>Section 3.2.2</span></a>. Intersects (<code>.intersects</code>), which we used in the last example, is the most commonly used method. This is a ‘catch all’ topological relation, that will return features in the target that touch, cross or are within the source ‘subsetting’ object. As an example of another method, we can use <code>.disjoint</code> to obtain all points that <em>do not</em> intersect with Canterbury.</p>
<div id="4731c1c2" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>sel <span class="op">=</span> nz_height.disjoint(canterbury.geometry.iloc[<span class="dv">0</span>])</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>canterbury_height2 <span class="op">=</span> nz_height[sel]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results are shown in <a href="#fig-spatial-subset-disjoint" class="quarto-xref">Figure&nbsp;<span>3.2</span></a>, which compares the original <code>nz_height</code> layer (left) with the subset <code>canterbury_height2</code> (right).</p>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> nz.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>nz_height.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'None'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>)<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset (disjoint)</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> nz.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>canterbury.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>canterbury_height2.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'None'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-spatial-subset-disjoint" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-spatial-subset-disjoint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-spatial-subset-disjoint" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-spatial-subset-disjoint-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-spatial-subset-disjoint-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-spatial-subset-disjoint-output-1.png" data-ref-parent="fig-spatial-subset-disjoint" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-spatial-subset-disjoint-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Original points (red)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-spatial-subset-disjoint" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-spatial-subset-disjoint-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-spatial-subset-disjoint-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-spatial-subset-disjoint-output-2.png" data-ref-parent="fig-spatial-subset-disjoint" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-spatial-subset-disjoint-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Spatial subset based on disjoint (red), geometry used for subsetting (Canterbury) (grey)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spatial-subset-disjoint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2: Spatial subsetting of points disjoint from a polygon
</figcaption>
</figure>
</div>
<p>In case we need to subset according to several geometries at once, e.g., find out which points intersect with both Canterbury and Southland, we can dissolve the filtering subset, using <code>.union_all</code>, before applying the <code>.intersects</code> (or any other) operator. For example, here is how we can subset the <code>nz_height</code> points which intersect with Canterbury or Southland. (Note that we are also using the <code>.isin</code> method, as demonstrated at the end of <a href="02-attribute-operations.html#sec-vector-attribute-subsetting" class="quarto-xref"><span>Section 2.2.1</span></a>.)</p>
<div id="76799201" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>canterbury_southland <span class="op">=</span> nz[nz[<span class="st">'Name'</span>].isin([<span class="st">'Canterbury'</span>, <span class="st">'Southland'</span>])]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>sel <span class="op">=</span> nz_height.intersects(canterbury_southland.union_all())</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>canterbury_southland_height <span class="op">=</span> nz_height[sel]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>canterbury_southland_height</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">t50_fid</th>
<th data-quarto-table-cell-role="th">elevation</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2353944</td>
<td>2723</td>
<td>POINT (1204142.603 5049971.287)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>2362630</td>
<td>2749</td>
<td>POINT (1378169.6 5158491.453)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>2362814</td>
<td>2822</td>
<td>POINT (1389460.041 5168749.086)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92</td>
<td>2380298</td>
<td>2877</td>
<td>POINT (1652788.127 5348984.469)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">93</td>
<td>2380300</td>
<td>2711</td>
<td>POINT (1654213.379 5349962.973)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">94</td>
<td>2380308</td>
<td>2885</td>
<td>POINT (1654898.622 5350462.779)</td>
</tr>
</tbody>
</table>

<p>71 rows × 3 columns</p>
</div>
</div>
</div>
<p><a href="#fig-spatial-subset2" class="quarto-xref">Figure&nbsp;<span>3.3</span></a> shows the results of the spatial subsetting of <code>nz_height</code> points by intersection with Canterbury and Southland.</p>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> nz.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>nz_height.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'None'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>)<span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset by intersection with two polygons</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> nz.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>canterbury_southland.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'darkgrey'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>canterbury_southland_height.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'None'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-spatial-subset2" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-spatial-subset2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-spatial-subset2" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-spatial-subset2-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-spatial-subset2-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-spatial-subset2-output-1.png" data-ref-parent="fig-spatial-subset2" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-spatial-subset2-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Original points (red)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-spatial-subset2" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-spatial-subset2-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-spatial-subset2-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-spatial-subset2-output-2.png" data-ref-parent="fig-spatial-subset2" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-spatial-subset2-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Spatial subset based on intersection (red), geometry used for subsetting (Canterbury and Southland) (grey)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spatial-subset2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.3: Spatial subsetting of points by intersection with more than one polygon
</figcaption>
</figure>
</div>
<p>The next section further explores different types of spatial relations, also known as binary predicates (of which <code>.intersects</code> and <code>.disjoint</code> are two examples), that can be used to identify whether or not two features are spatially related.</p>
</section>
<section id="sec-topological-relations" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="sec-topological-relations"><span class="header-section-number">3.2.2</span> Topological relations</h3>
<p>Topological relations describe the spatial relationships between objects. ‘Binary topological relationships’, to give them their full name, are logical statements (in that the answer can only be <code>True</code> or <code>False</code>) about the spatial relationships between two objects defined by ordered sets of points (typically forming points, lines, and polygons) in two or more dimensions <span class="citation" data-cites="egenhofer_mathematical_1990">(<a href="references.html#ref-egenhofer_mathematical_1990" role="doc-biblioref">Egenhofer and Herring 1990</a>)</span>. That may sound rather abstract and, indeed, the definition and classification of topological relations is based on mathematical foundations first published in book form in 1966 <span class="citation" data-cites="spanier_algebraic_1995">(<a href="references.html#ref-spanier_algebraic_1995" role="doc-biblioref">Spanier 1995</a>)</span>, with the field of algebraic topology continuing into the 21st century <span class="citation" data-cites="dieck_algebraic_2008">(<a href="references.html#ref-dieck_algebraic_2008" role="doc-biblioref">Dieck 2008</a>)</span>.</p>
<p>Despite their mathematical origins, topological relations can be understood intuitively with reference to visualizations of commonly used functions that test for common types of spatial relationships. <a href="#fig-spatial-relations" class="quarto-xref">Figure&nbsp;<span>3.4</span></a> shows a variety of geometry pairs and their associated relations. The third and fourth pairs in <a href="#fig-spatial-relations" class="quarto-xref">Figure&nbsp;<span>3.4</span></a> (from left to right and then down) demonstrate that, for some relations, order is important: while the relations equals, intersects, crosses, touches and overlaps are symmetrical, meaning that if <code>x.relation(y)</code> is true, <code>y.relation(x)</code> will also be true, relations in which the order of the geometries are important such as contains and within are not.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notice that each geometry pair has a ‘DE-9IM’<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> string such as <code>FF2F11212</code>. DE-9IM strings describe the dimensionality (0=points, 1=lines, 2=polygons) of the pairwise intersections of the interior, boundary, and exterior, of two geometries (i.e., nine values of 0/1/2 encoded into a string). This is an advanced topic beyond the scope of this book, which can be useful to understand the difference between relation types, or define custom types of relations. See the DE-9IM strings section in Geocomputation with R <span class="citation" data-cites="lovelace_geocomputation_2019">(<a href="references.html#ref-lovelace_geocomputation_2019" role="doc-biblioref">Lovelace, Nowosad, and Muenchow 2019</a>)</span>. Also note that the <strong>shapely</strong> package contains the <code>.relate</code> and <code>.relate_pattern</code> methods, to derive and to test for DE-9IM patterns, respectively.</p>
</div>
</div>
<div id="fig-spatial-relations" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-spatial-relations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/relations-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spatial-relations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.4: Topological relations between vector geometries, inspired by Figures 1 and 2 in <span class="citation" data-cites="egenhofer_mathematical_1990">Egenhofer and Herring (<a href="references.html#ref-egenhofer_mathematical_1990" role="doc-biblioref">1990</a>)</span>. The relations for which the <code>x.relation(y)</code> is true are printed for each geometry pair, with <code>x</code> represented in pink and <code>y</code> represented in blue. The nature of the spatial relationship for each pair is described by the Dimensionally Extended 9-Intersection Model string.
</figcaption>
</figure>
</div>
<p>In <strong>shapely</strong>, methods testing for different types of topological relations are known as ‘relationships’. <strong>geopandas</strong> provides their wrappers (with the same method name) which can be applied on multiple geometries at once (such as <code>.intersects</code> and <code>.disjoint</code> applied on all points in <code>nz_height</code>, see <a href="#sec-spatial-subsetting-vector" class="quarto-xref"><span>Section 3.2.1</span></a>). To see how topological relations work in practice, let’s create a simple reproducible example, building on the relations illustrated in <a href="#fig-spatial-relations" class="quarto-xref">Figure&nbsp;<span>3.4</span></a> and consolidating knowledge of how vector geometries are represented from a previous chapter (<a href="01-spatial-data.html#sec-geometry-columns" class="quarto-xref"><span>Section 1.2.3</span></a> and <a href="01-spatial-data.html#sec-geometries" class="quarto-xref"><span>Section 1.2.5</span></a>).</p>
<div id="9fb448dc" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> gpd.GeoSeries([</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  shapely.Point(<span class="fl">0.2</span>,<span class="fl">0.1</span>), </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  shapely.Point(<span class="fl">0.7</span>,<span class="fl">0.2</span>), </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  shapely.Point(<span class="fl">0.4</span>,<span class="fl">0.8</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>line <span class="op">=</span> gpd.GeoSeries([</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  shapely.LineString([(<span class="fl">0.4</span>,<span class="fl">0.2</span>), (<span class="dv">1</span>,<span class="fl">0.5</span>)])</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>poly <span class="op">=</span> gpd.GeoSeries([</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  shapely.Polygon([(<span class="dv">0</span>,<span class="dv">0</span>), (<span class="dv">0</span>,<span class="dv">1</span>), (<span class="dv">1</span>,<span class="dv">1</span>), (<span class="dv">1</span>,<span class="fl">0.5</span>), (<span class="dv">0</span>,<span class="dv">0</span>)])</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The sample dataset which we created is composed of three <code>GeoSeries</code>: named <code>points</code>, <code>line</code>, and <code>poly</code>, which are visualized in <a href="#fig-spatial-relations-geoms" class="quarto-xref">Figure&nbsp;<span>3.5</span></a>. The last expression is a <code>for</code> loop used to add text labels (<code>0</code>, <code>1</code>, and <code>2</code>) to identify the points; we are going to explain the concepts of text annotations with <strong>geopandas</strong> <code>.plot</code> in <a href="08-mapping.html#sec-plot-static-labels" class="quarto-xref"><span>Section 8.2.4</span></a>.</p>
<div id="cell-fig-spatial-relations-geoms" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> poly.plot(color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>line.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>points.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">enumerate</span>(points):</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    base.annotate(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        i[<span class="dv">0</span>], xy<span class="op">=</span>(i[<span class="dv">1</span>].x, i[<span class="dv">1</span>].y), </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        xytext<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>), textcoords<span class="op">=</span><span class="st">'offset points'</span>, weight<span class="op">=</span><span class="st">'bold'</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-spatial-relations-geoms" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-spatial-relations-geoms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-spatial-relations-geoms-output-1.png" width="419" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spatial-relations-geoms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.5: Points (<code>points</code>), line (<code>line</code>), and polygon (<code>poly</code>) objects used to illustrate topological relations
</figcaption>
</figure>
</div>
</div>
</div>
<p>A simple query is: which of the points in <code>points</code> intersect in some way with polygon <code>poly</code>? The question can be answered by visual inspection (points <code>0</code> and <code>2</code> are touching and are within the polygon, respectively). Alternatively, we can get the solution with the <code>.intersects</code> method, which reports whether or not each geometry in a <code>GeoSeries</code> (<code>points</code>) intersects with a single <code>shapely</code> geometry (<code>poly.iloc[0]</code>).</p>
<div id="7962d2d6" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>points.intersects(poly.iloc[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>0     True
1    False
2     True
dtype: bool</code></pre>
</div>
</div>
<p>The result shown above is a boolean <code>Series</code>. Its contents should match our intuition: positive (<code>True</code>) results are returned for the points <code>0</code> and <code>2</code>, and a negative result (<code>False</code>) for point <code>1</code>. Each value in this <code>Series</code> represents a feature in the first input (<code>points</code>).</p>
<p>All earlier examples in this chapter demonstrate the ‘many-to-one’ mode of <code>.intersects</code> and analogous methods, where the relation is evaluated between each of several geometries in a <code>GeoSeries</code>/<code>GeoDataFrame</code>, and an individual <code>shapely</code> geometry. A second mode of those methods (not demonstrated here) is when both inputs are <code>GeoSeries</code>/<code>GeoDataFrame</code> objects. In such case, a ‘pairwise’ evaluation takes place between geometries aligned by index (<code>align=True</code>, the default) or by position (<code>align=False</code>). For example, the expression <code>nz.intersects(nz)</code> returns a <code>Series</code> of 16 <code>True</code> values, indicating (unsurprisingly) that each geometry in <code>nz</code> intersects with itself.</p>
<p>A third mode is when we are interested in a ‘many-to-many’ evaluation, i.e., obtaining a matrix of all pairwise combinations of geometries from two <code>GeoSeries</code> objects. At the time of writing, there is no built-in method to do this in <strong>geopandas</strong>. However, the <code>.apply</code> method (package <strong>pandas</strong>) can be used to repeat a ‘many-to-one’ evaluation over all geometries in the second layer, resulting in a matrix of <em>pairwise</em> results. We will create another <code>GeoSeries</code> with two polygons, named <code>poly2</code>, to demonstrate this.</p>
<div id="38a3284f" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>poly2 <span class="op">=</span> gpd.GeoSeries([</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  shapely.Polygon([(<span class="dv">0</span>,<span class="dv">0</span>), (<span class="dv">0</span>,<span class="dv">1</span>), (<span class="dv">1</span>,<span class="dv">1</span>), (<span class="dv">1</span>,<span class="fl">0.5</span>), (<span class="dv">0</span>,<span class="dv">0</span>)]),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  shapely.Polygon([(<span class="dv">0</span>,<span class="dv">0</span>), (<span class="dv">1</span>,<span class="fl">0.5</span>), (<span class="dv">1</span>,<span class="dv">0</span>), (<span class="dv">0</span>,<span class="dv">0</span>)])</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our two input objects, <code>points</code> and <code>poly2</code>, are illustrated in <a href="#fig-spatial-relations-geoms2" class="quarto-xref">Figure&nbsp;<span>3.6</span></a>.</p>
<div id="cell-fig-spatial-relations-geoms2" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> poly2.plot(color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>points.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">enumerate</span>(points):</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    base.annotate(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        i[<span class="dv">0</span>], xy<span class="op">=</span>(i[<span class="dv">1</span>].x, i[<span class="dv">1</span>].y), </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        xytext<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>), textcoords<span class="op">=</span><span class="st">'offset points'</span>, weight<span class="op">=</span><span class="st">'bold'</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-spatial-relations-geoms2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-spatial-relations-geoms2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-spatial-relations-geoms2-output-1.png" width="419" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spatial-relations-geoms2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.6: Inputs for demonstrating the evaluation of all pairwise intersection relations between three points (<code>points</code>) and two polygons (<code>poly2</code>)
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now we can use <code>.apply</code> to get the intersection relations matrix. The result is a <code>DataFrame</code>, where each row represents a <code>points</code> geometry and each column represents a <code>poly2</code> geometry. We can see that the point <code>0</code> intersects with both polygons, while points <code>1</code> and <code>2</code> intersect with one of the polygons each.</p>
<div id="076a15f3" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>points.<span class="bu">apply</span>(<span class="kw">lambda</span> x: poly2.intersects(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>True</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>False</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>True</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>.apply</code> method (package <strong>pandas</strong>) is used to apply a function along one of the axes of a <code>DataFrame</code> (or <code>GeoDataFrame</code>). That is, we can apply a function on all rows (<code>axis=1</code>) or all columns (<code>axis=0</code>, the default). When the function being applied returns a single value, the output of <code>.apply</code> is a <code>Series</code> (e.g., <code>.apply(len)</code> returns the lengths of all columns, because <code>len</code> returns a single value). When the function returns a <code>Series</code>, then <code>.apply</code> returns a <code>DataFrame</code> (such as in the above example.)</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Since the above result, like any pairwise matrix, (1) is composed of values of the same type, and (2) has no contrasting role for rows and columns, is may be more convenient to use a plain <strong>numpy</strong> array to work with it. In such case, we can use the <code>.to_numpy</code> method to go from <code>DataFrame</code> to <code>ndarray</code>.</p>
<div id="798effa5" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>points.<span class="bu">apply</span>(<span class="kw">lambda</span> x: poly2.intersects(x)).to_numpy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>array([[ True,  True],
       [False,  True],
       [ True, False]])</code></pre>
</div>
</div>
</div>
</div>
<p>The <code>.intersects</code> method returns <code>True</code> even in cases where the features just touch: intersects is a ‘catch-all’ topological operation which identifies many types of spatial relations, as illustrated in <a href="#fig-spatial-relations" class="quarto-xref">Figure&nbsp;<span>3.4</span></a>. More restrictive questions include which points lie within the polygon, and which features are on or contain a shared boundary with it? The first question can be answered with <code>.within</code>, and the second with <code>.touches</code>.</p>
<div id="9079486f" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>points.within(poly.iloc[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>0    False
1    False
2     True
dtype: bool</code></pre>
</div>
</div>
<div id="e85866aa" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>points.touches(poly.iloc[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>0     True
1    False
2    False
dtype: bool</code></pre>
</div>
</div>
<p>Note that although the point <code>0</code> touches the boundary polygon, it is not within it; point <code>2</code> is within the polygon but does not touch any part of its border. The opposite of <code>.intersects</code> is <code>.disjoint</code>, which returns only objects that do not spatially relate in any way to the selecting object.</p>
<div id="b9042223" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>points.disjoint(poly.iloc[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>0    False
1     True
2    False
dtype: bool</code></pre>
</div>
</div>
<p>Another useful type of relation is ‘within distance’, where we detect features that intersect with the target buffered by particular distance. Buffer distance determines how close target objects need to be before they are selected. This can be done by literally buffering (<a href="01-spatial-data.html#sec-geometries" class="quarto-xref"><span>Section 1.2.5</span></a>) the target geometry, and evaluating intersection (<code>.intersects</code>). Another way is to calculate the distances using the <code>.distance</code> method, and then evaluate whether they are within a threshold distance.</p>
<div id="66610826" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>points.distance(poly.iloc[<span class="dv">0</span>]) <span class="op">&lt;</span> <span class="fl">0.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>0    True
1    True
2    True
dtype: bool</code></pre>
</div>
</div>
<p>Note that although point <code>1</code> is more than <code>0.2</code> units of distance from the nearest vertex of <code>poly</code>, it is still selected when the distance is set to <code>0.2</code>. This is because distance is measured to the nearest edge, in this case, the part of the polygon that lies directly above point 2 in Figure <a href="#fig-spatial-relations" class="quarto-xref">Figure&nbsp;<span>3.4</span></a>. We can verify that the actual distance between point <code>1</code> and the polygon is <code>0.13</code>, as follows.</p>
<div id="e838e7e6" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>points.iloc[<span class="dv">1</span>].distance(poly.iloc[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>0.13416407864998736</code></pre>
</div>
</div>
<p>This is also a good opportunity to repeat that all distance-related calculations in <strong>geopandas</strong> (and <strong>shapely</strong>) assume planar geometry, and only take into account the coordinate values. It is up to the user to make sure that all input layers are in the same projected CRS, so that this type of calculations make sense (see <a href="06-reproj.html#sec-geometry-operations-on-projected-and-unprojected-data" class="quarto-xref"><span>Section 6.4</span></a> and <a href="06-reproj.html#sec-when-to-reproject" class="quarto-xref"><span>Section 6.5</span></a>).</p>
</section>
<section id="sec-spatial-joining" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="sec-spatial-joining"><span class="header-section-number">3.2.3</span> Spatial joining</h3>
<p>Joining two non-spatial datasets uses a shared ‘key’ variable, as described in <a href="02-attribute-operations.html#sec-vector-attribute-joining" class="quarto-xref"><span>Section 2.2.3</span></a>. Spatial data joining applies the same concept, but instead relies on spatial relations, described in the previous section. As with attribute data, joining adds new columns to the target object (the argument <code>x</code> in joining functions), from a source object (<code>y</code>).</p>
<p>The following example illustrates the process: imagine you have ten points randomly distributed across the Earth’s surface and you ask, for the points that are on land, which countries are they in? Implementing this idea in a reproducible example will build your geographic data handling skills and show how spatial joins work. The starting point is to create points that are randomly scattered over the planar surface that represents Earth’s geographic coordinates, in decimal degrees (<a href="#fig-spatial-join" class="quarto-xref">Figure&nbsp;<span>3.7</span></a> (a)).</p>
<div id="40702c82" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">11</span>)       <span class="co">## set seed for reproducibility</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>bb <span class="op">=</span> world.total_bounds  <span class="co">## the world's bounds</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.uniform(low<span class="op">=</span>bb[<span class="dv">0</span>], high<span class="op">=</span>bb[<span class="dv">2</span>], size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.random.uniform(low<span class="op">=</span>bb[<span class="dv">1</span>], high<span class="op">=</span>bb[<span class="dv">3</span>], size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>random_points <span class="op">=</span> gpd.points_from_xy(x, y, crs<span class="op">=</span><span class="dv">4326</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>random_points <span class="op">=</span> gpd.GeoDataFrame({<span class="st">'geometry'</span>: random_points})</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>random_points</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>POINT (-115.10291 36.78178)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>POINT (-172.98891 -71.02938)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>POINT (-13.24134 65.23272)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>POINT (-4.54623 -69.64082)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8</td>
<td>POINT (159.05039 -34.99599)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9</td>
<td>POINT (126.28622 -62.49509)</td>
</tr>
</tbody>
</table>

<p>10 rows × 1 columns</p>
</div>
</div>
</div>
<p>The scenario illustrated in <a href="#fig-spatial-join" class="quarto-xref">Figure&nbsp;<span>3.7</span></a> shows that the <code>random_points</code> object (top left) lacks attribute data, while the world (top right) has attributes, including country names that are shown for a sample of countries in the legend. Before creating the joined dataset, we use spatial subsetting to create <code>world_random</code>, which contains only countries that contain random points, to verify the number of country names returned in the joined dataset should be four (see <a href="#fig-spatial-join" class="quarto-xref">Figure&nbsp;<span>3.7</span></a> (b)).</p>
<div id="c3c463c9" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>world_random <span class="op">=</span> world[world.intersects(random_points.union_all())]</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>world_random</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">iso_a2</th>
<th data-quarto-table-cell-role="th">name_long</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">gdpPercap</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>US</td>
<td>United States</td>
<td>...</td>
<td>51921.984639</td>
<td>MULTIPOLYGON (((-171.73166 63.7...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">18</td>
<td>RU</td>
<td>Russian Federation</td>
<td>...</td>
<td>25284.586202</td>
<td>MULTIPOLYGON (((-180 64.97971, ...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">52</td>
<td>ML</td>
<td>Mali</td>
<td>...</td>
<td>1865.160622</td>
<td>MULTIPOLYGON (((-11.51394 12.44...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">159</td>
<td>AQ</td>
<td>Antarctica</td>
<td>...</td>
<td>NaN</td>
<td>MULTIPOLYGON (((-180 -89.9, 179...</td>
</tr>
</tbody>
</table>

<p>4 rows × 11 columns</p>
</div>
</div>
</div>
<p>Spatial joins are implemented with <code>x.sjoin(y)</code>, as illustrated in the code chunk below. The output is the <code>random_joined</code> object which is illustrated in <a href="#fig-spatial-join" class="quarto-xref">Figure&nbsp;<span>3.7</span></a> (c).</p>
<div id="7ce636de" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>random_joined <span class="op">=</span> random_points.sjoin(world, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>random_joined</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">index_right</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">lifeExp</th>
<th data-quarto-table-cell-role="th">gdpPercap</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>POINT (-115.10291 36.78178)</td>
<td>4.0</td>
<td>...</td>
<td>78.841463</td>
<td>51921.984639</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>POINT (-172.98891 -71.02938)</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>POINT (-13.24134 65.23272)</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>POINT (-4.54623 -69.64082)</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8</td>
<td>POINT (159.05039 -34.99599)</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9</td>
<td>POINT (126.28622 -62.49509)</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>10 rows × 12 columns</p>
</div>
</div>
</div>
<p><a href="#fig-spatial-join" class="quarto-xref">Figure&nbsp;<span>3.7</span></a> shows the input points and countries, the illustration of intersecting countries, and the join result.</p>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Random points</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> world.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>random_points.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'None'</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>)<span class="op">;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># World countries intersecting with the points</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> world.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>world_random.plot(ax<span class="op">=</span>base, column<span class="op">=</span><span class="st">'name_long'</span>)<span class="op">;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Points with joined country names</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> world.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>random_joined.geometry.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'grey'</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>random_joined.plot(ax<span class="op">=</span>base, column<span class="op">=</span><span class="st">'name_long'</span>, legend<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-spatial-join" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-spatial-join-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-spatial-join" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-spatial-join-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-spatial-join-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-spatial-join-output-1.png" data-ref-parent="fig-spatial-join" width="429" height="224" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-spatial-join-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) A new attribute variable is added to random points,
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-spatial-join" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-spatial-join-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-spatial-join-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-spatial-join-output-2.png" data-ref-parent="fig-spatial-join" width="429" height="221" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-spatial-join-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) from source world object,
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-spatial-join" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-spatial-join-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-spatial-join-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-spatial-join-output-3.png" data-ref-parent="fig-spatial-join" width="429" height="224" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-spatial-join-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) resulting in points associated with country names
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spatial-join-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.7: Illustration of a spatial join
</figcaption>
</figure>
</div>
</section>
<section id="non-overlapping-joins" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="non-overlapping-joins"><span class="header-section-number">3.2.4</span> Non-overlapping joins</h3>
<p>Sometimes two geographic datasets do not touch but still have a strong geographic relationship. The datasets <code>cycle_hire</code> and <code>cycle_hire_osm</code> provide a good example. Plotting them reveals that they are often closely related but they do not seem to touch, as shown in <a href="#fig-cycle-hire" class="quarto-xref">Figure&nbsp;<span>3.8</span></a>.</p>
<div id="cell-fig-cycle-hire" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> cycle_hire.plot(edgecolor<span class="op">=</span><span class="st">'blue'</span>, color<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>cycle_hire_osm.plot(ax<span class="op">=</span>base, edgecolor<span class="op">=</span><span class="st">'red'</span>, color<span class="op">=</span><span class="st">'none'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-cycle-hire" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cycle-hire-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-cycle-hire-output-1.png" width="440" height="276" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cycle-hire-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.8: The spatial distribution of cycle hire points in London based on official data (blue) and OpenStreetMap data (red).
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can check if any of the points are the same by creating a pairwise boolean matrix of <code>.intersects</code> relations, then evaluating whether any of the values in it is <code>True</code>. Note that the <code>.to_numpy</code> method is applied to go from a <code>DataFrame</code> to an <code>ndarray</code>, for which <code>.any</code> gives a global rather than a row-wise summary. This is what we want in this case, because we are interested in whether any of the points intersect, not whether any of the points in each row intersect.</p>
<div id="eef6e43b" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> cycle_hire.geometry.<span class="bu">apply</span>(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">lambda</span> x: cycle_hire_osm.geometry.intersects(x)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>m.to_numpy().<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>np.False_</code></pre>
</div>
</div>
<p>Imagine that we need to join the capacity variable in <code>cycle_hire_osm</code> (<code>'capacity'</code>) onto the official ‘target’ data contained in <code>cycle_hire</code>, which looks as follows.</p>
<div id="99c5c9ae" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>cycle_hire</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">nempty</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>River Street</td>
<td>...</td>
<td>14</td>
<td>POINT (-0.10997 51.52916)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>Phillimore Gardens</td>
<td>...</td>
<td>34</td>
<td>POINT (-0.19757 51.49961)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>Christopher Street</td>
<td>...</td>
<td>32</td>
<td>POINT (-0.08461 51.52128)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">739</td>
<td>775</td>
<td>Little Brook Green</td>
<td>...</td>
<td>17</td>
<td>POINT (-0.22387 51.49666)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">740</td>
<td>776</td>
<td>Abyssinia Close</td>
<td>...</td>
<td>10</td>
<td>POINT (-0.16703 51.46033)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">741</td>
<td>777</td>
<td>Limburg Road</td>
<td>...</td>
<td>11</td>
<td>POINT (-0.1653 51.46192)</td>
</tr>
</tbody>
</table>

<p>742 rows × 6 columns</p>
</div>
</div>
</div>
<p>This is when a non-overlapping join is needed. Spatial join (<code>gpd.sjoin</code>) along with buffered geometries (see <a href="04-geometry-operations.html#sec-buffers" class="quarto-xref"><span>Section 4.2.3</span></a>) can be used to do that, as demonstrated below using a threshold distance of 20 <span class="math inline">\(m\)</span>. Note that we transform the data to a projected CRS (<code>27700</code>) to use real buffer distances, in meters (see <a href="06-reproj.html#sec-geometry-operations-on-projected-and-unprojected-data" class="quarto-xref"><span>Section 6.4</span></a>).</p>
<div id="7b86d53e" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>crs <span class="op">=</span> <span class="dv">27700</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>cycle_hire_buffers <span class="op">=</span> cycle_hire.copy().to_crs(crs)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>cycle_hire_buffers.geometry <span class="op">=</span> cycle_hire_buffers.<span class="bu">buffer</span>(<span class="dv">20</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>cycle_hire_buffers <span class="op">=</span> gpd.sjoin(</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    cycle_hire_buffers, </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    cycle_hire_osm.to_crs(crs), </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>cycle_hire_buffers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">name_left</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">cyclestreets_id</th>
<th data-quarto-table-cell-role="th">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>River Street</td>
<td>...</td>
<td>None</td>
<td>None</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>Phillimore Gardens</td>
<td>...</td>
<td>None</td>
<td>None</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>Christopher Street</td>
<td>...</td>
<td>None</td>
<td>None</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">739</td>
<td>775</td>
<td>Little Brook Green</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">740</td>
<td>776</td>
<td>Abyssinia Close</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">741</td>
<td>777</td>
<td>Limburg Road</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>762 rows × 12 columns</p>
</div>
</div>
</div>
<p>Note that the number of rows in the joined result is greater than the target. This is because some cycle hire stations in <code>cycle_hire_buffers</code> have multiple matches in <code>cycle_hire_osm</code>. To aggregate the values for the overlapping points and return the mean, we can use the aggregation methods shown in <a href="02-attribute-operations.html#sec-vector-attribute-aggregation" class="quarto-xref"><span>Section 2.2.2</span></a>, resulting in an object with the same number of rows as the target. We also go back from buffers to points using <code>.centroid</code> method.</p>
<div id="2c6c2373" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>cycle_hire_buffers <span class="op">=</span> cycle_hire_buffers[[<span class="st">'id'</span>, <span class="st">'capacity'</span>, <span class="st">'geometry'</span>]] <span class="op">\</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    .dissolve(by<span class="op">=</span><span class="st">'id'</span>, aggfunc<span class="op">=</span><span class="st">'mean'</span>) <span class="op">\</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>cycle_hire_buffers.geometry <span class="op">=</span> cycle_hire_buffers.centroid</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>cycle_hire_buffers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">capacity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>POINT (531203.517 182832.066)</td>
<td>9.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>POINT (525208.067 179391.922)</td>
<td>27.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>POINT (532985.807 182001.572)</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">739</td>
<td>775</td>
<td>POINT (523391.016 179020.043)</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">740</td>
<td>776</td>
<td>POINT (527437.473 175077.168)</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">741</td>
<td>777</td>
<td>POINT (527553.301 175257)</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>742 rows × 3 columns</p>
</div>
</div>
</div>
<p>The capacity of nearby stations can be verified by comparing a plot of the capacity of the source <code>cycle_hire_osm</code> data, with the join results in the new object <code>cycle_hire_buffers</code> (<a href="#fig-cycle-hire-z" class="quarto-xref">Figure&nbsp;<span>3.9</span></a>).</p>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Input</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">3</span>))</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>cycle_hire_osm.plot(column<span class="op">=</span><span class="st">'capacity'</span>, legend<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax)<span class="op">;</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Join result</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">3</span>))</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>cycle_hire_buffers.plot(column<span class="op">=</span><span class="st">'capacity'</span>, legend<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-cycle-hire-z" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cycle-hire-z-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-cycle-hire-z" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-cycle-hire-z-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-cycle-hire-z-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-cycle-hire-z-output-1.png" data-ref-parent="fig-cycle-hire-z" width="484" height="259" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-cycle-hire-z-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Input (<code>cycle_hire_osm</code>)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-cycle-hire-z" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-cycle-hire-z-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-cycle-hire-z-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-cycle-hire-z-output-2.png" data-ref-parent="fig-cycle-hire-z" width="496" height="259" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-cycle-hire-z-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Join result (<code>cycle_hire_buffers</code>)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cycle-hire-z-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.9: Non-overlapping join
</figcaption>
</figure>
</div>
</section>
<section id="sec-vector-spatial-aggregation" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5" class="anchored" data-anchor-id="sec-vector-spatial-aggregation"><span class="header-section-number">3.2.5</span> Spatial aggregation</h3>
<p>As with attribute data aggregation, spatial data aggregation condenses data: aggregated outputs have fewer rows than non-aggregated inputs. Statistical aggregating functions, such as mean, average, or sum, summarize multiple values of a variable, and return a single value per grouping variable. <a href="02-attribute-operations.html#sec-vector-attribute-aggregation" class="quarto-xref"><span>Section 2.2.2</span></a> demonstrated how the <code>.groupby</code> method, combined with summary functions such as <code>.sum</code>, condense data based on attribute variables. This section shows how grouping by spatial objects can be achieved using spatial joins combined with non-spatial aggregation.</p>
<p>Returning to the example of New Zealand, imagine you want to find out the average height of <code>nz_height</code> points in each region. It is the geometry of the source (<code>nz</code>) that defines how values in the target object (<code>nz_height</code>) are grouped. This can be done in three steps:</p>
<ol type="1">
<li>Figuring out which <code>nz</code> region each <code>nz_height</code> point falls in—using <code>gpd.sjoin</code></li>
<li>Summarizing the average elevation per region—using <code>.groupby</code> and <code>.mean</code></li>
<li>Joining the result back to <code>nz</code>—using <code>pd.merge</code></li>
</ol>
<p>First, we ‘attach’ the region classification of each point, using spatial join (<a href="#sec-spatial-joining" class="quarto-xref"><span>Section 3.2.3</span></a>). Note that we are using the minimal set of columns required: the geometries (for the spatial join to work), the point elevation (to later calculate an average), and the region name (to use as key when joining the results back to <code>nz</code>). The result tells us which <code>nz</code> region each elevation point falls in.</p>
<div id="0d6d1e30" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>nz_height2 <span class="op">=</span> gpd.sjoin(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  nz_height[[<span class="st">'elevation'</span>, <span class="st">'geometry'</span>]], </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  nz[[<span class="st">'Name'</span>, <span class="st">'geometry'</span>]], </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>nz_height2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">elevation</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">index_right</th>
<th data-quarto-table-cell-role="th">Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2723</td>
<td>POINT (1204142.603 5049971.287)</td>
<td>12</td>
<td>Southland</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2820</td>
<td>POINT (1234725.325 5048309.302)</td>
<td>11</td>
<td>Otago</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2830</td>
<td>POINT (1235914.511 5048745.117)</td>
<td>11</td>
<td>Otago</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">98</td>
<td>2751</td>
<td>POINT (1820659.873 5649488.235)</td>
<td>2</td>
<td>Waikato</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">99</td>
<td>2720</td>
<td>POINT (1822262.592 5650428.656)</td>
<td>2</td>
<td>Waikato</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">100</td>
<td>2732</td>
<td>POINT (1822492.184 5650492.304)</td>
<td>2</td>
<td>Waikato</td>
</tr>
</tbody>
</table>

<p>101 rows × 4 columns</p>
</div>
</div>
</div>
<p>Second, we calculate the average elevation, using ordinary (non-spatial) aggregation (<a href="02-attribute-operations.html#sec-vector-attribute-aggregation" class="quarto-xref"><span>Section 2.2.2</span></a>). This result tells us the average elevation of all <code>nz_height</code> points located within each <code>nz</code> region.</p>
<div id="625b7ed5" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>nz_height2 <span class="op">=</span> nz_height2.groupby(<span class="st">'Name'</span>)[[<span class="st">'elevation'</span>]].mean().reset_index()</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>nz_height2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">elevation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Canterbury</td>
<td>2994.600000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Manawatu-Wanganui</td>
<td>2777.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Marlborough</td>
<td>2720.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Southland</td>
<td>2723.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Waikato</td>
<td>2734.333333</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>West Coast</td>
<td>2889.454545</td>
</tr>
</tbody>
</table>

<p>7 rows × 2 columns</p>
</div>
</div>
</div>
<p>The third and final step is joining the averages back to the <code>nz</code> layer.</p>
<div id="335b3619" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>nz2 <span class="op">=</span> pd.merge(nz[[<span class="st">'Name'</span>, <span class="st">'geometry'</span>]], nz_height2, on<span class="op">=</span><span class="st">'Name'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>nz2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">elevation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Northland</td>
<td>MULTIPOLYGON (((1745493.196 600...</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Auckland</td>
<td>MULTIPOLYGON (((1803822.103 590...</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Waikato</td>
<td>MULTIPOLYGON (((1860345.005 585...</td>
<td>2734.333333</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">13</td>
<td>Tasman</td>
<td>MULTIPOLYGON (((1616642.877 542...</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">14</td>
<td>Nelson</td>
<td>MULTIPOLYGON (((1624866.278 541...</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">15</td>
<td>Marlborough</td>
<td>MULTIPOLYGON (((1686901.914 535...</td>
<td>2720.000000</td>
</tr>
</tbody>
</table>

<p>16 rows × 3 columns</p>
</div>
</div>
</div>
<p>We now have created the <code>nz2</code> layer, which gives the average <code>nz_height</code> elevation value per polygon. The result is shown in <a href="#fig-nz-avg-nz-height" class="quarto-xref">Figure&nbsp;<span>3.10</span></a>. Note that the <code>missing_kwds</code> part determines the style of geometries where the symbology attribute (<code>elevation</code>) is missing, because there were no <code>nz_height</code> points overlapping with them. The default is to omit them, which is usually not what we want, but with <code>{'color':'grey','edgecolor':'black'}</code>, those polygons are shown with black outline and grey fill.</p>
<div id="cell-fig-nz-avg-nz-height" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>nz2.plot(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  column<span class="op">=</span><span class="st">'elevation'</span>, </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  cmap<span class="op">=</span><span class="st">'Blues'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  missing_kwds<span class="op">=</span>{<span class="st">'color'</span>: <span class="st">'grey'</span>, <span class="st">'edgecolor'</span>: <span class="st">'black'</span>}</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-nz-avg-nz-height" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nz-avg-nz-height-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-nz-avg-nz-height-output-1.png" width="386" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nz-avg-nz-height-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.10: Average height of the top 101 high points across the regions of New Zealand
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-joining-incongruent-layers" class="level3" data-number="3.2.6">
<h3 data-number="3.2.6" class="anchored" data-anchor-id="sec-joining-incongruent-layers"><span class="header-section-number">3.2.6</span> Joining incongruent layers</h3>
<p>Spatial congruence is an important concept related to spatial aggregation. An aggregating object (which we will refer to as <code>y</code>) is congruent with the target object (<code>x</code>) if the two objects have shared borders. Often this is the case for administrative boundary data, whereby larger units—such as Middle Layer Super Output Areas (MSOAs) in the UK, or districts in many other European countries—are composed of many smaller units.</p>
<p>Incongruent aggregating objects, by contrast, do not share common borders with the target <span class="citation" data-cites="qiu_development_2012">(<a href="references.html#ref-qiu_development_2012" role="doc-biblioref">Qiu, Zhang, and Zhou 2012</a>)</span>. This is problematic for spatial aggregation (and other spatial operations) illustrated in <a href="#fig-nz-and-grid" class="quarto-xref">Figure&nbsp;<span>3.11</span></a>: aggregating the centroid of each sub-zone will not return accurate results. Areal interpolation overcomes this issue by transferring values from one set of areal units to another, using a range of algorithms including simple area-weighted approaches and more sophisticated approaches such as ‘pycnophylactic’ methods <span class="citation" data-cites="tobler_smooth_1979">(<a href="references.html#ref-tobler_smooth_1979" role="doc-biblioref">Tobler 1979</a>)</span>.</p>
<p>To demonstrate joining incongruent layers, we will create a ‘synthetic’ layer comprising a regular grid of rectangles of size <span class="math inline">\(100\times100\)</span> <span class="math inline">\(km\)</span>, covering the extent of the <code>nz</code> layer. This recipe can be used to create a regular grid covering any given layer (other than <code>nz</code>), at the specified resolution (<code>res</code>). Most of the functions have been explained in previous chapters; we leave it as an exercise for the reader to explore how the code works.</p>
<div id="7b401a9d" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Settings: grid extent, resolution, and CRS</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>bounds <span class="op">=</span> nz.total_bounds</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>crs <span class="op">=</span> nz.crs</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating grid dimensions</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>xmin, ymin, xmax, ymax <span class="op">=</span> bounds</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">int</span>(np.floor(xmin)), <span class="bu">int</span>(np.ceil(xmax<span class="op">+</span>res)), res))</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">int</span>(np.floor(ymin)), <span class="bu">int</span>(np.ceil(ymax<span class="op">+</span>res)), res))</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>rows.reverse()</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co"># For each cell, create 'shapely' polygon (rectangle)</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>polygons <span class="op">=</span> []</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> cols:</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y <span class="kw">in</span> rows:</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>        polygons.append(</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>            shapely.Polygon([(x,y), (x<span class="op">+</span>res, y), (x<span class="op">+</span>res, y<span class="op">-</span>res), (x, y<span class="op">-</span>res)])</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="co"># To 'GeoDataFrame'</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> gpd.GeoDataFrame({<span class="st">'geometry'</span>: polygons}, crs<span class="op">=</span>crs)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows/columns beyond the extent</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>sel <span class="op">=</span> grid.intersects(shapely.box(<span class="op">*</span>bounds))</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> grid[sel]</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Add consecultive IDs</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>grid[<span class="st">'id'</span>] <span class="op">=</span> grid.index</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>POLYGON ((1090143 6248536, 1190...</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>POLYGON ((1090143 6148536, 1190...</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>POLYGON ((1090143 6048536, 1190...</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">156</td>
<td>POLYGON ((1990143 5048536, 2090...</td>
<td>156</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">157</td>
<td>POLYGON ((1990143 4948536, 2090...</td>
<td>157</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">158</td>
<td>POLYGON ((1990143 4848536, 2090...</td>
<td>158</td>
</tr>
</tbody>
</table>

<p>150 rows × 2 columns</p>
</div>
</div>
</div>
<p><a href="#fig-nz-and-grid" class="quarto-xref">Figure&nbsp;<span>3.11</span></a> shows the newly created <code>grid</code> layer, along with the <code>nz</code> layer.</p>
<div id="cell-fig-nz-and-grid" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> grid.plot(color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'grey'</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>nz.plot(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>base, </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">'Population'</span>, </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">'black'</span>, </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">'Reds'</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-nz-and-grid" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nz-and-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-nz-and-grid-output-1.png" width="364" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nz-and-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.11: The <code>nz</code> layer, with population size in each region, overlaid with a regular <code>grid</code> of rectangles
</figcaption>
</figure>
</div>
</div>
</div>
<p>Our goal, now, is to ‘transfer’ the <code>'Population'</code> attribute (<a href="#fig-nz-and-grid" class="quarto-xref">Figure&nbsp;<span>3.11</span></a>) to the rectangular grid polygons, which is an example of a join between incongruent layers. To do that, we basically need to calculate—for each <code>grid</code> cell—the weighted sum of the population in <code>nz</code> polygons coinciding with that cell. The weights in the weighted sum calculation are the ratios between the area of the coinciding ‘part’ out of the entire <code>nz</code> polygon. That is, we (inevitably) assume that the population in each <code>nz</code> polygon is equally distributed across space, therefore a partial <code>nz</code> polygon contains the respective partial population size.</p>
<p>We start by calculating the entire area of each <code>nz</code> polygon, as follows, using the <code>.area</code> method (<a href="01-spatial-data.html#sec-area-length" class="quarto-xref"><span>Section 1.2.7</span></a>).</p>
<div id="6bf2f78d" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>nz[<span class="st">'area'</span>] <span class="op">=</span> nz.area</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>nz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Island</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">area</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Northland</td>
<td>North</td>
<td>...</td>
<td>MULTIPOLYGON (((1745493.196 600...</td>
<td>1.289058e+10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Auckland</td>
<td>North</td>
<td>...</td>
<td>MULTIPOLYGON (((1803822.103 590...</td>
<td>4.911565e+09</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Waikato</td>
<td>North</td>
<td>...</td>
<td>MULTIPOLYGON (((1860345.005 585...</td>
<td>2.458882e+10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">13</td>
<td>Tasman</td>
<td>South</td>
<td>...</td>
<td>MULTIPOLYGON (((1616642.877 542...</td>
<td>9.594918e+09</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">14</td>
<td>Nelson</td>
<td>South</td>
<td>...</td>
<td>MULTIPOLYGON (((1624866.278 541...</td>
<td>4.080754e+08</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">15</td>
<td>Marlborough</td>
<td>South</td>
<td>...</td>
<td>MULTIPOLYGON (((1686901.914 535...</td>
<td>1.046485e+10</td>
</tr>
</tbody>
</table>

<p>16 rows × 8 columns</p>
</div>
</div>
</div>
<p>Next, we use the <code>.overlay</code> method to calculate the pairwise intersections between <code>nz</code> and <code>grid</code>. As a result, we now have a layer where each <code>nz</code> polygon is split according to the <code>grid</code> polygons, hereby named <code>nz_grid</code>.</p>
<div id="233cc2dc" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>nz_grid <span class="op">=</span> nz.overlay(grid)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>nz_grid <span class="op">=</span> nz_grid[[<span class="st">'id'</span>, <span class="st">'area'</span>, <span class="st">'Population'</span>, <span class="st">'geometry'</span>]]</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>nz_grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">area</th>
<th data-quarto-table-cell-role="th">Population</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>64</td>
<td>1.289058e+10</td>
<td>175500.0</td>
<td>POLYGON ((1586362.965 6168009.0...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>80</td>
<td>1.289058e+10</td>
<td>175500.0</td>
<td>POLYGON ((1590143 6162776.641, ...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>81</td>
<td>1.289058e+10</td>
<td>175500.0</td>
<td>POLYGON ((1633099.964 6066188.0...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">107</td>
<td>89</td>
<td>1.046485e+10</td>
<td>46200.0</td>
<td>POLYGON ((1641283.955 5341361.1...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">108</td>
<td>103</td>
<td>1.046485e+10</td>
<td>46200.0</td>
<td>POLYGON ((1690724.332 5458875.4...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">109</td>
<td>104</td>
<td>1.046485e+10</td>
<td>46200.0</td>
<td>MULTIPOLYGON (((1694233.995 543...</td>
</tr>
</tbody>
</table>

<p>110 rows × 4 columns</p>
</div>
</div>
</div>
<p><a href="#fig-nz-and-grid-overlay" class="quarto-xref">Figure&nbsp;<span>3.12</span></a> illustrates the effect of <code>.overlay</code>:</p>
<div id="cell-fig-nz-and-grid-overlay" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>nz_grid.plot(color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-nz-and-grid-overlay" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nz-and-grid-overlay-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-nz-and-grid-overlay-output-1.png" width="306" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nz-and-grid-overlay-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.12: The pairwise intersections of <code>nz</code> and <code>grid</code>, calculated with <code>.overlay</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>We also need to calculate the areas of the intersections, here into a new attribute <code>'area_sub'</code>. If an <code>nz</code> polygon was completely within a single <code>grid</code> polygon, then <code>area_sub</code> is going to be equal to <code>area</code>; otherwise, it is going to be smaller.</p>
<div id="df269427" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>nz_grid[<span class="st">'area_sub'</span>] <span class="op">=</span> nz_grid.area</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>nz_grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">area</th>
<th data-quarto-table-cell-role="th">Population</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">area_sub</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>64</td>
<td>1.289058e+10</td>
<td>175500.0</td>
<td>POLYGON ((1586362.965 6168009.0...</td>
<td>3.231015e+08</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>80</td>
<td>1.289058e+10</td>
<td>175500.0</td>
<td>POLYGON ((1590143 6162776.641, ...</td>
<td>4.612641e+08</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>81</td>
<td>1.289058e+10</td>
<td>175500.0</td>
<td>POLYGON ((1633099.964 6066188.0...</td>
<td>5.685656e+09</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">107</td>
<td>89</td>
<td>1.046485e+10</td>
<td>46200.0</td>
<td>POLYGON ((1641283.955 5341361.1...</td>
<td>1.826943e+09</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">108</td>
<td>103</td>
<td>1.046485e+10</td>
<td>46200.0</td>
<td>POLYGON ((1690724.332 5458875.4...</td>
<td>1.227037e+08</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">109</td>
<td>104</td>
<td>1.046485e+10</td>
<td>46200.0</td>
<td>MULTIPOLYGON (((1694233.995 543...</td>
<td>4.874611e+08</td>
</tr>
</tbody>
</table>

<p>110 rows × 5 columns</p>
</div>
</div>
</div>
<p>The resulting layer <code>nz_grid</code>, with the <code>area_sub</code> attribute, is shown in <a href="#fig-nz-and-grid2" class="quarto-xref">Figure&nbsp;<span>3.13</span></a>.</p>
<div id="cell-fig-nz-and-grid2" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> grid.plot(color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'grey'</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>nz_grid.plot(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>base, </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">'area_sub'</span>, </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">'Reds'</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-nz-and-grid2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nz-and-grid2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-nz-and-grid2-output-1.png" width="351" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nz-and-grid2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.13: The areas of pairwise intersections in the <code>nz_grid</code> layer
</figcaption>
</figure>
</div>
</div>
</div>
<p>Note that each of the intersections still holds the <code>Population</code> attribute of its ‘origin’ feature of <code>nz</code>, i.e., each portion of the <code>nz</code> area is associated with the original complete population count for that area. The real population size of each <code>nz_grid</code> feature, however, is smaller, or equal, depending on the geographic area proportion that it occupies out of the original <code>nz</code> feature. To make the correction, we first calculate the ratio (<code>area_prop</code>) and then multiply it by the population. The new (lowercase) attribute <code>population</code> now has the correct estimate of population sizes in <code>nz_grid</code>:</p>
<div id="3ffd96b0" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>nz_grid[<span class="st">'area_prop'</span>] <span class="op">=</span> nz_grid[<span class="st">'area_sub'</span>] <span class="op">/</span> nz_grid[<span class="st">'area'</span>]</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>nz_grid[<span class="st">'population'</span>] <span class="op">=</span> nz_grid[<span class="st">'Population'</span>] <span class="op">*</span> nz_grid[<span class="st">'area_prop'</span>]</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>nz_grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">area</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">area_prop</th>
<th data-quarto-table-cell-role="th">population</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>64</td>
<td>1.289058e+10</td>
<td>...</td>
<td>0.025065</td>
<td>4398.897141</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>80</td>
<td>1.289058e+10</td>
<td>...</td>
<td>0.035783</td>
<td>6279.925114</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>81</td>
<td>1.289058e+10</td>
<td>...</td>
<td>0.441071</td>
<td>77407.916241</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">107</td>
<td>89</td>
<td>1.046485e+10</td>
<td>...</td>
<td>0.174579</td>
<td>8065.550415</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">108</td>
<td>103</td>
<td>1.046485e+10</td>
<td>...</td>
<td>0.011725</td>
<td>541.709946</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">109</td>
<td>104</td>
<td>1.046485e+10</td>
<td>...</td>
<td>0.046581</td>
<td>2152.033881</td>
</tr>
</tbody>
</table>

<p>110 rows × 7 columns</p>
</div>
</div>
</div>
<p>What is left to be done is to sum (see <a href="02-attribute-operations.html#sec-vector-attribute-aggregation" class="quarto-xref"><span>Section 2.2.2</span></a>) the population in all parts forming the same grid cell and join (see <a href="02-attribute-operations.html#sec-vector-attribute-joining" class="quarto-xref"><span>Section 2.2.3</span></a>) them back to the <code>grid</code> layer. Note that many of the grid cells have ‘No Data’ for population, because they have no intersection with <code>nz</code> at all (<a href="#fig-nz-and-grid" class="quarto-xref">Figure&nbsp;<span>3.11</span></a>).</p>
<div id="e030b45c" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>nz_grid <span class="op">=</span> nz_grid.groupby(<span class="st">'id'</span>)[<span class="st">'population'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> pd.merge(grid, nz_grid[[<span class="st">'id'</span>, <span class="st">'population'</span>]], on<span class="op">=</span><span class="st">'id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">population</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>POLYGON ((1090143 6248536, 1190...</td>
<td>0</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>POLYGON ((1090143 6148536, 1190...</td>
<td>1</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>POLYGON ((1090143 6048536, 1190...</td>
<td>2</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">147</td>
<td>POLYGON ((1990143 5048536, 2090...</td>
<td>156</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">148</td>
<td>POLYGON ((1990143 4948536, 2090...</td>
<td>157</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">149</td>
<td>POLYGON ((1990143 4848536, 2090...</td>
<td>158</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>150 rows × 3 columns</p>
</div>
</div>
</div>
<p><a href="#fig-nz-and-grid3" class="quarto-xref">Figure&nbsp;<span>3.14</span></a> shows the final result <code>grid</code> with the incongruently-joined <code>population</code> attribute from <code>nz</code>.</p>
<div id="cell-fig-nz-and-grid3" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> grid.plot(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">'population'</span>, </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">'Reds'</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>nz.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'grey'</span>, legend<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-nz-and-grid3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nz-and-grid3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-nz-and-grid3-output-1.png" width="364" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nz-and-grid3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.14: The <code>nz</code> layer and a regular grid of rectangles: final result
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can demonstrate that, expectedly, the summed population in <code>nz</code> and <code>grid</code> is identical, even though the geometry is different (since we created <code>grid</code> to completely cover <code>nz</code>), by comparing the <code>.sum</code> of the <code>population</code> attribute in both layers.</p>
<div id="7b2c6d4f" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>nz[<span class="st">'Population'</span>].<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>np.float64(4787200.0)</code></pre>
</div>
</div>
<div id="4f015758" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>grid[<span class="st">'population'</span>].<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>np.float64(4787199.999999998)</code></pre>
</div>
</div>
<p>The procedure in this section is known as an area-weighted interpolation of a spatially <em>extensive</em> (e.g., population) variable. In extensive interpolation, we assume that the variable of interest represents counts (such as, here, inhabitants) uniformly distributed across space. In such case, each part of a given polygon captures the respective proportion of counts (such as, half of a region with <span class="math inline">\(N\)</span> inhabitants contains <span class="math inline">\(N/2\)</span> inhabitants). Accordingly, summing the parts gives the total count of the total area.</p>
<p>An area-weighted interpolation of a spatially <em>intensive</em> variable (e.g., population density) is almost identical, except that we would have to calculate the weighted <code>.mean</code> rather than <code>.sum</code>, to preserve the average rather than the sum. In intensive interpolation, we assume that the variable of interest represents counts per unit area, i.e., density. Since density is (assumed to be) uniform, any part of a given polygon has exactly the same density as that of the whole polygon. Density values are therefore computed as weighted averages, rather than sums, of the parts. Also, see the ‘Area-weighted interpolation’ section in <span class="citation" data-cites="pebesma_spatial_2023">Pebesma and Bivand (<a href="references.html#ref-pebesma_spatial_2023" role="doc-biblioref">2023</a>)</span>.</p>
</section>
<section id="sec-distance-relations" class="level3" data-number="3.2.7">
<h3 data-number="3.2.7" class="anchored" data-anchor-id="sec-distance-relations"><span class="header-section-number">3.2.7</span> Distance relations</h3>
<p>While topological relations are binary—a feature either intersects with another or does not—distance relations are continuous. The distance between two objects is calculated with the <code>.distance</code> method. The method is applied on a <code>GeoSeries</code> (or a <code>GeoDataFrame</code>), with the argument being an individual <code>shapely</code> geometry. The result is a <code>Series</code> of pairwise distances.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>geopandas</strong> uses similar syntax and mode of operation for many of its methods and functions, including:</p>
<ul>
<li>Numeric calculations, such as <code>.distance</code> (this section), returning numeric values</li>
<li>Topological evaluation methods, such as <code>.intersects</code> or <code>.disjoint</code> (<a href="#sec-topological-relations" class="quarto-xref"><span>Section 3.2.2</span></a>), returning boolean values</li>
<li>Geometry generating-methods, such as <code>.intersection</code> (<a href="04-geometry-operations.html#sec-clipping" class="quarto-xref"><span>Section 4.2.5</span></a>), returning geometries</li>
</ul>
<p>In all cases, the input is a <code>GeoSeries</code> and (or a <code>GeoDataFrame</code>) and a <code>shapely</code> geometry, and the output is a <code>Series</code> or <code>GeoSeries</code> of results, contrasting each geometry from the <code>GeoSeries</code> with the <code>shapely</code> geometry. The examples in this book demonstrate this, so-called ‘many-to-one’, mode of the functions.</p>
<p>All of the above-mentioned methods also have a pairwise mode, perhaps less useful and not used in the book, where we evaluate relations between pairs of geometries in two <code>GeoSeries</code>, aligned either by index or by position.</p>
</div>
</div>
<p>To illustrate the <code>.distance</code> method, let’s take the three highest points in New Zealand with <code>.sort_values</code> and <code>.iloc</code>.</p>
<div id="fde82e3d" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>nz_highest <span class="op">=</span> nz_height.sort_values(by<span class="op">=</span><span class="st">'elevation'</span>, ascending<span class="op">=</span><span class="va">False</span>).iloc[:<span class="dv">3</span>, :]</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>nz_highest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">t50_fid</th>
<th data-quarto-table-cell-role="th">elevation</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">64</td>
<td>2372236</td>
<td>3724</td>
<td>POINT (1369317.63 5169132.284)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">63</td>
<td>2372235</td>
<td>3717</td>
<td>POINT (1369512.866 5168235.616)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">67</td>
<td>2372252</td>
<td>3688</td>
<td>POINT (1369381.942 5168761.875)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Additionally, we need the geographic centroid of the Canterbury region (<code>canterbury</code>, created in <a href="#sec-spatial-subsetting-vector" class="quarto-xref"><span>Section 3.2.1</span></a>).</p>
<div id="8049e695" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>canterbury_centroid <span class="op">=</span> canterbury.centroid.iloc[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are able to apply <code>.distance</code> to calculate the distances from each of the three elevation points to the centroid of the Canterbury region.</p>
<div id="fd8ed6b0" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>nz_highest.distance(canterbury_centroid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>64    115539.995747
63    115390.248038
67    115493.594066
dtype: float64</code></pre>
</div>
</div>
<p>To obtain a distance matrix, i.e., a pairwise set of distances between all combinations of features in objects <code>x</code> and <code>y</code>, we need to use the <code>.apply</code> method (analogous to the way we created the <code>.intersects</code> boolean matrix in <a href="#sec-topological-relations" class="quarto-xref"><span>Section 3.2.2</span></a>). To illustrate this, let’s now take two regions in <code>nz</code>, Otago and Canterbury, represented by the object <code>co</code>.</p>
<div id="b222e5d4" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>sel <span class="op">=</span> nz[<span class="st">'Name'</span>].<span class="bu">str</span>.contains(<span class="st">'Canter|Otag'</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>co <span class="op">=</span> nz[sel]</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>co</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Island</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">area</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Canterbury</td>
<td>South</td>
<td>...</td>
<td>MULTIPOLYGON (((1686901.914 535...</td>
<td>4.532656e+10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Otago</td>
<td>South</td>
<td>...</td>
<td>MULTIPOLYGON (((1335204.789 512...</td>
<td>3.190356e+10</td>
</tr>
</tbody>
</table>

<p>2 rows × 8 columns</p>
</div>
</div>
</div>
<p>The distance matrix (technically speaking, a <code>DataFrame</code>) <code>d</code> between each of the first three elevation points, and the two regions, is then obtained as follows. In plain language, we take the geometry from each each row in <code>nz_height.iloc[:3,:]</code>, and apply the <code>.distance</code> method on <code>co</code> with its rows as the argument.</p>
<div id="b71ac4c5" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> nz_height.iloc[:<span class="dv">3</span>, :].<span class="bu">apply</span>(<span class="kw">lambda</span> x: co.distance(x.geometry), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">10</th>
<th data-quarto-table-cell-role="th">11</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>123537.158269</td>
<td>15497.717252</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>94282.773074</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>93018.560814</td>
<td>0.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Note that the distance between the second and third features in <code>nz_height</code> and the second feature in <code>co</code> is zero. This demonstrates the fact that distances between points and polygons refer to the distance to any part of the polygon: the second and third points in <code>nz_height</code> are in Otago, which can be verified by plotting them (two almost completely overlappling points in <a href="#fig-nz-height-and-otago" class="quarto-xref">Figure&nbsp;<span>3.15</span></a>).</p>
<div id="cell-fig-nz-height-and-otago" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>co.plot(color<span class="op">=</span><span class="st">'lightgrey'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>co.<span class="bu">apply</span>(</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: ax.annotate(</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>        text<span class="op">=</span>x[<span class="st">'Name'</span>], </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>        xy<span class="op">=</span>x.geometry.centroid.coords[<span class="dv">0</span>], </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'center'</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    ), </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>nz_height.iloc[:<span class="dv">3</span>, :].plot(color<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, ax<span class="op">=</span>ax)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-nz-height-and-otago" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nz-height-and-otago-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-nz-height-and-otago-output-1.png" width="390" height="442" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nz-height-and-otago-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.15: The first three <code>nz_height</code> points, and the Otago and Canterbury regions from <code>nz</code>
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-spatial-ras" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="sec-spatial-ras"><span class="header-section-number">3.3</span> Spatial operations on raster data</h2>
<p>This section builds on <a href="02-attribute-operations.html#sec-manipulating-raster-objects" class="quarto-xref"><span>Section 2.3</span></a>, which highlights various basic methods for manipulating raster datasets, to demonstrate more advanced and explicitly spatial raster operations, and uses the <code>elev.tif</code> and <code>grain.tif</code> rasters manually created in <a href="01-spatial-data.html#sec-raster-from-scratch" class="quarto-xref"><span>Section 1.3.2</span></a>.</p>
<section id="sec-spatial-subsetting-raster" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="sec-spatial-subsetting-raster"><span class="header-section-number">3.3.1</span> Spatial subsetting</h3>
<p>The previous chapter (and especially <a href="02-attribute-operations.html#sec-manipulating-raster-objects" class="quarto-xref"><span>Section 2.3</span></a>) demonstrated how to retrieve values associated with specific row and column combinations from a raster. Raster values can also be extracted by location (coordinates) and other spatial objects. To use coordinates for subsetting, we can use the <code>.sample</code> method of a <code>rasterio</code> file connection object, combined with a list of coordinate tuples. The method is demonstrated below to find the value of the cell that covers a point located at coordinates of <code>(0.1,0.1)</code> in <code>elev</code>. The returned object is a <em>generator</em>. The rationale for returning a generator, rather than a <code>list</code>, is memory efficiency. The number of sampled points may be huge, in which case we would want to generate the values one at a time rather than all at once.</p>
<div id="19713781" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>src_elev.sample([(<span class="fl">0.1</span>, <span class="fl">0.1</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>&lt;generator object sample_gen at 0x7f0ae70f3290&gt;</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The technical terms <em>iterable</em>, <em>iterator</em>, and <em>generator</em> in Python may be confusing, so here is a short summary, ordered from most general to most specific:</p>
<ul>
<li>An <em>iterable</em> is any object that we can iterate on, such as using a <code>for</code> loop. For example, a <code>list</code> is iterable.</li>
<li>An <em>iterator</em> is an object that represents a stream of data, which we can go over, each time getting the next element using <code>next</code>. Iterators are also iterable, meaning that you can over them in a loop, but they are stateful (e.g., they remember which item was obtained using <code>next</code>), meaning that you can go over them just once.</li>
<li>A <em>generator</em> is a function that returns an iterator. For example, the <code>.sample</code> method in the above example is a generator. The <strong>rasterio</strong> package makes use of generators in some of its functions, as we will see later on (<a href="05-raster-vector.html#sec-raster-to-polygons" class="quarto-xref"><span>Section 5.5.1</span></a>).</li>
</ul>
</div>
</div>
<p>In case we nevertheless want all values at once, such as when the number of points is small, we can force the generatrion of all values from a generator at once, using <code>list</code>. Since there was just one point, the result is one extracted value, in this case <code>16</code>.</p>
<div id="fe34be47" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(src_elev.sample([(<span class="fl">0.1</span>, <span class="fl">0.1</span>)]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>[array([16], dtype=uint8)]</code></pre>
</div>
</div>
<p>We can use the same technique to extract the values of multiple points at once. For example, here we extract the raster values at two points, <code>(0.1,0.1)</code> and <code>(1.1,1.1)</code>. The resulting values are <code>16</code> and <code>6</code>.</p>
<div id="ee834b30" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(src_elev.sample([(<span class="fl">0.1</span>, <span class="fl">0.1</span>), (<span class="fl">1.1</span>, <span class="fl">1.1</span>)]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>[array([16], dtype=uint8), array([6], dtype=uint8)]</code></pre>
</div>
</div>
<p>The location of the two sample points on top of the <code>elev.tif</code> raster is illustrated in <a href="#fig-elev-sample-points" class="quarto-xref">Figure&nbsp;<span>3.16</span></a>.</p>
<div id="cell-fig-elev-sample-points" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(src_elev, ax<span class="op">=</span>ax)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>gpd.GeoSeries([shapely.Point(<span class="fl">0.1</span>, <span class="fl">0.1</span>)]) <span class="op">\</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    .plot(color<span class="op">=</span><span class="st">'black'</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>, markersize<span class="op">=</span><span class="dv">50</span>, ax<span class="op">=</span>ax)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>gpd.GeoSeries([shapely.Point(<span class="fl">1.1</span>, <span class="fl">1.1</span>)]) <span class="op">\</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    .plot(color<span class="op">=</span><span class="st">'black'</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>, markersize<span class="op">=</span><span class="dv">50</span>, ax<span class="op">=</span>ax)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-elev-sample-points" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-elev-sample-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-elev-sample-points-output-1.png" width="441" height="416" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-elev-sample-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.16: The <code>elev.tif</code> raster, and two points where we extract its values
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We elaborate on the plotting technique used to display the points and the raster in <a href="08-mapping.html#sec-plot-static-layers" class="quarto-xref"><span>Section 8.2.5</span></a>. We will also introduce a more user-friendly and general method to extract raster values to points, using the <strong>rasterstats</strong> package, in <a href="05-raster-vector.html#sec-extraction-to-points" class="quarto-xref"><span>Section 5.3.1</span></a>.</p>
</div>
</div>
<p>Another common use case of spatial subsetting is using a boolean mask, based on another raster with the same extent and resolution, or the original one, as illustrated in <a href="#fig-raster-subset" class="quarto-xref">Figure&nbsp;<span>3.17</span></a>. To do that, we erase the values in the array of one raster, according to another corresponding mask raster. For example, let’s read (<a href="01-spatial-data.html#sec-using-rasterio" class="quarto-xref"><span>Section 1.3.1</span></a>) the <code>elev.tif</code> raster values into an array named <code>elev</code> (<a href="#fig-raster-subset" class="quarto-xref">Figure&nbsp;<span>3.17</span></a> (a)).</p>
<div id="e1dc5b4b" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>elev <span class="op">=</span> src_elev.read(<span class="dv">1</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>elev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>array([[ 1,  2,  3,  4,  5,  6],
       [ 7,  8,  9, 10, 11, 12],
       [13, 14, 15, 16, 17, 18],
       [19, 20, 21, 22, 23, 24],
       [25, 26, 27, 28, 29, 30],
       [31, 32, 33, 34, 35, 36]], dtype=uint8)</code></pre>
</div>
</div>
<p>and create a corresponding random boolean mask named <code>mask</code> (<a href="#fig-raster-subset" class="quarto-xref">Figure&nbsp;<span>3.17</span></a> (b)), of the same shape as <code>elev.tif</code> with values randomly assigned to <code>True</code> and <code>False</code>.</p>
<div id="f0d35a19" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> np.random.choice([<span class="va">True</span>, <span class="va">False</span>], src_elev.shape)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>array([[False, False,  True,  True, False, False],
       [False, False, False,  True,  True, False],
       [ True, False, False,  True,  True, False],
       [ True,  True,  True, False,  True,  True],
       [False,  True,  True,  True, False,  True],
       [ True,  True, False, False, False, False]])</code></pre>
</div>
</div>
<p>Next, suppose that we want to keep only those values of <code>elev</code> which are <code>False</code> in <code>mask</code> (i.e., they are <em>not</em> masked). In other words, we want to mask <code>elev</code> with <code>mask</code>. The result will be stored in a copy named <code>masked_elev</code> (<a href="#fig-raster-subset" class="quarto-xref">Figure&nbsp;<span>3.17</span></a> (c)). In the case of <code>elev.tif</code>, to be able to store <code>np.nan</code> in the array of values, we also need to convert it to <code>float</code> (see <a href="02-attribute-operations.html#sec-summarizing-raster-objects" class="quarto-xref"><span>Section 2.3.2</span></a>). Afterwards, masking is a matter of assigning <code>np.nan</code> into a subset defined by the mask, using the ‘boolean array indexing’ syntax of <strong>numpy</strong>.</p>
<div id="6e24b60c" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>masked_elev <span class="op">=</span> elev.copy()</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>masked_elev <span class="op">=</span> masked_elev.astype(<span class="st">'float64'</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>masked_elev[mask] <span class="op">=</span> np.nan</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>masked_elev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>array([[ 1.,  2., nan, nan,  5.,  6.],
       [ 7.,  8.,  9., nan, nan, 12.],
       [nan, 14., 15., nan, nan, 18.],
       [nan, nan, nan, 22., nan, nan],
       [25., nan, nan, nan, 29., nan],
       [nan, nan, 33., 34., 35., 36.]])</code></pre>
</div>
</div>
<p><a href="#fig-raster-subset" class="quarto-xref">Figure&nbsp;<span>3.17</span></a> shows the original <code>elev</code> raster, the <code>mask</code> raster, and the resulting <code>masked_elev</code> raster.</p>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(elev)<span class="op">;</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(mask)<span class="op">;</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(masked_elev)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-raster-subset" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raster-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-subset" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-subset-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-subset-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-subset-output-1.png" data-ref-parent="fig-raster-subset" width="407" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-subset-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Original raster
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-subset" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-subset-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-subset-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-subset-output-2.png" data-ref-parent="fig-raster-subset" width="407" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-subset-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Raster mask
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-subset" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-subset-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-subset-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-subset-output-3.png" data-ref-parent="fig-raster-subset" width="407" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-subset-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) Output masked raster
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raster-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.17: Subsetting raster values using a boolean mask
</figcaption>
</figure>
</div>
<p>The mask can be created from the array itself, using condition(s). That way, we can replace some values (e.g., values assumed to be wrong) with <code>np.nan</code>, such as in the following example.</p>
<div id="f6e73059" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>elev2 <span class="op">=</span> elev.copy()</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>elev2 <span class="op">=</span> elev2.astype(<span class="st">'float64'</span>)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>elev2[elev2 <span class="op">&lt;</span> <span class="dv">20</span>] <span class="op">=</span> np.nan</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>elev2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>array([[nan, nan, nan, nan, nan, nan],
       [nan, nan, nan, nan, nan, nan],
       [nan, nan, nan, nan, nan, nan],
       [nan, 20., 21., 22., 23., 24.],
       [25., 26., 27., 28., 29., 30.],
       [31., 32., 33., 34., 35., 36.]])</code></pre>
</div>
</div>
<p>This technique is also used to reclassify raster values (see <a href="#sec-raster-local-operations" class="quarto-xref"><span>Section 3.3.3</span></a>).</p>
</section>
<section id="sec-map-algebra" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="sec-map-algebra"><span class="header-section-number">3.3.2</span> Map algebra</h3>
<p>The term ‘map algebra’ was coined in the late 1970s to describe a ‘set of conventions, capabilities, and techniques’ for the analysis of geographic raster and (although less prominently) vector data <span class="citation" data-cites="tomlin_map_1994">(<a href="references.html#ref-tomlin_map_1994" role="doc-biblioref">Tomlin 1994</a>)</span>. In this context, we define map algebra more narrowly, as operations that modify or summarize raster cell values, with reference to surrounding cells, zones, or statistical functions that apply to every cell.</p>
<p>Map algebra operations tend to be fast, because raster datasets only implicitly store coordinates, hence the old adage ‘raster is faster but vector is corrector’. The location of cells in raster datasets can be calculated by using its matrix position and the resolution and origin of the dataset (stored in the raster metadata, <a href="01-spatial-data.html#sec-using-rasterio" class="quarto-xref"><span>Section 1.3.1</span></a>). For the processing, however, the geographic position of a cell is barely relevant as long as we make sure that the cell position is still the same after the processing. Additionally, if two or more raster datasets share the same extent, projection, and resolution, one could treat them as matrices for the processing.</p>
<p>Map algebra (or cartographic modeling with raster data) divides raster operations into four subclasses <span class="citation" data-cites="tomlin_geographic_1990">(<a href="references.html#ref-tomlin_geographic_1990" role="doc-biblioref">Tomlin 1990</a>)</span>, with each working on one or several grids simultaneously:</p>
<ul>
<li>Local or per-cell operations (<a href="#sec-raster-local-operations" class="quarto-xref"><span>Section 3.3.3</span></a>)</li>
<li>Focal or neighborhood operations. Most often the output cell value is the result of a <span class="math inline">\(3 \times 3\)</span> input cell block (<a href="#sec-focal-operations" class="quarto-xref"><span>Section 3.3.4</span></a>)</li>
<li>Zonal operations are similar to focal operations, but the surrounding pixel grid on which new values are computed can have irregular sizes and shapes (<a href="#sec-zonal-operations" class="quarto-xref"><span>Section 3.3.5</span></a>)</li>
<li>Global or per-raster operations; that means the output cell derives its value potentially from one or several entire rasters (<a href="#sec-global-operations-and-distances" class="quarto-xref"><span>Section 3.3.6</span></a>)</li>
</ul>
<p>This typology classifies map algebra operations by the number of cells used for each pixel processing step and the type of output. For the sake of completeness, we should mention that raster operations can also be classified by disciplines such as terrain, hydrological analysis, or image classification. The following sections explain how each type of map algebra operations can be used, with reference to worked examples.</p>
</section>
<section id="sec-raster-local-operations" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="sec-raster-local-operations"><span class="header-section-number">3.3.3</span> Local operations</h3>
<p>Local operations comprise all cell-by-cell operations in one or several layers. Raster algebra is a classical use case of local operations—this includes adding or subtracting values from a raster, squaring, and multiplying rasters. Raster algebra also allows logical operations such as finding all raster cells that are greater than a specific value (e.g., <code>5</code> in our example below). Local operations are applied using the <strong>numpy</strong> array operations syntax, as demonstrated below.</p>
<p>First, let’s take the array of <code>elev.tif</code> raster values, which we already read earlier (<a href="#sec-spatial-subsetting-raster" class="quarto-xref"><span>Section 3.3.1</span></a>).</p>
<div id="cb81b09b" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>elev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>array([[ 1,  2,  3,  4,  5,  6],
       [ 7,  8,  9, 10, 11, 12],
       [13, 14, 15, 16, 17, 18],
       [19, 20, 21, 22, 23, 24],
       [25, 26, 27, 28, 29, 30],
       [31, 32, 33, 34, 35, 36]], dtype=uint8)</code></pre>
</div>
</div>
<p>Now, any element-wise array operation can be applied using <strong>numpy</strong> arithmetic or conditional operators and functions, comprising local raster operations in spatial analysis terminology. For example, <code>elev+elev</code> adds the values of <code>elev</code> to itself, resulting in a raster with double values.</p>
<div id="63367e3d" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>elev <span class="op">+</span> elev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>array([[ 2,  4,  6,  8, 10, 12],
       [14, 16, 18, 20, 22, 24],
       [26, 28, 30, 32, 34, 36],
       [38, 40, 42, 44, 46, 48],
       [50, 52, 54, 56, 58, 60],
       [62, 64, 66, 68, 70, 72]], dtype=uint8)</code></pre>
</div>
</div>
<p>Note that some functions and operators automatically change the data type to accommodate the resulting values, while other operators do not, potentially resulting in overflow (i.e., incorrect values for results beyond the data type range, such as trying to accommodate values above <code>255</code> in an <code>int8</code> array). For example, <code>elev**2</code> (<code>elev</code> squared) results in overflow. Since the <code>**</code> operator does not automatically change the data type, leaving it as <code>int8</code>, the resulting array has incorrect values for <code>16**2</code>, <code>17**2</code>, etc., which are above <code>255</code> and therefore cannot be accommodated.</p>
<div id="eb842a47" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>elev<span class="op">**</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>array([[  1,   4,   9,  16,  25,  36],
       [ 49,  64,  81, 100, 121, 144],
       [169, 196, 225,   0,  33,  68],
       [105, 144, 185, 228,  17,  64],
       [113, 164, 217,  16,  73, 132],
       [193,   0,  65, 132, 201,  16]], dtype=uint8)</code></pre>
</div>
</div>
<p>To avoid this situation, we can, for instance, transform <code>elev</code> to the standard <code>int64</code> data type, using <code>.astype</code> before applying the <code>**</code> operator. That way, all results, up to <code>36**2</code> (<code>1296</code>), can be easily accommodated, since the <code>int64</code> data type supports values up to <code>9223372036854775807</code> (<a href="07-read-write.html#tbl-numpy-data-types" class="quarto-xref">Table&nbsp;<span>7.2</span></a>).</p>
<div id="e00961c4" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>elev.astype(<span class="bu">int</span>)<span class="op">**</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>array([[   1,    4,    9,   16,   25,   36],
       [  49,   64,   81,  100,  121,  144],
       [ 169,  196,  225,  256,  289,  324],
       [ 361,  400,  441,  484,  529,  576],
       [ 625,  676,  729,  784,  841,  900],
       [ 961, 1024, 1089, 1156, 1225, 1296]])</code></pre>
</div>
</div>
<p>Now we get correct results.</p>
<p><a href="#fig-raster-local-operations" class="quarto-xref">Figure&nbsp;<span>3.18</span></a> demonstrates the result of the last two examples (<code>elev+elev</code> and <code>elev.astype(int)**2</code>), and two other ones (<code>np.log(elev)</code> and <code>elev&gt;5</code>).</p>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(elev <span class="op">+</span> elev, cmap<span class="op">=</span><span class="st">'Oranges'</span>)<span class="op">;</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(elev.astype(<span class="bu">int</span>)<span class="op">**</span><span class="dv">2</span>, cmap<span class="op">=</span><span class="st">'Oranges'</span>)<span class="op">;</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(np.log(elev), cmap<span class="op">=</span><span class="st">'Oranges'</span>)<span class="op">;</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(elev <span class="op">&gt;</span> <span class="dv">5</span>, cmap<span class="op">=</span><span class="st">'Oranges'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-raster-local-operations" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raster-local-operations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-local-operations" style="flex-basis: 25.0%;justify-content: flex-start;">
<div id="fig-raster-local-operations-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-local-operations-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-local-operations-output-1.png" data-ref-parent="fig-raster-local-operations" width="407" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-local-operations-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>elev+elev</code>
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-local-operations" style="flex-basis: 25.0%;justify-content: flex-start;">
<div id="fig-raster-local-operations-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-local-operations-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-local-operations-output-2.png" data-ref-parent="fig-raster-local-operations" width="407" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-local-operations-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) <code>elev.astype(int)**2</code>
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-local-operations" style="flex-basis: 25.0%;justify-content: flex-start;">
<div id="fig-raster-local-operations-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-local-operations-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-local-operations-output-3.png" data-ref-parent="fig-raster-local-operations" width="407" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-local-operations-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) <code>np.log(elev)</code>
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-local-operations" style="flex-basis: 25.0%;justify-content: flex-start;">
<div id="fig-raster-local-operations-4" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-local-operations-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-local-operations-output-4.png" data-ref-parent="fig-raster-local-operations" width="407" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-local-operations-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d) <code>elev&gt;5</code>
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raster-local-operations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.18: Examples of different local operations of the elev raster object: adding two rasters, squaring, applying logarithmic transformation, and performing a logical operation.
</figcaption>
</figure>
</div>
<p>Another good example of local operations is the classification of intervals of numeric values into groups such as grouping a digital elevation model into low (class <code>1</code>), middle (class <code>2</code>) and high (class <code>3</code>) elevations. Here, the raster values in the ranges <code>0</code>–<code>12</code>, <code>12</code>–<code>24</code>, and <code>24</code>–<code>36</code> are reclassified to take values <code>1</code>, <code>2</code>, and <code>3</code>, respectively.</p>
<div id="912043b1" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>recl <span class="op">=</span> elev.copy()</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>recl[(elev <span class="op">&gt;</span> <span class="dv">0</span>)  <span class="op">&amp;</span> (elev <span class="op">&lt;=</span> <span class="dv">12</span>)] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>recl[(elev <span class="op">&gt;</span> <span class="dv">12</span>) <span class="op">&amp;</span> (elev <span class="op">&lt;=</span> <span class="dv">24</span>)] <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>recl[(elev <span class="op">&gt;</span> <span class="dv">24</span>) <span class="op">&amp;</span> (elev <span class="op">&lt;=</span> <span class="dv">36</span>)] <span class="op">=</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-raster-reclassify" class="quarto-xref">Figure&nbsp;<span>3.19</span></a> compares the original <code>elev</code> raster with the reclassified <code>recl</code> one.</p>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(elev, cmap<span class="op">=</span><span class="st">'Oranges'</span>)<span class="op">;</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(recl, cmap<span class="op">=</span><span class="st">'Oranges'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-raster-reclassify" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raster-reclassify-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-reclassify" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-raster-reclassify-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-reclassify-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-reclassify-output-1.png" data-ref-parent="fig-raster-reclassify" width="407" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-reclassify-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Original
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-reclassify" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-raster-reclassify-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-reclassify-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-reclassify-output-2.png" data-ref-parent="fig-raster-reclassify" width="407" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-reclassify-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Reclassified
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raster-reclassify-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.19: Reclassifying a continuous raster into three categories.
</figcaption>
</figure>
</div>
<p>The calculation of the Normalized Difference Vegetation Index (NDVI)<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> is a well-known local (pixel-by-pixel) raster operation. It returns a raster with values between <code>-1</code> and <code>1</code>; positive values indicate the presence of living plants (mostly &gt; <code>0.2</code>). NDVI is calculated from red and near-infrared (NIR) bands of remotely sensed imagery, typically from satellite systems such as Landsat or Sentinel-2. Vegetation absorbs light heavily in the visible light spectrum, and especially in the red channel, while reflecting NIR light, which is emulated in the NVDI formula (<a href="#eq-ndvi" class="quarto-xref">Equation&nbsp;<span>3.1</span></a>),</p>
<p><span id="eq-ndvi"><span class="math display">\[
NDVI=\frac{NIR-Red} {NIR+Red}
\tag{3.1}\]</span></span></p>
<p>, where <span class="math inline">\(NIR\)</span> is the near-infrared band and <span class="math inline">\(Red\)</span> is the red band.</p>
<p>Let’s calculate NDVI for the multispectral Landsat satellite file (<code>landsat.tif</code>) of the Zion National Park. The file <code>landsat.tif</code> contains surface reflectance values (range <code>0</code>-<code>1</code>) in the blue, green, red, and near-infrared (NIR) bands. We start by reading the file and extracting the NIR and red bands, which are the fourth and third bands, respectively. Next, we apply the formula to calculate the NDVI values.</p>
<div id="5d679f8f" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>landsat <span class="op">=</span> src_landsat.read()</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>nir <span class="op">=</span> landsat[<span class="dv">3</span>]</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>red <span class="op">=</span> landsat[<span class="dv">2</span>]</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>ndvi <span class="op">=</span> (nir<span class="op">-</span>red)<span class="op">/</span>(nir<span class="op">+</span>red)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When plotting an RGB image using the <code>rasterio.plot.show</code> function, the function assumes that values are in the range <code>[0,1]</code> for floats, or <code>[0,255]</code> for integers (otherwise clipped) and the order of bands is RGB. To prepare the multi-band raster for <code>rasterio.plot.show</code>, we, therefore, reverse the order of the first three bands (to go from B-G-R-NIR to R-G-B), using the <code>[:3]</code> slice to select the first three bands and then the <code>[::-1]</code> slice to reverse the bands order, and divide by the raster maximum to set the maximum value to <code>1</code>.</p>
<div id="5bc7f15c" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>landsat_rgb <span class="op">=</span> landsat[:<span class="dv">3</span>][::<span class="op">-</span><span class="dv">1</span>] <span class="op">/</span> landsat.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Python slicing notation, which <strong>numpy</strong>, <strong>pandas</strong> and <strong>geopandas</strong> also follow, is <code>object[start:stop:step]</code>. The default is to start from the beginning, go to the end, and use steps of <code>1</code>. Otherwise, <code>start</code> is inclusive and <code>end</code> is exclusive, whereas negative <code>step</code> values imply going backwards starting from the end. Also, always keep in mind that Python indices start from <code>0</code>. When subsetting two- or three-dimensional objects, indices for each dimension are separated by commas, where either index can be set to <code>:</code> meaning ‘all values’. The last dimensions can also be omitted implying <code>:</code>, e.g., to subset the first three bands from a three-dimensional array <code>a</code> we can use either <code>a[:3,:,:]</code> or <code>a[:3]</code>.</p>
<p>In the above example:</p>
<ul>
<li>The slicing expression <code>[:3]</code> therefore means layers <code>0</code>, <code>1</code>, <code>2</code> (up to <code>3</code>, exclusive)</li>
<li>The slicing expression <code>[::-1]</code> therefore means all (three) bands in reverse order</li>
</ul>
</div>
</div>
<p><a href="#fig-raster-ndvi" class="quarto-xref">Figure&nbsp;<span>3.20</span></a> shows the RGB image and the NDVI values calculated for the Landsat satellite image of the Zion National Park.</p>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(landsat_rgb, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>)<span class="op">;</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(ndvi, cmap<span class="op">=</span><span class="st">'Greens'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-raster-ndvi" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raster-ndvi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-ndvi" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-raster-ndvi-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-ndvi-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-ndvi-output-1.png" data-ref-parent="fig-raster-ndvi" width="354" height="416" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-ndvi-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) RGB image
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-ndvi" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-raster-ndvi-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-ndvi-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-ndvi-output-2.png" data-ref-parent="fig-raster-ndvi" width="354" height="416" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-ndvi-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) NDVI
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raster-ndvi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.20: RGB image and NDVI values calculated for the Landsat satellite image of the Zion National Park
</figcaption>
</figure>
</div>
</section>
<section id="sec-focal-operations" class="level3" data-number="3.3.4">
<h3 data-number="3.3.4" class="anchored" data-anchor-id="sec-focal-operations"><span class="header-section-number">3.3.4</span> Focal operations</h3>
<p>While local functions operate on one cell at a time (though possibly from multiple layers), focal operations take into account a central (focal) cell and its neighbors. The neighborhood (also named kernel, filter, or moving window) under consideration is typically of <span class="math inline">\(3 \times 3\)</span> cells (that is, the central cell and its eight surrounding neighbors), but can take on any other (not necessarily rectangular) shape as defined by the user. A focal operation applies an aggregation function to all cells within the specified neighborhood, uses the corresponding output as the new value for the central cell, and moves on to the next central cell (<a href="#fig-focal-filter" class="quarto-xref">Figure&nbsp;<span>3.21</span></a>). Other names for this operation are spatial filtering and convolution <span class="citation" data-cites="burrough_principles_2015">(<a href="references.html#ref-burrough_principles_2015" role="doc-biblioref">Burrough, McDonnell, and Lloyd 2015</a>)</span>.</p>
<div id="fig-focal-filter" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-focal-filter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/04_focal_example.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-focal-filter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.21: Input raster (left) and resulting output raster (right) due to a focal operation—finding the minimum value in <span class="math inline">\(3 \times 3\)</span> moving windows.
</figcaption>
</figure>
</div>
<p>In Python, the <strong>scipy.ndimage</strong> <span class="citation" data-cites="scipy">(<a href="references.html#ref-scipy" role="doc-biblioref">Virtanen et al. 2020</a>)</span> package has a comprehensive collection of functions to perform filtering of <strong>numpy</strong> arrays, such as:</p>
<ul>
<li><code>scipy.ndimage.minimum_filter</code>,</li>
<li><code>scipy.ndimage.maximum_filter</code>,</li>
<li><code>scipy.ndimage.uniform_filter</code> (i.e., mean filter),</li>
<li><code>scipy.ndimage.median_filter</code>, etc.</li>
</ul>
<p>In this group of functions, we define the shape of the moving window with either one of <code>size</code>—a single number (e.g., <code>3</code>), or tuple (e.g., <code>(3,3)</code>), implying a filter of those dimensions, or <code>footprint</code>—a boolean array, representing both the window shape and the identity of elements being included.</p>
<p>In addition to specific built-in filters, <code>convolve</code>—applies the sum function after multiplying by a custom <code>weights</code> array, and <code>generic_filter</code>—makes it possible to pass any custom function, where the user can specify any type of custom window-based calculation.</p>
<p>For example, here we apply the minimum filter with window size of <code>3</code> on <code>elev</code>. As a result, we now have a new array <code>elev_min</code>, where each value is the minimum in the corresponding <span class="math inline">\(3 \times 3\)</span> neighborhood in <code>elev</code>.</p>
<div id="2fb00859" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>elev_min <span class="op">=</span> scipy.ndimage.minimum_filter(elev, size<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>elev_min</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>array([[ 1,  1,  2,  3,  4,  5],
       [ 1,  1,  2,  3,  4,  5],
       [ 7,  7,  8,  9, 10, 11],
       [13, 13, 14, 15, 16, 17],
       [19, 19, 20, 21, 22, 23],
       [25, 25, 26, 27, 28, 29]], dtype=uint8)</code></pre>
</div>
</div>
<p>Special care should be given to the edge pixels – how should they be calculated? The <strong>scipy.ndimage</strong> filtering functions give several options through the <code>mode</code> parameter (see the documentation of any filtering function, such as <code>scipy.ndimage.median_filter</code>, for the definition of each mode): <code>reflect</code> (the default), <code>constant</code>, <code>nearest</code>, <code>mirror</code>, <code>wrap</code>. Sometimes artificially extending raster edges is considered unsuitable. In other words, we may wish the resulting raster to contain pixel values with ‘complete’ windows only, for example, to have a uniform sample size or because values in all directions matter (such as in topographic calculations). There is no specific option <em>not</em> to extend edges in <strong>scipy.ndimage</strong>. However, to get the same effect, the edges of the filtered array can be assigned with <code>np.nan</code>, in a number of rows and columns according to filter size. For example, when using a filter of <code>size=3</code>, the outermost ‘layer’ of pixels may be assigned with <code>np.nan</code>, reflecting the fact that these pixels have incomplete <span class="math inline">\(3 \times 3\)</span> neighborhoods (<a href="#fig-focal-filter" class="quarto-xref">Figure&nbsp;<span>3.21</span></a>):</p>
<div id="a9892270" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>elev_min <span class="op">=</span> elev_min.astype(<span class="bu">float</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>elev_min[:, [<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>]] <span class="op">=</span> np.nan</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>elev_min[[<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>], :] <span class="op">=</span> np.nan</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>elev_min</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>array([[nan, nan, nan, nan, nan, nan],
       [nan,  1.,  2.,  3.,  4., nan],
       [nan,  7.,  8.,  9., 10., nan],
       [nan, 13., 14., 15., 16., nan],
       [nan, 19., 20., 21., 22., nan],
       [nan, nan, nan, nan, nan, nan]])</code></pre>
</div>
</div>
<p>We can quickly check if the output meets our expectations. In our example, the minimum value has to be always the upper left corner of the moving window (remember we have created the input raster by row-wise incrementing the cell values by one, starting at the upper left corner).</p>
<p>Focal functions or filters play a dominant role in image processing. For example, low-pass or smoothing filters use the mean function to remove extremes. By contrast, high-pass filters, often created with custom neighborhood weights, accentuate features.</p>
<p>In the case of categorical data, we can replace the mean with the mode, i.e., the most common value. To demonstrate applying a mode filter, let’s read the small sample categorical raster <code>grain.tif</code>.</p>
<div id="38422d0e" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>grain <span class="op">=</span> src_grain.read(<span class="dv">1</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>grain</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>array([[1, 0, 1, 2, 2, 2],
       [0, 2, 0, 0, 2, 1],
       [0, 2, 2, 0, 0, 2],
       [0, 0, 1, 1, 1, 1],
       [1, 1, 1, 2, 1, 1],
       [2, 1, 2, 2, 0, 2]], dtype=uint8)</code></pre>
</div>
</div>
<p>There is no built-in filter function for a mode filter in <strong>scipy.ndimage</strong>, but we can use the <code>scipy.ndimage.generic_filter</code> function along with a custom filtering function, internally utilizing <code>scipy.stats.mode</code>.</p>
<div id="8320429e" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>grain_mode <span class="op">=</span> scipy.ndimage.generic_filter(</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    grain, </span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: scipy.stats.mode(x.flatten())[<span class="dv">0</span>], </span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span><span class="dv">3</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>grain_mode <span class="op">=</span> grain_mode.astype(<span class="bu">float</span>)</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>grain_mode[:, [<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>]] <span class="op">=</span> np.nan</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>grain_mode[[<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>], :] <span class="op">=</span> np.nan</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>grain_mode</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>array([[nan, nan, nan, nan, nan, nan],
       [nan,  0.,  0.,  0.,  2., nan],
       [nan,  0.,  0.,  0.,  1., nan],
       [nan,  1.,  1.,  1.,  1., nan],
       [nan,  1.,  1.,  1.,  1., nan],
       [nan, nan, nan, nan, nan, nan]])</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>scipy.stats.mode</code> is a function to summarize array values, returning the mode (most common value). It is analogous to <strong>numpy</strong> summary functions and methods, such as <code>.mean</code> or <code>.max</code>. <strong>numpy</strong> itself does not provide the <em>mode</em> function, however, which is why we use <strong>scipy</strong> for that.</p>
</div>
</div>
<p>Terrain processing is another important application of focal operations. Such functions are provided by multiple Python packages, including the general purpose <strong>xarray</strong> package, and more specialized packages such as <strong>richdem</strong> and <strong>pysheds</strong>. Useful terrain metrics include:</p>
<ul>
<li>Slope, measured in units of percent, degreees, or radians <span class="citation" data-cites="horn_1981">(<a href="references.html#ref-horn_1981" role="doc-biblioref">Horn 1981</a>)</span></li>
<li>Aspect, meaning each cell’s downward slope direction <span class="citation" data-cites="horn_1981">(<a href="references.html#ref-horn_1981" role="doc-biblioref">Horn 1981</a>)</span></li>
<li>Slope curvature, including ‘planform’ and ‘profile’ curvature <span class="citation" data-cites="zevenbergen_1987">(<a href="references.html#ref-zevenbergen_1987" role="doc-biblioref">Zevenbergen and Thorne 1987</a>)</span></li>
</ul>
<p>For example, each of these, and other, terrain metrics can be computed with the <strong>richdem</strong> package.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Terrain metrics are essentially focal filters with customized functions. Using <code>scipy.ndimage.generic_filter</code>, along with such custom functions, is an option for those who would like to calculate terrain metric through coding by hand and/or limiting their code dependencies. For example, the <em>How Aspect works</em><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> and <em>How Slope works</em><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> pages from the ArcGIS Pro documentation provide explanations and formulas of the required functions for aspect and slope metrics (<a href="#fig-raster-slope" class="quarto-xref">Figure&nbsp;<span>3.22</span></a>), respectively, which can be translated to <strong>numpy</strong>-based functions to be used in <code>scipy.ndimage.generic_filter</code> to calculate those metrics.</p>
</div>
</div>
<p>Another extremely fast, memory-efficient, and concise, alternative, is to the use the GDAL program called <code>gdaldem</code>. <code>gdaldem</code> can be used to calculate slope, aspect, and other terrain metrics through a single command, accepting an input file path and exporting the result to a new file. This is our first example in the book where we demonstrate a situation where it may be worthwhile to leave the Python environment, and utilize a GDAL program directly, rather than through their wrappers (such as <strong>rasterio</strong> and other Python packages), whether to access a computational algorithm not easily accessible in a Python package, or for GDAL’s memory-efficiency and speed benefits.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>GDAL contains a collection of over 40 programs, mostly aimed at raster processing. These include programs for fundamental operations, such as:</p>
<ul>
<li><code>gdal_translate</code>—convert between raster file formats</li>
<li><code>gdalwarp</code>—raster reprojection</li>
<li><code>gdal_rasterize</code>—rasterize vector features</li>
<li><code>gdal_merge.py</code>—raster mosaic</li>
</ul>
<p>In this book, we use <strong>rasterio</strong> for the above-mentioned operations, although the GDAL programs are a good alternative for those who are more comfortable with the command line. However, we do use two GDAL programs for tasks that are lacking in <strong>rasterio</strong> and not well-implemented in other Python packages: <code>gdaldem</code> (this section), and <code>gdal_contour</code> (<a href="05-raster-vector.html#sec-raster-to-contours" class="quarto-xref"><span>Section 5.5.3</span></a>).</p>
</div>
</div>
<p>GDAL, along with all of its programs, should be available in your Python environment, since GDAL is a dependency of <strong>rasterio</strong>. The following example, which should be run from the command line, takes the <code>srtm_32612.tif</code> raster (which we are going to create in <a href="06-reproj.html#sec-reprojecting-raster-geometries" class="quarto-xref"><span>Section 6.8</span></a>, therefore it is in the <code>'output'</code> directory), calculates slope (in decimal degrees, between <code>0</code> and <code>90</code>), and exports the result to a new file <code>srtm_32612_slope.tif</code>. Note that the arguments of <code>gdaldem</code> are the metric name (<code>slope</code>), then the input file path, and finally the output file path.</p>
<div id="5c575370" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">'gdaldem slope output/srtm_32612.tif output/srtm_32612_slope.tif'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we ran the <code>gdaldem</code> command through <code>os.system</code>, in order to remain in the Python environment, even though we are calling an external program. Alternatively, you can run the standalone command in the command line interface you are using, such as the Anaconda Prompt:</p>
<pre class="{sh}"><code>gdaldem slope output/srtm_32612.tif output/srtm_32612_slope.tif</code></pre>
<p>Replacing the metric name, we can calculate other terrain properties. For example, here is how we can calculate an aspect raster <code>srtm_32612_aspect.tif</code>, also in degrees (between <code>0</code> and <code>360</code>).</p>
<div id="4bfa1b8e" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">'gdaldem aspect output/srtm_32612.tif output/srtm_32612_aspect.tif'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-raster-slope" class="quarto-xref">Figure&nbsp;<span>3.22</span></a> shows the results, using our more familiar plotting methods from <strong>rasterio</strong>. The code section is relatively long due to the workaround to create a color key (see <a href="08-mapping.html#sec-plot-symbology" class="quarto-xref"><span>Section 8.2.3</span></a>) and removing ‘No Data’ flag values from the arrays so that the color key does not include them. Also note that we are using one of <strong>matplotlib</strong>’s cyclic color scales (<code>'twilight'</code>) when plotting aspect (<a href="#fig-raster-slope" class="quarto-xref">Figure&nbsp;<span>3.22</span></a> (c)).</p>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Input DEM</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>src_srtm <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'output/srtm_32612.tif'</span>)</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>srtm <span class="op">=</span> src_srtm.read(<span class="dv">1</span>).astype(<span class="bu">float</span>)</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>srtm[srtm <span class="op">==</span> src_srtm.nodata] <span class="op">=</span> np.nan</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(src_srtm, cmap<span class="op">=</span><span class="st">'Spectral_r'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>fig.colorbar(ax.imshow(srtm, cmap<span class="op">=</span><span class="st">'Spectral_r'</span>), ax<span class="op">=</span>ax)<span class="op">;</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Slope</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>src_srtm_slope <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'output/srtm_32612_slope.tif'</span>)</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>srtm_slope <span class="op">=</span> src_srtm_slope.read(<span class="dv">1</span>)</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>srtm_slope[srtm_slope <span class="op">==</span> src_srtm_slope.nodata] <span class="op">=</span> np.nan</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(src_srtm_slope, cmap<span class="op">=</span><span class="st">'Spectral_r'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>fig.colorbar(ax.imshow(srtm_slope, cmap<span class="op">=</span><span class="st">'Spectral_r'</span>), ax<span class="op">=</span>ax)<span class="op">;</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Aspect</span></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>src_srtm_aspect <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'output/srtm_32612_aspect.tif'</span>)</span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>srtm_aspect <span class="op">=</span> src_srtm_aspect.read(<span class="dv">1</span>)</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>srtm_aspect[srtm_aspect <span class="op">==</span> src_srtm_aspect.nodata] <span class="op">=</span> np.nan</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(src_srtm_aspect, cmap<span class="op">=</span><span class="st">'twilight'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a>fig.colorbar(ax.imshow(srtm_aspect, cmap<span class="op">=</span><span class="st">'twilight'</span>), ax<span class="op">=</span>ax)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-raster-slope" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raster-slope-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-slope" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-slope-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-slope-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-slope-output-1.png" data-ref-parent="fig-raster-slope" width="432" height="409" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-slope-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Input DEM
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-slope" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-slope-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-slope-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-slope-output-2.png" data-ref-parent="fig-raster-slope" width="415" height="409" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-slope-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Slope (degrees)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-slope" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-slope-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-slope-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-slope-output-3.png" data-ref-parent="fig-raster-slope" width="423" height="409" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-slope-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) Aspect (degrees)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raster-slope-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.22: Slope and aspect calculation from a DEM
</figcaption>
</figure>
</div>
</section>
<section id="sec-zonal-operations" class="level3" data-number="3.3.5">
<h3 data-number="3.3.5" class="anchored" data-anchor-id="sec-zonal-operations"><span class="header-section-number">3.3.5</span> Zonal operations</h3>
<p>Just like focal operations, zonal operations apply an aggregation function to multiple raster cells. However, a second raster, usually with categorical values, defines the zonal filters (or ‘zones’) in the case of zonal operations, as opposed to a predefined neighborhood window in the case of focal operation presented in the previous section. Consequently, raster cells defining the zonal filter do not necessarily have to be neighbors. Our <code>grain.tif</code> raster is a good example, as illustrated in <a href="01-spatial-data.html#fig-rasterio-plot-grain" class="quarto-xref">Figure&nbsp;<span>1.24</span></a>: different grain sizes are spread irregularly throughout the raster. Finally, the result of a zonal operation is a summary table grouped by zone, which is why this operation is also known as zonal statistics in the GIS world. This is in contrast to focal operations (<a href="#sec-focal-operations" class="quarto-xref"><span>Section 3.3.4</span></a>) which return a raster object.</p>
<p>To demonstrate, let’s get back to the <code>grain.tif</code> and <code>elev.tif</code> rasters. To calculate zonal statistics, we use the arrays with raster values, which we already imported earlier. Our intention is to calculate the average (or any other summary function, for that matter) of <em>elevation</em> in each zone defined by <em>grain</em> values. To do that, first we first obtain the unique values defining the zones using <code>np.unique</code>.</p>
<div id="a67fc79e" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>np.unique(grain)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>array([0, 1, 2], dtype=uint8)</code></pre>
</div>
</div>
<p>Now, we can use dictionary comprehension (see note below) to split the <code>elev</code> array into separate one-dimensional arrays with values per <code>grain</code> group, with keys being the unique <code>grain</code> values.</p>
<div id="11ccc754" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> {i: elev[grain <span class="op">==</span> i] <span class="cf">for</span> i <span class="kw">in</span> np.unique(grain)}</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>z</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>{np.uint8(0): array([ 2,  7,  9, 10, 13, 16, 17, 19, 20, 35], dtype=uint8),
 np.uint8(1): array([ 1,  3, 12, 21, 22, 23, 24, 25, 26, 27, 29, 30, 32], dtype=uint8),
 np.uint8(2): array([ 4,  5,  6,  8, 11, 14, 15, 18, 28, 31, 33, 34, 36], dtype=uint8)}</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>List comprehension</em> and <em>dictionary comprehension</em> are concise ways to create a <code>list</code> or a <code>dict</code>, respectively, from an iterable object. Both are, conceptually, a concise syntax to replace <code>for</code> loops where we iterate over an object and return a same-length object with the results. Here are minimal examples of list and dictionary comprehension, respectively, to demonstrate the idea:</p>
<ul>
<li><code>[i**2 for i in [2,4,6]]</code>—Returns <code>[4,16,36]</code></li>
<li><code>{i: i**2 for i in [2,4,6]}</code>—Returns <code>{2:4, 4:16, 6:36}</code></li>
</ul>
<p>List comprehension is more commonly encountered in practice. We use it in <a href="04-geometry-operations.html#sec-subsetting-vs-clipping" class="quarto-xref"><span>Section 4.2.6</span></a>, <a href="05-raster-vector.html#sec-rasterizing-lines-and-polygons" class="quarto-xref"><span>Section 5.4.2</span></a>, <a href="05-raster-vector.html#sec-raster-to-polygons" class="quarto-xref"><span>Section 5.5.1</span></a>, and <a href="05-raster-vector.html#sec-distance-to-nearest-geometry" class="quarto-xref"><span>Section 5.6</span></a>. Dictionary comprehension is only used in one place in the book (this section).</p>
</div>
</div>
<p>At this stage, we can expand the dictionary comprehension expression to calculate the mean elevation associated with each grain size class. Namely, instead of placing the elevation values (<code>elev[grain==i]</code>) into the dictionary values, we place their (rounded) mean (<code>elev[grain==i].mean().round(1)</code>).</p>
<div id="205a38bd" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> {i: elev[grain <span class="op">==</span> i].mean().<span class="bu">round</span>(<span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> np.unique(grain)}</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>z</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>{np.uint8(0): np.float64(14.8),
 np.uint8(1): np.float64(21.2),
 np.uint8(2): np.float64(18.7)}</code></pre>
</div>
</div>
<p>This returns the statistics for each category, here the mean elevation for each grain size class. For example, the mean elevation in pixels characterized by grain size <code>0</code> is <code>14.8</code>, and so on.</p>
</section>
<section id="sec-global-operations-and-distances" class="level3" data-number="3.3.6">
<h3 data-number="3.3.6" class="anchored" data-anchor-id="sec-global-operations-and-distances"><span class="header-section-number">3.3.6</span> Global operations and distances</h3>
<p>Global operations are a special case of zonal operations with the entire raster dataset representing a single zone. The most common global operations are descriptive statistics for the entire raster dataset such as the minimum or maximum—we already discussed those in <a href="02-attribute-operations.html#sec-summarizing-raster-objects" class="quarto-xref"><span>Section 2.3.2</span></a>.</p>
<p>Aside from that, global operations are also useful for the computation of distance and weight rasters. In the first case, one can calculate the distance from each cell to specific target cells or vector geometries. For example, one might want to compute the distance to the nearest coast (see <a href="05-raster-vector.html#sec-distance-to-nearest-geometry" class="quarto-xref"><span>Section 5.6</span></a>). We might also want to consider topography, that means, we are not only interested in the pure distance but would like also to avoid the crossing of mountain ranges when going to the coast. To do so, we can weight the distance with elevation so that each additional altitudinal meter ‘prolongs’ the Euclidean distance (this is beyond the scope of the book). Visibility and viewshed computations also belong to the family of global operations (also beyond the scope of the book).</p>
</section>
<section id="map-algebra-counterparts-in-vector-processing" class="level3" data-number="3.3.7">
<h3 data-number="3.3.7" class="anchored" data-anchor-id="map-algebra-counterparts-in-vector-processing"><span class="header-section-number">3.3.7</span> Map algebra counterparts in vector processing</h3>
<p>Many map algebra operations have a counterpart in vector processing <span class="citation" data-cites="liu_essential_2009">(<a href="references.html#ref-liu_essential_2009" role="doc-biblioref">Liu and Mason 2009</a>)</span>. Computing a distance raster (global operation) while only considering a maximum distance (logical focal operation) is the equivalent of a vector buffer operation (<a href="04-geometry-operations.html#sec-buffers" class="quarto-xref"><span>Section 4.2.3</span></a>). Reclassifying raster data (either local or zonal function depending on the input) is equivalent to dissolving vector data (<a href="04-geometry-operations.html#sec-geometry-unions" class="quarto-xref"><span>Section 4.2.7</span></a>). Overlaying two rasters (local operation), where one contains ‘No Data’ values representing a mask, is similar to vector clipping (<a href="04-geometry-operations.html#sec-clipping" class="quarto-xref"><span>Section 4.2.5</span></a>). Quite similar to spatial clipping is intersecting two layers (<a href="#sec-spatial-subsetting-vector" class="quarto-xref"><span>Section 3.2.1</span></a>, <a href="#sec-joining-incongruent-layers" class="quarto-xref"><span>Section 3.2.6</span></a>). The difference is that these two layers (vector or raster) simply share an overlapping area. However, be careful with the wording. Sometimes the same words have slightly different meanings for raster and vector data models. While aggregating polygon geometries means dissolving boundaries, for raster data geometries it means increasing cell sizes and thereby reducing spatial resolution. Zonal operations dissolve the cells of one raster in accordance with the zones (categories) of another raster dataset using an aggregating function.</p>
</section>
<section id="sec-merging-rasters" class="level3" data-number="3.3.8">
<h3 data-number="3.3.8" class="anchored" data-anchor-id="sec-merging-rasters"><span class="header-section-number">3.3.8</span> Merging rasters</h3>
<p>Suppose we would like to compute the NDVI (see <a href="#sec-raster-local-operations" class="quarto-xref"><span>Section 3.3.3</span></a>), and additionally want to compute terrain attributes from elevation data for observations within a study area. Such computations rely on remotely sensed information. The corresponding source imagery is often divided into scenes covering a specific spatial extent (i.e., tiles), and frequently, a study area covers more than one scene. Then, we would need to merge (also known as mosaic) the scenes covering our study area. In case when all scenes are aligned (i.e., share the same origin and resolution), this can be thought of as simply gluing them into one big raster; otherwise, all scenes need to be resampled (see <a href="04-geometry-operations.html#sec-raster-resampling" class="quarto-xref"><span>Section 4.3.3</span></a>) to the same grid (e.g., the one defined by the first scene).</p>
<p>For example, let’s merge digital elevation data from two SRTM elevation tiles, for Austria (<code>'aut.tif'</code>) and Switzerland (<code>'ch.tif'</code>). Merging can be done using function <code>rasterio.merge.merge</code>, which accepts a <code>list</code> of raster file connections, and returns the new <code>ndarray</code> and the corresponding transform object, representing the resulting mosaic.</p>
<div id="4d30bbf8" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>src_1 <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'data/aut.tif'</span>)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>src_2 <span class="op">=</span> rasterio.<span class="bu">open</span>(<span class="st">'data/ch.tif'</span>)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>out_image, out_transform <span class="op">=</span> rasterio.merge.merge([src_1, src_2])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Some Python packages (such as <code>rasterio</code>) are split into several so-called sub-modules. The sub-modules are installed collectively when installing the main package. However, each sub-module needs to be loaded separately to be able to use its functions. For example, the <code>rasterio.merge.merge</code> function (see last code block) comes from the <code>rasterio.merge</code> sub-module of <code>rasterio</code>. Loading <code>rasterio</code> with <code>import rasterio</code> does not expose the <code>rasterio.merge.merge</code> function; instead, we have to load <code>rasterio.merge</code> with <code>import rasterio.merge</code>, and only then use <code>rasterio.merge.merge</code>.</p>
<p>Also check out the first code block in this chapter, where we load <code>rasterio</code> as well as three sub-modules: <code>rasterio.plot</code>, <code>rasterio.merge</code>, and <code>rasterio.features</code>.</p>
</div>
</div>
<p><a href="#fig-raster-merge" class="quarto-xref">Figure&nbsp;<span>3.23</span></a> shows both inputs and the resulting mosaic.</p>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(src_1)<span class="op">;</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(src_2)<span class="op">;</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>rasterio.plot.show(out_image, transform<span class="op">=</span>out_transform)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-raster-merge" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raster-merge-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-merge" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-merge-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-merge-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-merge-output-1.png" data-ref-parent="fig-raster-merge" width="417" height="183" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-merge-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>aut.tif</code>
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-merge" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-merge-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-merge-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-merge-output-2.png" data-ref-parent="fig-raster-merge" width="430" height="221" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-merge-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) <code>ch.tif</code>
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-raster-merge" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-raster-merge-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-raster-merge-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-spatial-operations_files/figure-html/fig-raster-merge-output-3.png" data-ref-parent="fig-raster-merge" width="417" height="155" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-raster-merge-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) Mosaic (<code>aut.tif</code>+<code>ch.tif</code>)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raster-merge-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.23: Raster merging
</figcaption>
</figure>
</div>
<p>By default in <code>rasterio.merge.merge</code>, areas of overlap retain the value of the <em>first</em> raster (<code>method='first'</code>). Other possible methods are:</p>
<ul>
<li><code>'last'</code>—Value of the last raster</li>
<li><code>'min'</code>—Minimum value</li>
<li><code>'max'</code>—Maximum value</li>
</ul>
<p>When dealing with non-overlapping tiles, such as <code>aut.tif</code> and <code>ch.tif</code> (above), the <code>method</code> argument has no practical effect. However, it becomes relevant when we want to combine spectral imagery from scenes that were taken on different dates. The above four options for <code>method</code> do not cover the commonly required scenario when we would like to compute the <em>mean</em> value—for example to calculate a seasonal average NDVI image from a set of partially overlapping satellite images (such as Landsat). An alternative workflow to <code>rasterio.merge.merge</code>, for calculating a mosaic as well as averaging any overlaps, is to go through two steps:</p>
<ul>
<li>Resampling all scenes into a common ‘global’ grid (<a href="04-geometry-operations.html#sec-raster-resampling" class="quarto-xref"><span>Section 4.3.3</span></a>), thereby producing a series of matching rasters (with the area surrounding each scene set as ‘No Data’)</li>
<li>Averaging the rasters through raster algebra (<a href="#sec-raster-local-operations" class="quarto-xref"><span>Section 3.3.3</span></a>), using <code>np.mean(m,axis=0)</code> or <code>np.nanmean(m,axis=0)</code> (depending whether we prefer to ignore ‘No Data’ or not), where <code>m</code> is the multi-band array, which would return a single-band array of averages</li>
</ul>
<!-- ## Exercises

-   Write a function which accepts and array and an `int` specifying the number of rows/columns to erase along an array edges. The function needs to return the modified array with `np.nan` values along its edges. -->


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-burrough_principles_2015" class="csl-entry" role="listitem">
Burrough, P. A., Rachael McDonnell, and Christopher D. Lloyd. 2015. <em>Principles of Geographical Information Systems</em>. Third. <span>Oxford, New York</span>: <span>Oxford University Press</span>.
</div>
<div id="ref-dieck_algebraic_2008" class="csl-entry" role="listitem">
Dieck, Tammo tom. 2008. <em>Algebraic Topology</em>. <span>EMS</span> Textbooks in Mathematics. <span>Zürich</span>: <span>European Mathematical Society</span>. <a href="https://www.maths.ed.ac.uk/~v1ranick/papers/diecktop.pdf">https://www.maths.ed.ac.uk/~v1ranick/papers/diecktop.pdf</a>.
</div>
<div id="ref-egenhofer_mathematical_1990" class="csl-entry" role="listitem">
Egenhofer, Max, and John Herring. 1990. <span>“A Mathematical Framework for the Definition of Topological Relations.”</span> In <em>Proc. The Fourth International Symposium on Spatial Data Handing</em>, 803–13.
</div>
<div id="ref-horn_1981" class="csl-entry" role="listitem">
Horn, B. K. P. 1981. <span>“Hill Shading and the Reflectance Map.”</span> <em>Proceedings of the IEEE</em> 69 (1): 14–47. <a href="https://doi.org/10.1109/PROC.1981.11918">https://doi.org/10.1109/PROC.1981.11918</a>.
</div>
<div id="ref-liu_essential_2009" class="csl-entry" role="listitem">
Liu, Jian-Guo, and Philippa J. Mason. 2009. <em>Essential Image Processing and <span>GIS</span> for Remote Sensing</em>. <span>Chichester, West Sussex, UK, Hoboken, NJ</span>: <span>Wiley-Blackwell</span>.
</div>
<div id="ref-lovelace_geocomputation_2019" class="csl-entry" role="listitem">
Lovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2019. <em>Geocomputation with <span>R</span></em>. <span>CRC Press</span>. <a href="http://robinlovelace.net/geocompr">http://robinlovelace.net/geocompr</a>.
</div>
<div id="ref-pebesma_spatial_2023" class="csl-entry" role="listitem">
Pebesma, Edzer, and Roger Bivand. 2023. <em>Spatial <span>Data Science</span>: <span>With Applications</span> in <span>R</span></em>. <span>CRC Press</span>. <a href="https://r-spatial.org/book/">https://r-spatial.org/book/</a>.
</div>
<div id="ref-qiu_development_2012" class="csl-entry" role="listitem">
Qiu, Fang, Caiyun Zhang, and Yuhong Zhou. 2012. <span>“The <span>Development</span> of an <span>Areal Interpolation ArcGIS Extension</span> and a <span>Comparative Study</span>.”</span> <em>GIScience &amp; Remote Sensing</em> 49 (5): 644–63. <a href="https://doi.org/gkb5fn">https://doi.org/gkb5fn</a>.
</div>
<div id="ref-spanier_algebraic_1995" class="csl-entry" role="listitem">
Spanier, Edwin Henry. 1995. <em>Algebraic Topology</em>. 1. corr. Springer ed. <span>New York Berlin Barcelona Budapest</span>: <span>Springer</span>.
</div>
<div id="ref-tobler_smooth_1979" class="csl-entry" role="listitem">
Tobler, Waldo R. 1979. <span>“Smooth <span>Pycnophylactic Interpolation</span> for <span>Geographical Regions</span>.”</span> <em>Journal of the American Statistical Association</em> 74 (367): 519–30. <a href="https://doi.org/ghz78f">https://doi.org/ghz78f</a>.
</div>
<div id="ref-tomlin_geographic_1990" class="csl-entry" role="listitem">
Tomlin, C. Dana. 1990. <em>Geographic Information Systems and Cartographic Modeling</em>. <span>Englewood Cliffs, N.J</span>: <span>Prentice Hall</span>.
</div>
<div id="ref-tomlin_map_1994" class="csl-entry" role="listitem">
———. 1994. <span>“Map Algebra: One Perspective.”</span> <em>Landscape and Urban Planning</em> 30 (1-2): 3–12. <a href="https://doi.org/dm2qm2">https://doi.org/dm2qm2</a>.
</div>
<div id="ref-scipy" class="csl-entry" role="listitem">
Virtanen, Pauli, Ralf Gommers, Travis E. Oliphant, Matt Haberland, Tyler Reddy, David Cournapeau, Evgeni Burovski, et al. 2020. <span>“<span class="nocase"><span>SciPy</span> 1.0: Fundamental Algorithms for Scientific Computing in Python</span>.”</span> <em>Nature Methods</em> 17: 261–72. <a href="https://doi.org/10.1038/s41592-019-0686-2">https://doi.org/10.1038/s41592-019-0686-2</a>.
</div>
<div id="ref-zevenbergen_1987" class="csl-entry" role="listitem">
Zevenbergen, Lyle W., and Colin R. Thorne. 1987. <span>“Quantitative Analysis of Land Surface Topography.”</span> <em>Earth Surface Processes and Landforms</em> 12 (1): 47–56. https://doi.org/<a href="https://doi.org/10.1002/esp.3290120107">https://doi.org/10.1002/esp.3290120107</a>.
</div>
</div>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p><a href="https://en.wikipedia.org/wiki/DE-9IM">https://en.wikipedia.org/wiki/DE-9IM</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><a href="https://en.wikipedia.org/wiki/Normalized_difference_vegetation_index">https://en.wikipedia.org/wiki/Normalized_difference_vegetation_index</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p><a href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-analyst/how-aspect-works.htm">https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-analyst/how-aspect-works.htm</a><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p><a href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-analyst/how-slope-works.htm">https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-analyst/how-slope-works.htm</a><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/py\.geocompx\.org");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./02-attribute-operations.html" class="pagination-link" aria-label="Attribute data operations">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Attribute data operations</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./04-geometry-operations.html" class="pagination-link" aria-label="Geometry operations">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geometry operations</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Geocomputation with Python was written by Michael Dorman, Anita Graser, Jakub Nowosad, and Robin Lovelace.</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/geocompx/geocompy/edit/main/03-spatial-operations.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>